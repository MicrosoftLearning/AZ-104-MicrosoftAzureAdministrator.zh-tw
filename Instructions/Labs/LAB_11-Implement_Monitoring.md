---
lab:
  title: 實驗室 11：實作監視
  module: Administer Monitoring
---

# 實驗 11 - 實作監視

## 實驗室簡介

在此實驗室中，您將了解 Azure 監視器。 您將了解如何建立警示，並將其傳送至動作群組。 您可以觸發和測試警示，並檢查活動記錄。  

此實驗室需要 Azure 訂用帳戶。 您的訂用帳戶類型可能會影響此實驗室中的功能可用性。 您可以變更區域，但這些步驟是使用**美國東部**撰寫而成。

## 預估時間：40 分鐘

## 實驗案例

您的組織已將其基礎結構移轉至 Azure。 系統管理員必須收到任何重大基礎結構變更的通知。 您計劃檢查 Azure 監視器的功能，包括 Log Analytics。

## 互動式實驗室模擬

您可能會發現互動式實驗室模擬對本主題很有用。 模擬可讓您以自己的步調點選類似的案例。 互動式模擬與此實驗室之間有所差異，但許多核心概念都相同。 不需要 Azure 訂閱。

+ [實作監視](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2017)。 建立 Log Analytics 工作區與 Azure 自動化解決方案。 檢閱虛擬機器的監視和診斷設定。 檢閱 Azure 監視器和 Log Analytics 功能。 

## 架構圖

![結構工作圖表](../media/az104-lab11-architecture.png)

## 作業技能

+ 工作 1：使用範本佈建基礎結構。
+ 工作 2：建立警示。
+ 工作 3：設定動作群組通知。
+ 工作 4：觸發警示並確認其正常運作。
+ 工作 5：建立警示處理規則。
+ 工作 6：使用 Azure 監視器記錄查詢。

## 工作 1：使用範本佈建基礎結構

在此工作中，您將部署虛擬機器以用於測試監視案例。

1. 將 **\\Allfiles\\Lab11\\az104-11-vm-template.json** 實驗室檔案下載到您的電腦。

1. 登入 **Azure 入口網站** - `https://portal.azure.com`。

1. 在 Azure 入口網站中搜尋並選取 [`Deploy a custom template`]。

1. 在 [自訂部署] 頁面上，選取 [在編輯器中建置您自己的範本]****。

1. 在 [編輯範本] 頁面上，選取 [載入檔案]****。

1. 找到並選取 **\\Allfiles\\Labs11\\az104-11-vm-template.json** 檔案，然後選取 [開啟]****。

1. 選取 [儲存]。

1. 使用下列資訊填寫 [自訂部署] 頁面上的欄位，所有其他欄位都保留預設值:

    | 設定       | 值         | 
    | ---           | ---           |
    | 訂用帳戶  | 您的 Azure 訂用帳戶 |
    | 資源群組| `az104-rg11` (如有必要，請選取 [新建]****)
    | 區域        | **美國東部**   |
    | 使用者名稱      | `localadmin`   |
    | 密碼      | 輸入複雜密碼 |
    
1. 選取 **[檢閱 + 建立]**,然後選取 **[建立]**。

1. 等候部署完成，然後按一下 [前往資源群組]****。

1. 檢閱已部署的資源。 資源中應該有一個虛擬網路與一部虛擬機器。

**設定虛擬機器的 Azure 監視器 (這將會用於上一個工作)**

1. 在入口網站中，搜尋並選取 [監視器]****。

1. 花一分鐘的時間檢閱所有可用的見解、偵測、分級和診斷工具。

1. 在 [VM 見解]**** 方塊中選取 [檢視]****，然後選取 [設定 Insights]****。

1. 選取您的虛擬機器，然後選取 [啟用]**** (兩次)。

1. 採用訂用帳戶和資料收集規則的預設值，然後選取 [設定]****。 

1. 虛擬機器代理程式需要幾分鐘的時間才能完成安裝和設定，請繼續進行下一個步驟。 
   
## 工作 2：建立警示

在這項工作中，您會建立刪除虛擬機器時的警示。 

1. 在 [監視器]**** 頁面上，選取 [警示]****。 

1. 依序選取 [Create +]**** 和 [警示規則]****。 

1. 選取資源群組的方塊，然後選取 [套用]****。 此警示會套用至資源群組中的任何虛擬機器。 或者，您可以只指定一部特定的機器。 

1. 選取 [條件]**** 索引標籤，然後選取 [See all signals]**** 連結。

1. 搜尋並選取 [Delete Virtual Machine (Virtual Machines)]****。 請留意其他內建訊號。 選取 [套用]

1. 在 [警示邏輯]**** 區域中 (向下卷動)，檢閱 [事件層級]**** 選取項目。 保留 [已全部選取]**** 的預設值。

1. 檢閱 [狀態]**** 選取項目。 保留 [已全部選取]**** 的預設值。

1. 將 [建立警示規則]**** 窗格保持開啟，以在下一項工作中使用。

## 工作 3：設定動作群組通知

在這項工作中，如果觸發警示，請傳送電子郵件通知給作業小組。 

1. 繼續處理警示。 選取 [下一步：**動作]**，然後選取 [建立動作群組]****。

    >**您知道嗎?** 您可以將最多五個動作群組新增至警示規則。 動作群組會同時執行 (沒有特定順序)。 多個警示規則可以使用相同的動作群組。 

1. 在 [基本]**** 索引標籤上，為每個設定輸入下列值。

    | 設定 | 值 |
    |---------|---------|
    | **專案詳細資料** |
    | 訂用帳戶 | 您的訂用帳戶 |
    | 資源群組 | **az104-rg11** |
    | 區域 | **全域** (預設值) |
    | [執行個體詳細資料]**** |
    | 動作群組名稱 | `Alert the operations team` (在資源群組中必須是唯一的) |
    | Display name | `AlertOpsTeam` |

1. 選取 [下一步：** 通知]**，然後為每個設定輸入下列值。

    | 設定 | 值 |
    |---------|---------|
    | 通知類型 | 選取 [電子郵件/簡訊/推播/語音]**** |
    | 名稱 | `VM was deleted` |

1. 選取 [電子郵件]****，然後在 [電子郵件]**** 方塊中輸入您的電子郵件地址，然後選取 [確定]****。 

    >**注意：** 您應該會收到電子郵件通知，指出已將您新增至動作群組。 其中可能會有幾分鐘的延遲，但這可讓您確定規則已部署完畢。

1. 建立動作群組之後，移至 [下一步: 詳細資料]**** 索引標籤，然後為每個設定輸入下列值。

    | 設定 | 值 |
    |---------|---------|
    | 警示規則名稱 | `VM was deleted` |
    | 警示規則描述 | `A VM in your resource group was deleted` |

1. 選取 [檢閱 + 建立]**** 來驗證您的輸入，然後選取 [建立]****。

## 工作 4：觸發警示並確認其正常運作

在這項工作中，您會觸發警示，並確認已傳送通知。 

>**注意：** 如果您在部署警示規則之前刪除虛擬機器，那麼可能不會觸發警示規則。 

1. 在入口網站中，搜尋並選取 [虛擬機器]****。

1. 核取 **az104-vm0** 虛擬機器的方塊。

1. 從功能表列中選取 [刪除]****。

1. 核取 [套用強制刪除]**** 的方塊。 核取底部的方塊，確認您想要刪除資源，然後選取 [ **刪除**]。 

1. 在標題列中選取**通知**圖示，並等候系統成功刪除 **vm0**。

1. 您應該會收到具有下列內容的通知電子郵件:「**重要通知:Azure 監視器警示 VM 已刪除已啟動...** 如果沒有收到，請開啟您的電子郵件程式，然後從尋找寄件者為 azure-noreply@microsoft.com 的電子郵件。

    ![警示電子郵件的螢幕擷取畫面。](../media/az104-lab11-alert-email.png)
   
1. 在 Azure 入口網站資源功能表上，選取 **[監視]**，然後選取左側功能表中的 **[警示]**。

1. 您應該會有因刪除 **vm0** 而產生的三個詳細資訊警示。

   >**注意：** 系統可能需要幾分鐘的時間才會傳送警示電子郵件，並在入口網站中更新警示。 如果您不想等候，請繼續下一個工作，並在稍後回來查看。 

1. 選取其中一個警示的名稱 (例如，[VM 已刪除]****)。 [警示詳細資料]**** 窗格隨即出現，顯示關於事件的詳細資料。

## 工作 5：設定警示處理規則

在這項工作中，您會建立警示規則，以在維護期間隱藏通知。 

1. 繼續前往 [警示]**** 刀鋒視窗，選取 [警示處理規則]****，然後選取 [+ Create]****。 
   
1. 選取 [資源群組]****，然後選取 [套用]****。
   
1. 選取 **[下一步: 規則設定]**，選取 **[隱藏通知]**。
   
1. 選取 [下一步：排程]****。
   
1. 根據預設，除非停用規則或設定排程，否則規則會持續運作。 您將會定義規則，以在隔夜維護期間隱藏通知。
針對警示處理規則的排程輸入這些設定：

    | 設定 | 值 |
    |---------|---------|
    | 套用規則 | 在特定時間 |
    | 啟動 | 在下午 10 點輸入今天的日期。 |
    | 尾端 | 在上午 7 點輸入明天的日期。 |
    | Time zone | 選取當地時區。 |

    ![警示處理規則的排程區段螢幕擷取畫面](../media/az104-lab11-alert-processing-rule-schedule.png)

1. 選取 **[下一步: 詳細資料]**，然後輸入下列設定:

    | 設定 | 值 |
    |---------|---------|
    | 資源群組 | **az104-rg11** |
    | 規則名稱 | `Planned Maintenance` |
    | 描述 | `Suppress notifications during planned maintenance.` |

1. 選取 [檢閱 + 建立]**** 來驗證您的輸入，然後選取 [建立]****。

## 工作 6：使用 Azure 監視器記錄查詢

在這項工作中，您將使用 Azure 監視器來查詢從虛擬機器擷取的資料。

1. 在 Azure 入口網站中，搜尋並選取 [`Monitor`] 刀鋒視窗，然後按一下 [記錄]****。

1. 如有必要，請關閉啟動顯示畫面。 

1. 選取 [範圍] 和您的**資源群組**。 選取**套用**。 

1. 在 [查詢]**** 索引標籤中，選取 [虛擬機器]**** (左側窗格)。 

1. 檢閱可用的查詢。 **執行** (將滑鼠停留在查詢上) **計數活動訊號**查詢。

1. 您應該會在虛擬機器執行時收到活動訊號計數。

1. 檢閱查詢。 此查詢會使用 [活動訊號]** 資料表。 

1. 使用此查詢取代查詢，然後按一下 [執行]****。 檢視產生的圖表。 

   ```
    InsightsMetrics
    | where TimeGenerated > ago(1h)
    | where Name == "UtilizationPercentage"
    | summarize avg(Val) by bin(TimeGenerated, 5m), Computer //split up by computer
    | render timechart
   ```

1. 當您有時間時，請檢閱並執行其他查詢。 

    >**您知道嗎?**:如果要練習其他查詢，您可以使用 [Log Analytics 示範環境](https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-tutorial#open-log-analytics)。
    
    >**您知道嗎?**:找到您想要的查詢之後，即可從中建立警示。 

## 清除您的資源

如果您使用**自己的訂用帳戶**，請花點時間刪除實驗室資源。 如此可確保釋出資源，並將成本降到最低。 刪除實驗室資源的最簡單方式是刪除實驗室資源群組。 

+ 在 Azure 入口網站中，選取資源群組，選取 [刪除資源群組]****，[輸入資源群組名稱]****，然後按一下 [刪除]****。
+ 使用 Azure PowerShell `Remove-AzResourceGroup -Name resourceGroupName`。
+ 使用 CLI `az group delete --name resourceGroupName`。

## 利用 Copilot 延伸學習
Copilot 可協助您了解如何使用 Azure 指令碼工具。 Copilot 也可在實驗室中未涵蓋的區域或您需要更多資訊的地方提供協助。 開啟 Edge 瀏覽器，然後選擇 [Copilot] (右上方)，或瀏覽至 *copilot.microsoft.com*。 請花幾分鐘的時間嘗試下列提示。

+ 當虛擬機器故障時，要在 Azure 中獲得警示的基本設定步驟有哪些?
+ 如何在觸發 Azure 警示時收到通知?
+ 建構 Azure 監視器查詢以提供虛擬機器 CPU 效能資訊。

## 透過自學型訓練深入了解

+ [使用 Azure 監視器警示改善事件回應](https://learn.microsoft.com/en-us/training/modules/incident-response-with-alerting-on-azure/)。 透過 Azure 監視器中的警示功能，回應基礎結構中的事件和活動。
+ [使用 Azure 監視器來監視您的 Azure 虛擬機器](https://learn.microsoft.com/en-us/training/modules/monitor-azure-vm-using-diagnostic-data/)。 使用 Azure 監視器來收集和分析 VM 主機和用戶端計量與記錄，以監視您的 Azure VM。

## 重要心得

恭喜您完成此實驗室。 以下是此實驗室的主要重點。 

+ 警示可協助您在使用者注意到基礎結構或應用程式發生問題之前，偵測並解決問題。
+ 您可以針對在 Azure 監視器資料平台中的任何計量或記錄資料來源發出警示。
+ 警示規則會監視您的資料，並擷取訊號，訊號指出在指定資源上有情況發生。
+ 如果符合警示規則的條件，就會觸發警示。 您可以觸發數個動作 (電子郵件、簡訊、推送、語音)。
+ 動作群組包含應收到警示通知的個人。
