---
lab:
  title: 實驗室 05：實作站台間連線能力
  module: Administer Intersite Connectivity
---

# 實驗 05 - 實作站台間連線能力

## 實驗室簡介

在此實驗室中，您將探索虛擬網路之間的通訊。 您將實作虛擬網路對等互連和測試連線。 您也將建立自訂路由。 

此實驗室需要 Azure 訂用帳戶。 您的訂用帳戶類型可能會影響此實驗室中的功能可用性。 您可以變更區域，但這些步驟是使用**美國東部**撰寫而成。 

## 預估時間：50 分鐘
    
## 實驗案例 

您的組織會將核心 IT 應用程式和服務 (例如 DNS 和安全性服務) 與其他業務部分區隔，包含您的製造部門。 不過，在某些案例中，核心區域的應用程式和服務必須與製造區域的應用程式和服務通訊。 在此實驗室中，您將設定區隔區域之間的連線。 這是分隔生產與開發或分隔一個子公司與另一個子公司的常見案例。  

## 互動式實驗室模擬

您可能會發現幾個互動式實驗室模擬對本主題很有用。 模擬可讓您以自己的步調點選類似的案例。 互動式模擬與此實驗室之間有所差異，但許多核心概念都相同。 不需要 Azure 訂用帳戶。 

+ [使用全域虛擬網路對等互連來連線兩個 Azure 虛擬網路](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Connect%20two%20Azure%20virtual%20networks%20using%20global%20virtual%20network%20peering)。 測試不同虛擬網路中兩個虛擬機器之間的連線。 建立虛擬網路對等互連並重新測試。

+ [設定對虛擬網路的監視](https://learn.microsoft.com/training/modules/configure-monitoring-virtual-networks/)。 了解如何使用 Azure 網路監看員連線監視器、流量記錄、NSG 診斷和封包擷取來監視 Azure IaaS 網路資源的連線。

+ [實作站台間連線能力](https://mslabs.cloudguides.com/en-us/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%209)。 虛擬網路本以使用多個虛擬機器建立虛擬網路基礎結構。 設定虛擬網路對等互連並測試連線。 

## 架構圖

![實驗室 05 架構圖表](../media/az104-lab05-architecture.png)

## 作業技能

+ 工作 1：在虛擬網路中建立虛擬機器。
+ 工作 2：在不同虛擬網路中建立虛擬機器。
+ 工作 3：使用網路監看員以測試虛擬機器之間的連線。 
+ 工作 4：設定不同虛擬網路之間的虛擬網路對等互連。
+ 工作 5：使用 Azure PowerShell 以測試虛擬機器之間的連線。
+ 工作 6：建立自訂路由。 

## 工作 1：建立核心服務虛擬機器和虛擬網路

在此工作中，您將使用虛擬機器建立核心服務虛擬網路。 

1. 登入 **Azure 入口網站** - `https://portal.azure.com`。

1. 搜尋並選取 `Virtual Machines`。

1. 從虛擬機器頁面，選取 [建立]****，然後選取 [Azure 虛擬機器]****。

1. 在 [基本] 索引標籤上，使用下列資訊完成表單，然後選取 **[下一步：磁碟 >]**。 如果未指定設定，則請保留預設值。
 
    | 設定 | 值 | 
    | --- | --- |
    | 訂用帳戶 |  *您的訂用帳戶* |
    | 資源群組 |  `az104-rg5` (如有必要，請建立新的資源群組****。 )
    | 虛擬機器名稱 |    `CoreServicesVM` |
    | 區域 | **(美國) 美國東部** |
    | 可用性選項 | 不需要基礎結構備援 |
    | 安全性類型 | **標準** |
    | 映像 | **Windows Server 2019 Datacenter：x64 Gen2** (請注意其他選擇) |
    | 大小 | **Standard_DS2_v3** |
    | 使用者名稱 | `localadmin` | 
    | 密碼 | **提供複雜密碼** |
    | 公用輸入連接埠 | **None** |

    ![基本虛擬機器建立頁面的螢幕擷取畫面。 ](../media/az104-lab05-createcorevm.png)
   
1. 在 [磁碟]**** 索引標籤上，取得預設值，然後選取 **[下一步：網路 >]**。

1. 在 [網路]**** 索引標籤上，針對 [虛擬網路]，選取 [新建]****。

1. 使用下列資訊來設定虛擬網路，然後選取 [確定]****。 如有必要，請移除或取代現有資訊。

    | 設定 | 值 | 
    | --- | --- |
    | 名稱 | `CoreServicesVnet` (新建) |
    | 位址範圍 | `10.0.0.0/16`  |
    | 子網路名稱 | `Core` | 
    | 子網路位址範圍 | `10.0.0.0/24` |

1. 選取 [監控]**** 索引標籤。針對 [開機診斷]，選取 [停用]****。

1. 選取 [檢閱 + 建立]，然後選取 [建立]。

1. 您不需要等候資源建立。 繼續進行下一個工作。

    >**注意：** 您是否注意到在此工作中您在建立虛擬機器時也建立虛擬網路？ 您也可以建立虛擬機器基礎結構，然後新增虛擬機器。 

## 工作 2：在不同虛擬網路中建立虛擬機器

在此工作中，您將使用虛擬機器建立製造服務虛擬網路。 

1. 從 Azure 入口網站搜尋並瀏覽至 [虛擬機器]****。

1. 從虛擬機器頁面，選取 [建立]****，然後選取 [Azure 虛擬機器]****。

1. 在 [基本] 索引標籤上，使用下列資訊完成表單，然後選取 **[下一步：磁碟 >]**。 如果未指定設定，則請保留預設值。
 
    | 設定 | 值 | 
    | --- | --- |
    | 訂用帳戶 |  *您的訂用帳戶* |
    | 資源群組 |  `az104-rg5` |
    | 虛擬機器名稱 |    `ManufacturingVM` |
    | 區域 | **(美國) 美國東部** |
    | 安全性類型 | **標準** |
    | 可用性選項 | 不需要基礎結構備援 |
    | 映像 | **Windows Server 2019 Datacenter：x64 Gen2** |
    | 大小 | **Standard_DS2_v3** | 
    | 使用者名稱 | `localadmin` | 
    | 密碼 | **提供複雜密碼** |
    | 公用輸入連接埠 | **None** |

1. 在 [磁碟]**** 索引標籤上，取得預設值，然後選取 **[下一步：網路 >]**。

1. 在 [網路] 索引標籤上，針對 [虛擬網路]，選取 [新建]****。

1. 使用下列資訊來設定虛擬網路，然後選取 [確定]****。  如有必要，請移除或取代現有的位址範圍。

    | 設定 | 值 | 
    | --- | --- |
    | 名稱 | `ManufacturingVnet` |
    | 位址範圍 | `172.16.0.0/16`  |
    | 子網路名稱 | `Manufacturing` |
    | 子網路位址範圍 | `172.16.0.0/24` |

1. 選取 [監控]**** 索引標籤。針對 [開機診斷]，選取 [停用]****。

1. 選取 [檢閱 + 建立]，然後選取 [建立]。

## 工作 3：使用網路監看員以測試虛擬機器之間的連線 


在此工作中，您將驗證對等互連虛擬網路中的資源是否可相互通訊。 網路監看員將用於測試連線。 繼續之前，請先確保已部署並執行虛擬機器。 

1. 在 Azure 入口網站中搜尋並選取 `Network Watcher`。

1. 從 [網路監看員] 的 [網路診斷工具] 功能表中，選取 [連線疑難排解]****。

1. 使用下列資訊完成 [連線疑難排解]**** 頁面上的欄位。

    | 欄位 | 值 | 
    | --- | --- |
    | 來源類型           | **虛擬機器**   |
    | 虛擬機器       | **CoreServicesVM**    | 
    | 目的地類型      | **虛擬機器**   |
    | 虛擬機器       | **ManufacturingVM**   | 
    | 慣用的 IP 版本  | **兩者**              | 
    | 通訊協定              | **TCP**               |
    | 目的地連接埠      | `3389`                |  
    | 來源連接埠           | *Blank*         |
    | 診斷測試      | *Defaults*      |

    ![顯示 [連線疑難排解] 設定的 Azure 入口網站。](../media/az104-lab05-connection-troubleshoot.png)

1. 選取 [執行診斷測試]****。

    >**注意**：這可能需要幾分鐘的時間才會傳回結果。 收集結果時，畫面選取項目會呈現灰色。 請注意，[連線測試]**** 顯示 [無法連線]****。 由於虛擬機器位於不同的虛擬網路，因此這是正常情況。 

 
## 工作 4：設定虛擬網路之間的虛擬網路對等互連

在此工作中，您將建立虛擬網路對等互連以啟用虛擬網路中資源之間的通訊。 

1. 在 Azure 入口網站中，選取 `CoreServicesVnet` 虛擬網路。

1. 在 CoreServicesVnet 的 [設定]**** 底下，選取 [對等互連]****。

1. 在 [CoreServicesVnet | 對等互連] 上，選取 [+ 新增]****。 如果未指定，請採用預設值。 

| **參數**                                    | **ReplTest1**                             |
| --------------------------------------------- | ------------------------------------- |                                
| 對等互連連結名稱                             | `CoreServicesVnet-to-ManufacturingVnet` |
| 虛擬網路    | **ManufacturingVM-net （az104-rg5）**  |
| 允許 ManufacturingVnet 存取 CoreServicesVnet  | 已選取 (預設)                       |
| 允許 ManufacturingVnet 接收來自 CoreServicesVnet 的轉送流量 | 已選取                        |
| 對等互連連結名稱                             | `ManufacturingVnet-to-CoreServicesVnet` |
| 允許 CoreServicesVnet 存取對等互連虛擬網路            | 已選取 (預設)                       |
| 允許 CoreServicesVnet 接收來自對等互連虛擬網路的轉送流量 | 已選取                       |

1. 按一下**新增**。

1. 在 [CoreServicesVnet | 對等互連] 上，確認已列出 [CoreServicesVnet-to-ManufacturingVnet]**** 對等互連。 重新整理頁面以確保 [對等互連狀態]**** 為 [已連線]****。

1. 切換至 [ManufacturingVnet]****，並確認已列出 [ManufacturingVnet-to-CoreServicesVnet]**** 對等互連。 請確保 [對等互連狀態]**** 為 [已連線]****。 您可能需要**重新整理**頁面。 

## 工作 5：使用 Azure PowerShell 以測試虛擬機器之間的連線

在此工作中，您將重新測試不同虛擬網路中虛擬機器之間的連線。 

### 確認 CoreServicesVM 的私人 IP 位址

1. 從 Azure 入口網站，搜尋並選取 `CoreServicesVM` 虛擬機器。

1. 在 [概觀]**** 刀鋒視窗的 [網路]**** 區段中，記錄機器的 [私人 IP 位址]****。 您需要此資訊以測試連線。
   
### 從 **ManufacturingVM** 測試 CoreServicesVM 的連線。

>**您知道嗎？** 檢查連線有許多方式。 在此工作中，您將使用 [執行命令]****。 您也可以繼續使用網路監看員。 或者，您也可以使用遠端桌面連線[](https://learn.microsoft.com/azure/virtual-machines/windows/connect-rdp#connect-to-the-virtual-machine)以存取虛擬機器。 連線後，使用 **test-connection**。 若您有時間，請試試看 RDP。 

1. 切換至 `ManufacturingVM` 虛擬機器。

1. 在 [作業] 刀鋒視窗中，選取 [執行命令]**** 刀鋒視窗。

1. 選取 [RunPowerShellScript]**** 並執行 **Test-NetConnection** 命令。 請務必確認 **CoreServicesVM** 的私人 IP 位址。

    ```Powershell
    Test-NetConnection <CoreServicesVM private IP address> -port 3389
    ```
1. 指令碼可能需要幾分鐘的時間才會逾時。頁面頂端顯示參考訊息「指令碼執行進行中」**。

   
1. 測試連線應成功，因為已設定對等互連。 此圖表中的電腦名稱和遠端位址可能不同。 
   
   ![PowerShell 視窗，Test-NetConnection 已成功。](../media/az104-lab05-success.png)

## 工作 6：建立自訂路由 

在此工作中，您想要控制周邊子網路和內部核心服務子網路之間的網路流量。 虛擬網路設備將安裝在核心網路子網路中，且所有流量應將路由傳送至此處。 

1. 搜尋並選取 `CoreServicesVnet`。

1. 選取 [子網 **]，然後選取 ****[+ 子網**]。 請務必選取 [ **新增** ] 以儲存變更。 

    | 設定 | 值 | 
    | --- | --- |
    | 名稱 | `perimeter` |
    | 子網路位址範圍 | `10.0.1.0/24`  |

   
1. 在 Azure 入口網站中，搜尋並選取 `Route tables`，然後選取 [建立]****。 

    | 設定 | 值 | 
    | --- | --- |
    | 訂用帳戶 | 您的訂用帳戶 |
    | 資源群組 | `az104-rg5`  |
    | 區域 | **美國東部** |
    | 名稱 | `rt-CoreServices` |
    | 散佈閘道路由 | **否** |

1. 部署路由表之後，搜尋並選取 **[路由表**]。
   
1. 選取資源 （而非複選框） **rt-CoreServices**

1. 展開 **[設定**]，然後選取 [路由 **]，然後選取 **[**+ 新增**]。 建立從未來網路虛擬設備 （NVA） 到 CoreServices 虛擬網路的路由。 

    | 設定 | 值 | 
    | --- | --- |
    | 路由名稱 | `PerimetertoCore` |
    | 目的地類型 | **IP 位址** |
    | 目的地 IP 位址 | `10.0.0.0/16` (核心服務虛擬網路) |
    | 下一個躍點類型 | **虛擬設備** (請注意其他選擇) |
    | 下一個躍點位址 | `10.0.1.7` (未來 NVA) |

1. 選取 [**+ 新增**]。 最後要做的是將路由與子網路建立關聯。

1. 選取 [子網 **]，然後選取 **[**+ 關聯**]。 完成組態。

    | 設定 | 值 | 
    | --- | --- |
    | 虛擬網路 | **CoreServicesVnet** |
    | 子網路 | **核心** |    

>**注意**：您已建立使用者定義的路由，以將流量從 DMZ 導向至新的 NVA。  

## 清除您的資源

如果您使用**自己的訂用帳戶**，請花點時間刪除實驗室資源。 如此可確保釋出資源，並將成本降到最低。 刪除實驗室資源的最簡單方式是刪除實驗室資源群組。 

+ 在 Azure 入口網站中，選取資源群組，選取 [刪除資源群組]****，[輸入資源群組名稱]****，然後按一下 [刪除]****。
+ 使用 Azure PowerShell `Remove-AzResourceGroup -Name resourceGroupName`。
+ 使用 CLI `az group delete --name resourceGroupName`。

## 利用 Copilot 延伸學習
Copilot 可協助您了解如何使用 Azure 指令碼工具。 Copilot 也可在實驗室中未涵蓋的區域或您需要更多資訊的地方提供協助。 開啟 Edge 瀏覽器，然後選擇 [Copilot] (右上方)，或瀏覽至 *copilot.microsoft.com*。 請花幾分鐘的時間嘗試下列提示。

+ 如何使用 Azure PowerShell 或 Azure CLI 命令以在 vnet1 和 vnet2 之間新增虛擬網路對等互連？
+ 建立資料表，醒目提示 Azure 支援的各種 Azure 和第三方監視工具。 醒目提示使用每個工具的時機。 
+ 在 Azure 中建立自訂網路路由的時間為何？

## 透過自學型訓練深入了解

+ [使用虛擬網路對等互連，將您的服務散發到 Azure 虛擬網路並進行整合](https://learn.microsoft.com/en-us/training/modules/integrate-vnets-with-vnet-peering/)。 使用虛擬網路對等互連，以安全且最不複雜的方式在虛擬網路之間進行通訊。
+ [使用路由來管理並控制 Azure 部署中的流量](https://learn.microsoft.com/training/modules/control-network-traffic-flow-with-routes/)。 了解如何藉由執行自訂路由來控制 Azure 虛擬網路流量。


## 重要心得

恭喜您完成此實驗室。 以下是此實驗室的主要重點。 

+ 依預設，不同虛擬網路中的資源無法通訊。
+ 虛擬網路對等互連可讓您順暢地連線 Azure 中的兩個或更多虛擬網路。
+ 基於連線目的，對等互連虛擬網路會顯示為一個。
+ 對等互連虛擬網路中虛擬機器之間的流量會使用 Microsoft 骨幹基礎結構。
+ 虛擬網路中的每個子網路會自動建立系統定義的路由。 使用者定義的路由會覆寫或新增至預設系統路由。 
+ Azure 網路監看員提供一套工具來監視、診斷，以及檢視 Azure IaaS 資源的計量和記錄。
