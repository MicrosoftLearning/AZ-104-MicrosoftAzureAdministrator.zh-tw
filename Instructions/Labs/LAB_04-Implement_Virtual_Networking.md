---
lab:
  title: 04 - 實作虛擬網路
  module: Module 04 - Virtual Networking
ms.openlocfilehash: 383f88f2dddb48d498efb3d868330e4bba15c92b
ms.sourcegitcommit: be14e4ff5bc638e8aee13ec4b8be29525d404028
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/11/2022
ms.locfileid: "145198120"
---
# <a name="lab-04---implement-virtual-networking"></a>實驗 04 - 實作虛擬網路

# <a name="student-lab-manual"></a>學生實驗手冊

## <a name="lab-scenario"></a>實驗案例

您需要探索 Azure 虛擬網路功能。 首先，您規劃在 Azure 中建立將裝載數部 Azure 虛擬機器的虛擬網路。 由於您想要實作以網路為基礎的分割，因此需要會將分割部署到虛擬網路的不同子網路。 您也想要確保其私人和公用 IP 位址將不會隨著時間變更。 若要符合 Contoso 安全性需求，您必須保護可從網際網路存取的 Azure 虛擬機器公用端點。 最後，您必須在虛擬網路和網際網路內實作 Azure 虛擬機器的 DNS 名稱解析。

## <a name="objectives"></a>目標

在此實驗中，您將會：

+ 工作 1：建立和設定虛擬網路
+ 工作 2：將虛擬機器部署至虛擬網路之中
+ 工作 3：為 Azure VM 設定私人和公用 IP 位址
+ 工作 4：設定網路安全性群組
+ 工作 5：設定 Azure DNS 以進行內部名稱解析
+ 工作 6：設定 Azure DNS 以進行外部名稱解析

## <a name="estimated-timing-40-minutes"></a>預估時間：40 分鐘

## <a name="architecture-diagram"></a>架構圖

![image](../media/lab04.png)

## <a name="instructions"></a>指示

### <a name="exercise-1"></a>練習 1

#### <a name="task-1-create-and-configure-a-virtual-network"></a>工作 1：建立和設定虛擬網路

在這項工作中，您將使用 Azure 入口網站建立具有多個子網路的虛擬網路

1. 登入 [Azure 入口網站](https://portal.azure.com)。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬網路]，然後在 [虛擬網路] 刀鋒視窗上，按一下 [+ 建立]。

1. 使用下列設定建立虛擬網路 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂閱名稱 |
    | 資源群組 | **新** 資源群組 **az104-04-rg1** 的名稱 |
    | 名稱 | **az104-04-vnet1** |
    | 區域 | 您將在此實驗室中使用的訂用帳戶中，可用的任何 Azure 區域名稱 |

1. 按一下 [下一步:IP 位址]，然後輸入下列值

    | 設定 | 值 |
    | --- | --- |
    | IPv4 位址空間 | **10.40.0.0/20** |

1. 按一下 [+ 新增子網路] 輸入下列值，然後按一下 [新增]

    | 設定 | 值 |
    | --- | --- |
    | 子網路名稱 | **subnet0** |
    | 子網路位址範圍 | **10.40.0.0/24** |

1. 接受預設值，然後按一下 [檢閱及建立]。 隨即出現驗證，接著再按一下 [建立] 提交您的部署。

    >**注意：** 等候虛擬網路佈建。 此作業所需的時間應該不到一分鐘。

1. 按一下 [前往資源]

1. 在 **az104-04-vnet1** 虛擬網路刀鋒視窗上，按一下 [子網路]，然後按一下 [+ 子網路]。

1. 使用下列設定建立子網路 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **subnet1** |
    | 位址範圍 (CIDR 區塊) | **10.40.1.0/24** |
    | 網路安全性群組 | **無** |
    | 路由表 | **無** |

1. 按一下 [儲存] 

#### <a name="task-2-deploy-virtual-machines-into-the-virtual-network"></a>工作 2：將虛擬機器部署至虛擬網路之中

在這項工作中，您會使用 ARM 範本將 Azure 虛擬機器部署到虛擬網路的不同子網路中

1. 在 Azure 入口網站中，按一下 Azure 入口網站右上角的圖示以開啟 **Azure Cloud Shell**。

1. 當系統提示您選取 [Bash] 或 [PowerShell] 時，請選取 [PowerShell]。

    >**注意**：如果這是您第一次啟動 **Cloud Shell**，而且出現 **您未掛接任何儲存體** 訊息，請選取您在此實驗中使用的訂用帳戶，並按一下 [建立儲存體]。

1. 在 [Cloud Shell] 窗格的工具列中，按一下 [上傳/下載檔案] 圖示，在下拉式功能表中，按一下 [上傳]，並將檔案 **\\Allfiles\\Labs\\04\\az104-04-vms-loop-template.json** 和 **\\Allfiles\\Labs\\04\\az104-04-vms-loop-parameters.json** 上傳至 Cloud Shell 主目錄。

    >**注意**：您可能需要將每個檔案個別上傳。

1. 編輯參數檔案，並變更密碼。 如果您需要在 Shell 中編輯檔案的協助，請向講師尋求協助。 最佳做法便是秘密 (例如密碼)，這應會在 Key Vault 中儲存時提供更佳的安全性。 

1. 從 Cloud Shell 窗格中，執行下列命令以使用範本和參數檔案來部署兩部虛擬機器：

   ```powershell
   $rgName = 'az104-04-rg1'

   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-04-vms-loop-template.json `
      -TemplateParameterFile $HOME/az104-04-vms-loop-parameters.json
   ```

    >**注意**：這個部署 ARM 範本的方法會使用 Azure PowerShell。 您可以執行相等的 Azure CLI 命令 **az deployment create** 來執行相同的工作，如需詳細資訊，請參閱[使用 Resource Manager 範本和 Azure CLI 部署資源](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deploy-cli)。

    >**注意**：等候部署完成，再繼續進行下一個工作。 這應該大約需要 2 分鐘的時間。

    >**注意**：如果您收到指出 VM 大小無法使用的錯誤，請向講師尋求協助，並嘗試下列步驟：
    > 1. 按一下 CloudShell 中的 `{}` 按鈕，從左側側邊列選取 [az104-04-vms-loop-parameters.json]，並記下 `vmSize` 參數值。
    > 1. 檢查部署 'az104-04-rg1' 資源群組的位置。 您可以在 CloudShell 中執行 `az group show -n az104-04-rg1 --query location` 以取得位置。
    > 1. 在 CloudShell 中執行 `az vm list-skus --location <Replace with your location> -o table --query "[? contains(name,'Standard_D2s')].name"`。 如果沒有列出的 SKU (即沒有結果)，則您無法在該區域中部署任何 D2S 虛擬機器。 您必須找到可部署 D2S 虛擬機器的區域。 選擇適當的位置之後，請刪除 AZ104-04-rg1 資源群組，然後重新啟動實驗室。
    > 1. 將 `vmSize` 參數的值取代為您剛才執行命令所傳回的其中一個值。
    > 1. 現在再次執行 `New-AzResourceGroupDeployment` 命令來重新部署範本。 您可以按幾次向上按鈕，藉此顯示次執行的命令。

1. 關閉 [Cloud Shell] 窗格。

#### <a name="task-3-configure-private-and-public-ip-addresses-of-azure-vms"></a>工作 3：為 Azure VM 設定私人和公用 IP 位址

在這項工作中，您將針對指派給 Azure 虛擬機器網路介面的公用和私人 IP 位址設定靜態指派。

   >**注意**：私人和公用 IP 位址實際上會指派給網路介面，接著連結至 Azure 虛擬機器，不過，通常是指涉指派給 Azure VM 的 IP 位址。

1. 在Azure 入口網站中，搜尋並選取 [資源群組]，然後在 [資源群組] 刀鋒視窗中按一下 [az104-04-rg1]。

1. 在 [az104-04-rg1] 資源群組刀鋒視窗中，按一下資源清單中的 [az104-04-vnet1]。

1. 在 [az104-04-vnet1] 虛擬網路刀鋒視窗上，檢閱 [已連線的裝置] 區段，並確認 **az104-04-nic0** 和 **az104-04-nic1** 這兩個網路介面已連結至虛擬網路。

1. 按一下 **az104-04-nic0**，然後在 [az104-04-nic0] 刀鋒視窗上，按一下 [IP 設定]。

    >**注意**：請確認 **ipconfig1** 目前已設定為動態私人 IP 位址。

1. 在 IP 設定清單中，按一下 [ipconfig1]。

1. 在 [ipconfig1] 刀鋒視窗的 [公用 IP 位址設定] 區段中，選取 [關聯]，按一下 [+ 新建]，指定下列設定，然後按一下 [確定]：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-04-pip0** |
    | SKU | **標準** |

1. 在 [ipconfig1] 刀鋒視窗上，將 [指派] 設定為 [靜態]，將 [IP 位址] 的預設值保留為 **10.40.0.4**。

1. 回到 [ipconfig1] 刀鋒視窗，儲存變更。 請務必等候儲存作業完成，再繼續進行下一個步驟。

1. 瀏覽回到 [az104-04-vnet1] 刀鋒視窗

1. 按一下 [az104-04-nic1]，然後在 [az104-04-nic1] 刀鋒視窗上，按一下 [IP 設定]。

    >**注意**：請確認 **ipconfig1** 目前已設定為動態私人 IP 位址。

1. 在 IP 設定清單中，按一下 [ipconfig1]。

1. 在 [ipconfig1] 刀鋒視窗的 [公用 IP 位址設定] 區段中，選取 [關聯]，按一下 [+ 新建]，指定下列設定，然後按一下 [確定]：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-04-pip1** |
    | SKU | **標準** |

1. 在 [ipconfig1] 刀鋒視窗上，將 [指派] 設定為 [靜態]，將 [IP 位址] 的預設值保留為 **10.40.1.4**。

1. 回到 [ipconfig1] 刀鋒視窗，儲存變更。

1. 瀏覽回到 [az104-04-rg1] 資源群組刀鋒視窗，在其資源清單中，按一下 [az104-04-vm0]，然後從 [az104-04-vm0] 虛擬機器刀鋒視窗，記下公用 IP 位址項目。

1. 瀏覽回到 [az104-04-rg1] 資源群組刀鋒視窗，在其資源清單中，按一下 [az104-04-vm1]，然後從 [az104-04-vm1] 虛擬機器刀鋒視窗，記下公用 IP 位址項目。

    >**注意**：在此實驗室的最後一個工作中，您將需要這兩個 IP 位址。

#### <a name="task-4-configure-network-security-groups"></a>工作 4：設定網路安全性群組

在此工作中，您將設定網路安全性群組，以允許對 Azure 虛擬機器進行限制的連線。

1. 在 Azure 入口網站中，瀏覽回到 [az104-04-rg1] 資源群組刀鋒視窗，然後在其資源清單中，按一下 [az104-04-vm0]。

1. 在 [az104-04-vm0] 概觀刀鋒視窗上，按一下 [連線]，在下拉式功能表中按一下 [RDP]，在 [透過 RDP 連線] 刀鋒視窗上，按一下 [下載 RDP 檔案] 使用公用 IP 位址，然後遵循提示來啟動遠端桌面工作階段。

1. 請注意，連線嘗試會失敗。

    >**注意**：這是意料之中的情況，因為標準 SKU 的公用 IP 位址預設要求受指派的網路介面，已受到網路安全性群組的保護。 為了允許遠端桌面連線，您需要建立明確允許來自網際網路輸入 RDP 流量的網路安全性群組，並將其指派給這兩部虛擬機器的網路介面。

1. 停止 **az104-04-vm0** 和 **az104-04-vm1** 虛擬機器。

    >**注意**：這是為了實驗室的暫時性操作。 如果虛擬機器在網路安全性群組連結至其網路介面時執行，則附件可能需要 30 分鐘的時間才會生效。 建立並連結網路安全性群組之後，虛擬機器將會重新啟動，而附件將會立即生效。

1. 在 Azure 入口網站中，搜尋並選取 [網路安全性群組]，然後在 [網路安全性群組] 刀鋒視窗上，按一下 [+ 建立]。

1. 使用下列設定建立網路安全性群組 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您在此實驗中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-04-rg1** |
    | 名稱 | **az104-04-nsg01** |
    | 區域 | 您在此實驗中部署所有其他資源的 Azure 區域名稱 |

1. 按一下 [檢閱及建立]。 隨即出現驗證，接著按一下 [建立] 提交您的部署。

    >**注意**：等待部署完成。 這應該大約需要 2 分鐘的時間。

1. 在 [部署] 刀鋒視窗上，按一下 [前往資源] 以開啟 **az104-04-nsg01** 網路安全性群組刀鋒視窗。

1. 在 **az104-04-nsg01** 網路安全性群組刀鋒視窗的 [設定] 區段中，按一下 [輸入安全性規則]。

1. 使用下列設定新增輸入規則 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 來源 | **任何** |
    | 來源連接埠範圍 | * |
    | 目的地 | **任何** |
    | 服務 | **RDP** |
    | 動作 | **允許** |
    | 優先順序 | **300** |
    | 名稱 | **AllowRDPInBound** |

1. 在 **az104-04-nsg01** 網路安全性群組刀鋒視窗的 [設定] 區段中，按一下 [網路介面]，然後按一下 [+ 關聯]。

1. 將 **az104-04-nsg01** 網路安全性群組與 **az104-04-nic0** 和 **az104-04-nic1** 網路介面建立關聯。

    >**注意**：新建立網路安全性群組的規則最多可能需要 5 分鐘的時間才會套用至網路介面卡。

1. 啟動 **az104-04-vm0** 和 **az104-04-vm1** 虛擬機器。

1. 瀏覽回到 **az104-04-vm0** 虛擬機器刀鋒視窗。

    >**注意**：在後續步驟中，請確認您可以成功連線到目標虛擬機器。

1. 在 [az104-04-vm0] 刀鋒視窗上，按一下 [連線]、按一下 [RDP]，在 [透過 RDP 連線] 刀鋒視窗上，按一下 [下載 RDP 檔案] 使用公用 IP 位址，然後遵循提示來啟動遠端桌面工作階段。

    >**注意**：此步驟是指透過遠端桌面從 Windows 電腦進行連線。 在 Mac 電腦上，您可以使用 Mac App Store 的遠端桌面用戶端；而在 Linux 電腦上，您可以使用開放原始碼 RDP 用戶端軟體。

    >**注意**：連線至目標虛擬機器時，您可以忽略任何警告提示。

1. 出現提示時，請使用參數檔案中的使用者和密碼登入。

    >**注意**：請將遠端桌面工作階段保持開啟。 您將在下一個工作中需要它。

#### <a name="task-5-configure-azure-dns-for-internal-name-resolution"></a>工作 5：設定 Azure DNS 以進行內部名稱解析

在此工作中，您將使用 Azure 私人 DNS 區域在虛擬網路內設定 DNS 名稱解析。

1. 在 Azure 入口網站中，搜尋並選取 [私人 DNS 區域]，然後在 [私人 DNS 區域] 刀鋒視窗上，按一下 [+ 建立]。

1. 使用下列設定建立私人 DNS 區域 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您在此實驗中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-04-rg1** |
    | 名稱 | **contoso.org** |

1. 按一下 [檢閱及建立]。 隨即出現驗證，接著再按一下 [建立] 提交您的部署。

    >**注意**：等候私人 DNS 區域建立。 這應該大約需要 2 分鐘的時間。

1. 按一下 [前往資源] 以開啟 [contoso.org] DNS 私人區域刀鋒視窗。

1. 在 [contoso.org] 私人 DNS 區域刀鋒視窗的 [設定] 區段中，按一下 [虛擬網路連結]

1. 按一下 [+ 新增] 以使用下列設定建立虛擬網路連結 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 連結名稱 | **az104-04-vnet1-link** |
    | 訂用帳戶 | 您在此實驗中使用的 Azure 訂用帳戶名稱 |
    | 虛擬網路 | **az104-04-vnet1** |
    | 啟用自動註冊 | 已啟用 |

1. 按一下 [確定]。

    >**注意：** 等候虛擬網路連結建立。 所需時間應該不超過 1 分鐘。

1. 在 [contoso.org] 私人 DNS 區域刀鋒視窗上，按一下側邊欄中的 [概觀]

1. 確認 **az104-04-vm0** 和 **az104-04-vm1** 的 DNS 記錄有出現在記錄集清單中，且顯示為 [已自動註冊]。

    >**注意：** 如果未列出上述記錄集，您可能需要等候幾分鐘並重新整理頁面。

1. 切換到 **az104-04-vm0** 的遠端桌面工作階段中，以滑鼠右鍵按一下 [開始] 按鈕，然後在滑鼠右鍵功能表中，按一下 [Windows PowerShell (管理員)]。

1. 在 Windows PowerShell 主控台視窗中執行下列命令，以測試新建立私人 DNS 區域中的內部名稱解析：

   ```powershell
   nslookup az104-04-vm0.contoso.org
   nslookup az104-04-vm1.contoso.org
   ```

1. 確認命令的輸出包含 **az104-04-vm1** (**10.40.1.4**) 的私人 IP 位址。

#### <a name="task-6-configure-azure-dns-for-external-name-resolution"></a>工作 6：設定 Azure DNS 以進行外部名稱解析

在此工作中，您將使用 Azure 公用 DNS 區域來設定外部 DNS 名稱解析。

1. 在網頁瀏覽器中，開啟新的索引標籤並瀏覽至 <https://www.godaddy.com/domains/domain-name-search>。

1. 使用網域名稱搜尋來識別未使用的網域名稱。

1. 在 Azure 入口網站中，搜尋並選取 [DNS 區域]，然後在 [DNS 區域] 刀鋒視窗上，按一下 [+ 建立]。

1. 使用下列設定建立 DNS 區域 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您在此實驗中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-04-rg1** |
    | 名稱 | 您稍早在這項工作中識別的 DNS 網域名稱 |

1. 按一下 [檢閱及建立]。 隨即出現驗證，接著再按一下 [建立] 提交您的部署。

    >**注意**：等候 DNS 區域建立。 這應該大約需要 2 分鐘的時間。

1. 按一下 [前往資源] 以開啟新建立 DNS 區域的刀鋒視窗。

1. 在 [DNS 區域] 刀鋒視窗上，按一下 [+ 記錄集]。

1. 使用下列設定新增記錄集 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-04-vm0** |
    | 類型 | **A** |
    | 別名記錄集 | **否** |
    | TTL | **1** |
    | TTL 單位 | **小時** |
    | IP 位址 | 您在本實驗室第三個練習中所識別的 **az104-04-vm0** 公用 IP 位址 |

1. 按一下 [檔案] &gt; [新增] &gt; [專案] 

1. 在 [DNS 區域] 刀鋒視窗上，按一下 [+ 記錄集]。

1. 使用下列設定新增記錄集 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-04-vm1** |
    | 類型 | **A** |
    | 別名記錄集 | **否** |
    | TTL | **1** |
    | TTL 單位 | **小時** |
    | IP 位址 | 您在本實驗室第三個練習中所識別的 **az104-04-vm1** 公用 IP 位址 |

1. 按一下 [檔案] &gt; [新增] &gt; [專案] 

1. 在 [DNS 區域] 刀鋒視窗上，記下 [Name server 1] 項目的名稱。

1. 在 Azure 入口網站中，按一下 Azure 入口網站右上角的圖示，已在 **Cloud Shell** 開啟 **PowerShell** 工作階段。

1. 從 [Cloud Shell] 窗格中，執行下列命令來測試新建立 DNS 區域中 **az104-04-vm0** DNS 記錄集的外部名稱解析 (將預留位置 `[Name server 1]` 取代為您稍早在此工作中記下的 **Name server 1**，並將 `[domain name]` 預留位置取代為您稍早在此工作中建立的 DNS 網域名稱稱)：

   ```powershell
   nslookup az104-04-vm0.[domain name] [Name server 1]
   ```

1. 確認命令的輸出包含 **az104-04-vm0** 的公用 IP 位址。

1. 從 [Cloud Shell] 窗格中，執行下列命令來測試新建立 DNS 區域中 **az104-04-vm1** DNS 記錄集的外部名稱解析 (將預留位置 `[Name server 1]` 取代為您稍早在此工作中記下的 **Name server 1**，並將 `[domain name]` 預留位置取代為您稍早在此工作中建立的 DNS 網域名稱稱)：

   ```powershell
   nslookup az104-04-vm1.[domain name] [Name server 1]
   ```

1. 確認命令的輸出包含 **az104-04-vm1** 的公用 IP 位址。

#### <a name="clean-up-resources"></a>清除資源

 > **注意**：請記得移除您不再使用的任何新建立的 Azure 資源。 移除未使用的資源可確保您不會看到非預期的費用。

 > **注意**：如果無法立即移除實驗資源，請不要擔心。 有時候資源具有相依性，需要經過較長的時間才能刪除。 這是監視資源使用量的常見系統管理員工作，因此只需定期檢閱入口網站中的資源，查看清除的運作情況便可。 

1. 在 Azure 入口網站中，在 [Cloud Shell] 窗格內開啟 [PowerShell] 工作階段。

1. 執行下列命令，列出在本課程模組的任何實驗中建立的所有資源群組：

   ```powershell
   Get-AzResourceGroup -Name 'az104-04*'
   ```

1. 執行下列命令，刪除您在本課程模組的任何實驗中建立的所有資源群組：

   ```powershell
   Get-AzResourceGroup -Name 'az104-04*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注意**：此命令以非同步方式執行 (由 --AsJob 參數決定)，所以您隨後能夠在相同 PowerShell 工作階段內立即執行另一個 PowerShell 命令，但需要經過幾分鐘後，才會實際移除資源群組。

#### <a name="review"></a>檢閱

在此實驗中，您已：

+ 建立和設定虛擬網路
+ 將虛擬機器部署至虛擬網路之中
+ 為 Azure VM 設定私人和公用 IP 位址
+ 設定網路安全性群組
+ 設定 Azure DNS 以進行內部名稱解析
+ 設定 Azure DNS 以進行外部名稱解析
