---
lab:
  title: 實驗室 06：實作流量管理
  module: Administer Network Traffic Management
---

# 實驗 06 - 實作流量管理
# 學生實驗手冊

## 實驗案例

您負責測試管理以中樞和輪輻網路拓撲中 Azure 虛擬機器為目標的網路流量，Contoso 會考慮在其 Azure 環境中實作 (而不是建立您在上一個實驗中測試的網狀拓撲)。 本測試必須透過依賴使用者定義的路由來實作輪輻之間的連線，以強制流量透過中樞傳送，以及使用第 4 層和第 7 層負載平衡器，將流量分散至虛擬機器之間。 為了達到此目的，您應使用 Azure Load Balancer (第 4 層) 和 Azure 應用程式閘道 (第 7 層)。

**注意：** **[互動式實驗室模擬](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2010)** (英文) 可供您以自己的步調完成此實驗室。 您可能會發現互動式模擬與託管實驗室之間稍有差異，但所示範的核心概念與想法均相同。 

>**注意**：根據預設，此實驗會需要所選區域中 Standard_Dsv3 系列的可用 vCPU 合計 8 個以供部署，因為實驗會包含部署 4 部 Standard_D2s_v3 SKU 的 Azure VM。 如果您的學生使用試用帳戶 (其限制為 4 個 vCPU)，則您可以使用只需要一個 vCPU 的 VM 大小 (例如 Standard_B1s)。

## 目標

在此實驗中，您將會：

+ 工作 1：佈建實驗室環境
+ 工作 2：設定中樞和輪輻網路拓撲
+ 工作 3：測試虛擬網路對等互連的轉移性
+ 工作 4：設定中樞和輪輻拓撲中的路由
+ 工作 5：實作 Azure Load Balancer
+ 工作 6：實作 Azure 應用程式閘道

## 預估時間：60 分鐘

## 架構圖

![image](../media/lab06.png)


### 指示

## 練習 1

## 工作 1：佈建實驗室環境

在此工作中，您會將四部虛擬機器部署至相同的 Azure 區域。 前兩個會位於中樞虛擬網路中，而其餘兩個則分別位於個別的輪輻虛擬網路中。

1. 登入 [Azure 入口網站](https://portal.azure.com)。

1. 在 Azure 入口網站中，按一下 Azure 入口網站右上角的圖示，開啟 **Azure Cloud Shell**。

1. 當系統提示您選取 [Bash] 或 [PowerShell] 時，請選取 [PowerShell]。

    >**注意**：如果這是您第一次啟動 **Cloud Shell**，而且出現**您未掛接任何儲存體**訊息，請選取您在此實驗中使用的訂用帳戶，並按一下 [建立儲存體]。

1. 在 [Cloud Shell] 窗格的工具列中，按一下 [上傳/下載檔案] 圖示，在下拉式功能表中，按一下 [上傳]，並將檔案 **\\Allfiles\\Labs\\06\\az104-06-vms-loop-template.json** 和 **\\Allfiles\\Labs\\06\\az104-06-vms-loop-parameters.json** 上傳至 Cloud Shell 主目錄。

1. 從 [Cloud Shell] 窗格中，執行下列命令以建立將主控實驗室環境的第一個資源群組 (將 '[Azure_region]’ 預留位置取代為您要部署 Azure 虛擬機器的 Azure 區域名稱) (您可以使用 "(Get-AzLocation).Location" Cmdlet 來取得區域清單)：

    ```powershell 
    $location = '[Azure_region]'
    ```
    
    這是資源群組名稱：
    ```powershell
    $rgName = 'az104-06-rg1'
    ```
    
    最後，在所需的位置建立資源群組：
    ```powershell
    New-AzResourceGroup -Name $rgName -Location $location
    ```


1. 從 [Cloud Shell] 窗格中，執行下列命令，使用您上傳的範本和參數檔案，將三個虛擬網路和四部 Azure VM 建立至其中：

    >**注意**：系統將會提示您提供管理員密碼。

   ```powershell
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vms-loop-template.json `
      -TemplateParameterFile $HOME/az104-06-vms-loop-parameters.json
   ```

    >**注意**：等候部署完成，再繼續進行下一個步驟。 這應該大約需要 5 分鐘的時間。

    >**注意**：如果您收到指出 VM 大小無法使用的錯誤，請向講師尋求協助，並嘗試下列步驟。
    > 1. 按一下 CloudShell 中的 `{}` 按鈕，從左側側邊列選取 [az104-06-vms-loop-parameters.json]，並記下 `vmSize` 參數值。
    > 1. 檢查部署 'az104-06-rg1' 資源群組的位置。 您可以在 CloudShell 中執行 `az group show -n az104-06-rg1 --query location` 以取得位置。
    > 1. 在 CloudShell 中執行 `az vm list-skus --location <Replace with your location> -o table --query "[? contains(name,'Standard_D2s')].name"`。
    > 1. 將 `vmSize` 參數的值取代為您剛才執行命令所傳回的其中一個值。 如果未傳回任何值，您可能必須選擇要部署的不同區域。 您也可以選擇不同的系列名稱，例如 "Standard_B1s"。
    > 1. 現在再次執行 `New-AzResourceGroupDeployment` 命令來重新部署範本。 您可以按下向上按鈕數次，這會出現上次執行的命令。

1. 從 [Cloud Shell] 窗格中，執行下列命令，在上一個步驟中部署的 Azure VM 上安裝網路監看員擴充功能：

   ```powershell
   $rgName = 'az104-06-rg1'
   $location = (Get-AzResourceGroup -ResourceGroupName $rgName).location
   $vmNames = (Get-AzVM -ResourceGroupName $rgName).Name

   foreach ($vmName in $vmNames) {
     Set-AzVMExtension `
     -ResourceGroupName $rgName `
     -Location $location `
     -VMName $vmName `
     -Name 'networkWatcherAgent' `
     -Publisher 'Microsoft.Azure.NetworkWatcher' `
     -Type 'NetworkWatcherAgentWindows' `
     -TypeHandlerVersion '1.4'
   }
   ```

    >**注意**：等候部署完成，再繼續進行下一個步驟。 這應該大約需要 5 分鐘的時間。



1. 關閉 [Cloud Shell] 窗格。

## 工作 2：設定中樞和輪輻網路拓撲

在此工作中，您將設定您在上一個工作中所部署虛擬網路之間的本機對等互連，以建立中樞和輪輻網路拓撲。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬網路]。

1. 檢閱您在上一個工作中建立的虛擬網路。

    >**注意**：所用於部署三個虛擬網路的範本可確保三個虛擬網路的 IP 位址範圍不會重疊。

1. 在虛擬網路清單中，選取 [az104-06-vnet2]。

1. 在 [az104-06-vnet2] 刀鋒視窗上，選取 [屬性]。 

1. 在 [az104-06-vnet2 \| 屬性] 刀鋒視窗上，記錄 [資源識別碼] 屬性的值。

1. 瀏覽回虛擬網路清單，然後選取 [az104-06-vnet3]。

1. 在 [az104-06-vnet3] 刀鋒視窗上，選取 [屬性]。 

1. 在 [az104-06-vnet3 \| 屬性] 刀鋒視窗上，記錄 [資源識別碼] 屬性的值。

    >**注意**：您稍後在此工作中需要這兩個虛擬網路的 ResourceID 屬性值。

    >**注意**：這是因應措施，用於解決在建立虛擬網路對等互連時 Azure 入口網站偶爾不會顯示新佈建虛擬網路的問題。

1. 在虛擬網路清單中，按一下 [az104-06-vnet01]。

1. 在 [az104-06-vnet01] 虛擬網路刀鋒視窗的 [設定] 區段中，按一下 [對等互連]，然後按一下 [+ 新增]。

1. 使用下列設定新增對等互連 (將其他設定保持預設值)，然後按一下 [新增]：

    | 設定 | 值 |
    | --- | --- |
    | 此虛擬網路：對等互連連結名稱 | **az104-06-vnet01_to_az104-06-vnet2** |
    | 允許 'az104-06-vnet01' 存取對等互連的虛擬網路 | **確定已核取方塊 （預設值）** |
    | 允許 'az104-06-vnet01' 中的閘道將流量轉送至對等互連的虛擬網路 | **確定已核取方塊** |
    | 遠端虛擬網路：對等互連連結名稱 | **az104-06-vnet2_to_az104-06-vnet01** |
    | 虛擬網路部署模型 | **資源管理員** |
    | 我知道我的資源識別碼 | 已啟用 |
    | 資源識別碼 | 您稍早在此工作中記錄的 ** az104-06-vnet2 ** resourceID 參數值。 |
    | 允許 az104-06-vnet2 存取 az104-06-vnet01 | **確定已核取方塊 （預設值）** |
    | 允許 az104-06-vnet2 接收來自 az104-06-vnet01 的轉送流量 | **確定已核取方塊** |

    >**注意**：等候操作完成。

    >**注意**：此步驟會建立兩個本機對等互連：一個從 az104-06-vnet01 到 az104-06-vnet2，另一個則從 az104-06-vnet2 到 az104-06-vnet01。

1. 在 [az104-06-vnet01] 虛擬網路刀鋒視窗的 [設定] 區段中，按一下 [對等互連]，然後按一下 [+ 新增]。

1. 使用下列設定新增對等互連 (將其他設定保持預設值)，然後按一下 [新增]：

    | 設定 | 值 |
    | --- | --- |
    | 此虛擬網路：對等互連連結名稱 | **az104-06-vnet01_to_az104-06-vnet3** |
    | 允許 'az104-06-vnet01' 存取對等互連的虛擬網路 | **確定已核取方塊 （預設值）** |
    | 允許 'az104-06-vnet01' 中的閘道將流量轉送至對等互連的虛擬網路 | **確定已核取方塊** |
    | 遠端虛擬網路：對等互連連結名稱 | **az104-06-vnet3_to_az104-06-vnet01** |
    | 虛擬網路部署模型 | **資源管理員** |
    | 我知道我的資源識別碼 | 已啟用 |
    | 資源識別碼 | 您稍早在此工作中記錄的 ** az104-06-vnet3 ** resourceID 參數值。 |
    | 允許 az104-06-vnet3 存取 az104-06-vnet01 | **確定已核取方塊 （預設值）** |
    | 允許 az104-06-vnet3 接收來自 az104-06-vnet01 的轉送流量 | **確定已核取方塊** |


    >**注意**：等候操作完成。
    
    >**注意**：此步驟會建立兩個本機對等互連：一個從 az104-06-vnet01 到 az104-06-vnet3，另一個則從 az104-06-vnet3 到 az104-06-vnet01。 這會完成設定中樞和輪輻拓撲 (具兩個輪輻虛擬網路)。

## 工作 3：測試虛擬網路對等互連的轉移性

在此工作中，您將使用網路監看員來測試虛擬網路對等互連的轉移性。

1. 在 Azure 入口網站中，搜尋並選取 [網路監看員]。

1. 在[網路監看員] 刀鋒視窗上，展開 [Azure 區域] 清單，並確認已在您使用的區域啟用服務。 

1. 在 [網路監看員] 刀鋒視窗上，瀏覽至 [連線疑難排解]。

1. 在 [網路監看員 - 連線疑難排解] 刀鋒視窗上，使用下列設定起始檢查 (將其他設定保留預設值)：

    > **注意**：資源群組可能需要幾分鐘時間才會列出。 若您不想等候，請嘗試下列動作：刪除網路監看員、建立新的網路監看員，然後重試 [Connection Troubleshoot] \(連線疑難排解\)。 

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-06-rg1** |
    | 來源類型 | **虛擬機器** |
    | 虛擬機器 | **az104-06-vm0** |
    | Destination | **手動指定** |
    | URI、FQDN 或 IPv4 | **10.62.0.4** |
    | 通訊協定 | **TCP** |
    | 目的地連接埠 | **3389** |

    > **注意**：**10.62.0.4** 代表 **az104-06-vm2** 的私人 IP 位址

1. 按一下 [執行診斷測試]，等候連線檢查的結果傳回完成。 確認狀態為 [成功]。 檢閱網路路徑，並注意連線是直達並在 VM 之間沒有中繼躍點。

    > **注意**：這是預期的狀況，因為中樞虛擬網路會直接與第一個輪輻虛擬網路對等互連。

1. 在 [網路監看員 - 連線疑難排解] 刀鋒視窗上，使用下列設定起始檢查 (將其他設定保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-06-rg1** |
    | 來源類型 | **虛擬機器** |
    | 虛擬機器 | **az104-06-vm0** |
    | Destination | **手動指定** |
    | URI、FQDN 或 IPv4 | **10.63.0.4** |
    | 通訊協定 | **TCP** |
    | 目的地連接埠 | **3389** |

    > **注意**：**10.63.0.4** 代表 **az104-06-vm3** 的私人 IP 位址

1. 按一下 [執行診斷測試]，等候連線檢查的結果傳回完成。 確認狀態為 [成功]。 檢閱網路路徑，並注意連線是直達並在 VM 之間沒有中繼躍點。

    > **注意**：這是預期的狀況，因為中樞虛擬網路會直接與第二個輪輻虛擬網路對等互連。

1. 在 [網路監看員 - 連線疑難排解] 刀鋒視窗上，使用下列設定起始檢查 (將其他設定保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-06-rg1** |
    | 來源類型 | **虛擬機器** |
    | 虛擬機器 | **az104-06-vm2** |
    | Destination | **手動指定** |
    | URI、FQDN 或 IPv4 | **10.63.0.4** |
    | 通訊協定 | **TCP** |
    | 目的地連接埠 | **3389** |

1. 按一下 [執行診斷測試]，等候連線檢查的結果傳回完成。 請注意，狀態為 [失敗]。

    > **注意**：這是預期的狀況，因為兩個輪輻虛擬網路不會彼此對等互連 (虛擬網路對等互連不可轉移)。

## 工作 4：設定中樞和輪輻拓撲中的路由

在此工作中，您將在 **az104-06-vm0** 虛擬機器的網路介面上啟用 IP 轉送、在其作業系統內啟用路由，並在輪輻虛擬網路上設定使用者定義的路由，來設定和測試兩個輪輻虛擬網路之間的路由。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬機器]。

1. 在 [虛擬機器] 刀鋒視窗的虛擬機器清單中，按一下 [az104-06-vm0]。

1. 在 [az104-06-vm0] 虛擬機器刀鋒視窗的 [設定] 區段中，按一下 [網路功能]。

1. 按一下 [網路介面] 標籤旁的 [az104-06-nic0] 連結，然後在 [az104-06-nic0] 網路介面刀鋒視窗的 [設定] 區段中，按一下 [IP 設定]。

1. 將 [IP 轉送] 設定為 [已啟用]，並儲存變更。

   > **注意**：此設定為必要，才能讓 **az104-06-vm0** 作為路由器運作，這會路由傳送兩個輪輻虛擬網路之間的流量。

   > **注意**：您現在必須設定 **az104-06-vm0** 虛擬機器的作業系統來支援路由。

1. 在 Azure 入口網站中，瀏覽回 [az104-06-vm0] Azure 虛擬機器刀鋒視窗，並按一下 [概觀]。

1. 在 [az104-06-vm0] 刀鋒視窗的 [作業] 區段中，按一下 [執行命令]，接著在命令清單中，按一下 [RunPowerShellScript]。

1. 在 [執行命令指令碼] 刀鋒視窗中，輸入下列命令，並按一下 [執行] 以安裝遠端存取 Windows 伺服器角色。

   ```powershell
   Install-WindowsFeature RemoteAccess -IncludeManagementTools
   ```

   > **注意**：等候確認命令已成功完成。

1. 在 [執行命令指令碼] 刀鋒視窗上，輸入下列命令，並按一下 [執行] 以安裝路由角色服務。

   ```powershell
   Install-WindowsFeature -Name Routing -IncludeManagementTools -IncludeAllSubFeature

   Install-WindowsFeature -Name "RSAT-RemoteAccess-Powershell"

   Install-RemoteAccess -VpnType RoutingOnly

   Get-NetAdapter | Set-NetIPInterface -Forwarding Enabled
   ```

   > **注意**：等候確認命令已成功完成。

   > **注意**：您現在必須建立和設定輪輻虛擬網路上的使用者定義路由。

1. 在 Azure 入口網站中，搜尋和選取 [路由表]，並在 [路由表] 上，按一下 [+ 建立]。

1. 使用下列設定建立路由表 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-06-rg1** |
    | 位置 | 您建立虛擬網路的 Azure 區域名稱 |
    | 名稱 | **az104-06-rt23** |
    | 散佈閘道路由 | 否 |

1. 按一下 [檢閱及建立]。 隨即出現驗證，接著按一下 [建立] 提交您的部署。

   > **注意**：等候路由表建立。 這應該大約需要 3 分鐘的時間。

1. 按一下 [前往資源]。

1. 在 [az104-06-rt23] 路由表刀鋒視窗的 [設定] 區段中，按一下 [路由]，然後按一下 [+ 新增]。

1. 使用下列設定新增路由：

    | 設定 | 值 |
    | --- | --- |
    | 路由名稱 | **az104-06-route-vnet2-to-vnet3** |
    | 位址首碼目的地 | **IP 位址** |
    | 目的地 IP 位址/CIDR 範圍 | **10.63.0.0/20** |
    | 下一個躍點類型 | **虛擬設備** |
    | 下一個躍點位址 | **10.60.0.4** |

1. 按一下 [新增]

1. 返回至 [az104-06-rt23] 路由表刀鋒視窗的 [設定] 區段中，按一下 [子網路]，然後按一下 [+ 關聯]。

1. 將路由表 **az104-06-rt23** 與下列子網路建立關聯：

    | 設定 | 值 |
    | --- | --- |
    | 虛擬網路 | **az104-06-vnet2** |
    | 子網路 | **subnet0** |

1. 按一下 [新增]

1. 瀏覽回 [路由表] 刀鋒視窗，並按一下 [+ 建立]。

1. 使用下列設定建立路由表 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-06-rg1** |
    | 區域 | 您建立虛擬網路的 Azure 區域名稱 |
    | 名稱 | **az104-06-rt32** |
    | 散佈閘道路由 | 否 |

1. 按一下 [檢閱及建立]。 隨即出現驗證，接著按一下 [建立] 提交您的部署。

   > **注意**：等候路由表建立。 這應該大約需要 3 分鐘的時間。

1. 按一下 [前往資源]。

1. 在 [az104-06-rt32] 路由表刀鋒視窗的 [設定] 區段中，按一下 [路由]，然後按一下 [+ 新增]。

1. 使用下列設定新增路由：

    | 設定 | 值 |
    | --- | --- |
    | 路由名稱 | **az104-06-route-vnet3-to-vnet2** |
    | 位址首碼目的地 | **IP 位址** |
    | 目的地 IP 位址/CIDR 範圍 | **10.62.0.0/20** |
    | 下一個躍點類型 | **虛擬設備** |
    | 下一個躍點位址 | **10.60.0.4** |

1. 按一下 [檔案] &gt; [新增] &gt; [專案]

1. 返回至 [az104-06-rt32] 路由表刀鋒視窗的 [設定] 區段中，按一下 [子網路]，然後按一下 [+ 關聯]。

1. 將路由表 **az104-06-rt32** 與下列子網路建立關聯：

    | 設定 | 值 |
    | --- | --- |
    | 虛擬網路 | **az104-06-vnet3** |
    | 子網路 | **subnet0** |

1. 按一下 [檔案] &gt; [新增] &gt; [專案]

1. 在 Azure 入口網站中，瀏覽回 [網路監看員 - 連線疑難排解] 刀鋒視窗。

1. 在 [網路監看員 - 連線疑難排解] 刀鋒視窗上，使用下列設定 (將其他設定保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-06-rg1** |
    | 來源類型 | **虛擬機器** |
    | 虛擬機器 | **az104-06-vm2** |
    | Destination | **手動指定** |
    | URI、FQDN 或 IPv4 | **10.63.0.4** |
    | 通訊協定 | **TCP** |
    | 目的地連接埠 | **3389** |

1. 按一下 [執行診斷測試]，等候連線檢查的結果傳回完成。 確認狀態為 [成功]。 檢閱網路路徑，並注意流量是透過 **10.60.0.4** 路由傳送且該路徑是指派給 **az104-06-nic0** 網路介面卡。 如果狀態為 [失敗]，您應該停止，然後啟動 az104-06-vm0。

    > **注意**：這是預期狀況，因為輪輻虛擬網路之間的流量現在會透過位於中樞虛擬網路中的虛擬機器路由傳送，其會作為路由器運作。

    > **注意**：您可以使用**網路監看員**來檢視網路的拓撲。

## 工作 5：實作 Azure Load Balancer

在此工作中，您將會在中樞虛擬網路中的兩部 Azure 虛擬機器前端實作 Azure Load Balancer。

1. 在 Azure 入口網站中，搜尋並選取 [負載平衡器]，然後在 [負載平衡器] 刀鋒視窗上，按一下 [+ 建立]。

1. 使用下列設定建立負載平衡器 (將其他設定保持預設值)，然後按一下 [下一步：前端 IP 設定]：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-06-rg4** (如有需要建立) |
    | 名稱 | **az104-06-lb4** |
    | 區域 | 您在此實驗中部署所有其他資源的 Azure 區域名稱 |
    | SKU  | **標準** |
    | 類型 | **公開** |
    | 層 | **Regional** |
    
1. 在 [前端 IP 設定] 索引標籤上，按一下 [新增前端 IP 設定]，然後使用下列設定：  
     
    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-06-fe4** |
    | IP 類型 | IP 位址 |
    | 公用 IP 位址 | 選取 [新建] |
    | 閘道負載平衡器 | 無 |
    
1. 在 [新增公用 IP 位址] 彈出視窗上，使用以下設定，然後依序按一下 [確定] 和 [新增]。 完成時，按一下 [Next: Backend pools] \(下一步：後端集區\)。 
     
    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-06-pip4** |
    | SKU | 標準 |
    | 層 | 地區 |
    | 指派 | 靜態 |
    | 路由喜好設定 | **Microsoft 網路** |

1. 在 [後端集區] 索引標籤上，搭配下列設定 (將其他設定保留為預設值) 按一下 [新增後端集區]。 按一下 [+ 新增] (兩次)，然後按一下 [Next:Inbound rules] \(下一步：輸入規則\)。 

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-06-lb4-be1** |
    | 虛擬網路 | **az104-06-vnet01** |
    | 後端集區設定 | **NIC** | 
    | IP 版本 | **IPv4** |
    | 按一下 [新增] 以新增虛擬機器 |  |
    | az104-06-vm0 | **核取方塊** |
    | az104-06-vm1 | **核取方塊** |


1. 在 [輸入規則] 索引標籤上，按一下 [新增負載平衡規則]。 使用下列設定新增負載平衡規則 (將其他設定保留為預設值)。 完成時，按一下 [新增]。

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-06-lb4-lbrule1** |
    | IP 版本 | **IPv4** |
    | 前端 IP 位址 | **az104-06-fe4** |
    | 後端集區 | **az104-06-lb4-be1** |    
    | 通訊協定 | **TCP** |
    | 連接埠 | **80** |
    | 後端連接埠 | **80** |
    | 健全狀況探查 | **新建** |
    | 名稱 | **az104-06-lb4-hp1** |
    | 通訊協定 | **TCP** |
    | 連接埠 | **80** |
    | 間隔 | **5** |
    | 關閉 [create health probe] \(建立健全狀態探查\) 視窗 | **確定** | 
    | 工作階段持續性 | **無** |
    | 閒置逾時 (分鐘) | **4** |
    | TCP 重設 | **停用** |
    | 浮動 IP | **Disabled** |
    | 輸出來源網路位址轉譯 (SNAT) | **建議需求** |

1. 當您有時間時，請檢閱其他索引標籤，然後按一下 [檢閱及建立]。 確定沒有任何驗證錯誤，然後按一下 [建立]。 

1. 等候負載平衡器部署，然後按一下 [前往資源]。  

1. 從 Load Balancer 資源頁面中選取 [Frontend IP configuration] \(前端 IP 設定\)。 複製 IP 位址。

1. 開啟另一個瀏覽器索引標籤，然後巡覽至該 IP 位址。 確認瀏覽器視窗會顯示 **Hello World from az104-06-vm0** 或 **Hello World from az104-06-vm1** 訊息。

1. 重新整理視窗，以確認訊息會變更為另一部虛擬機器。 這可示範負載平衡器在不同的虛擬機器之間轉換。

    > **注意**：您可能需要多次重新整理，或在 InPrivate 模式中開啟新的瀏覽器視窗。

## 工作 6：實作 Azure 應用程式閘道

在此工作中，您將在輪輻虛擬網路中的兩部 Azure 虛擬機器前端實作 Azure 應用程式閘道。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬網路]。

1. 在 [虛擬網路] 刀鋒視窗的虛擬網路清單中，按一下 [az104-06-vnet01]。

1. 在 [az104-06-vnet01] 虛擬網路刀鋒視窗的 [設定] 區段中，按一下 [子網路]，然後按一下 [+ 子網路]。

1. 使用下列新增建立子網路 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **subnet-appgw** |
    | 子網路位址範圍 | **10.60.3.224/27** |

1. 按一下 [儲存]

    > **注意**：此子網將由 Azure 應用程式閘道執行個體使用，稍後您將在此工作中部署。 應用程式閘道需要大小為 /27 或更大的專用子網路。

1. 在Azure 入口網站中，搜尋並選取 [應用程式閘道]，然後在 [應用程式閘道] 刀鋒視窗上，按一下 [+ 建立]。

1. 在 [基本] 索引標籤上，指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | **az104-06-rg5** (新建) |
    | 應用程式閘道名稱 | **az104-06-appgw5** |
    | 區域 | 您在此實驗中部署所有其他資源的 Azure 區域名稱 |
    | 層 | **Standard V2** |
    | 啟用自動調整 | 否 |
    | 執行個體計數 | **2** |
    | 可用性區域 | **None** |
    | HTTP2 | **停用** |
    | 虛擬網路 | **az104-06-vnet01** |
    | 子網路 | **subnet-appgw (10.60.3.224/27)** |

1. 按一下 [Next: Frontends >] \(下一步: 前端 >\)，然後指定下列設定 (將其他設定保留為預設值)。 完成時，按一下 [確定]。 

    | 設定 | 值 |
    | --- | --- |
    | 前端 IP 位址類型 | **公開** |
    | 公用 IP 位址| **新增** | 
    | 名稱 | **az104-06-pip5** |
    | 可用性區域 | **None** |

1. 按一下 [Next: Backends >] \(下一步: 後端 >\)，然後按一下 [新增後端集區]。 指定下列設定 (將其他設定保留為預設值)。 完成時，按一下 [新增]。

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-06-appgw5-be1** |
    | 新增無目標的後端集區 | 否 |
    | IP 位址或 FQDN | **10.62.0.4** | 
    | IP 位址或 FQDN | **10.63.0.4** |

    > **注意**：目標代表輪輻虛擬網路 **az104-06-vm2** 和 **az104-06-vm3**中虛擬機器的私人 IP 位址。

1. 依序按一下 [Next: Configuration >] \(下一步: 設定 >\) 與 [+ Add a routing rule] \(+ 新增路由規則\)。 指定下列設定：

    | 設定 | 值 |
    | --- | --- |
    | 規則名稱 | **az104-06-appgw5-rl1** |
    | 優先順序 | **10** |
    | 接聽程式名稱 | **az104-06-appgw5-rl1l1** |
    | 前端 IP | **公開** |
    | 通訊協定 | **HTTP** |
    | 連接埠 | **80** |
    | 接聽程式類型 | **基本** |
    | 錯誤頁面 URL | 否 |

1. 切換至 [Backend targets] \(後端目標\) 索引標籤，並指定下列設定 (將其他設定保留為預設值)。 完成時，按一下 [新增] (兩次)。  

    | 設定 | 值 |
    | --- | --- |
    | 目標類型 | **後端集區** |
    | 後端目標 | **az104-06-appgw5-be1** |
    | 後端設定 | **新增** |
    | 後端設定名稱 | **az104-06-appgw5-http1** |
    | 後端通訊協定 | **HTTP** |
    | 後端連接埠 | **80** |
    | 其他設定 | **採用預設值** |
    | 主機名稱 | **採用預設值** |

1. 按一下 [下一步：**標籤 >]，接著按一下 [下一步：檢閱 + 建立]，然後按一下 [建立]。

    > **注意**：等候應用程式閘道執行個體建立完成。 這大約需要 8 分鐘。

1. 在Azure 入口網站中，搜尋並選取 [應用程式閘道]，然後在 [應用程式閘道] 刀鋒視窗上，按一下 [az104-06-appgw5]。

1. 在 **az104-06-appgw5** [應用程式閘道] 刀鋒視窗上，複製 [Frontend public IP address] \(前端公用 IP 位址\) 的值。

1. 開啟另一個瀏覽器視窗，瀏覽至您在上一個步驟找到的 IP 位址。

1. 確認瀏覽器視窗會顯示 **Hello World from az104-06-vm2** 或 **Hello World from az104-06-vm3** 訊息。

1. 重新整理視窗，以確認訊息會變更為另一部虛擬機器。 

    > **注意**：您可能需要多次重新整理，或在 InPrivate 模式中開啟新的瀏覽器視窗。

    > **注意**：將多個虛擬網路上的虛擬機器設為目標不是常見的設定，但是為了說明應用程式閘道能夠將多個虛擬網路上的虛擬機器設為目標 (以及其他 Azure 區域中的端點，甚至是 Azure 區域以外的端點)，這與 Azure Load Balancer不同，其會將相同虛擬網路中的虛擬機器負載平衡。

## 清除資源

>**注意**：請記得移除您不再使用的任何新建立的 Azure 資源。 移除未使用的資源可確保您不會看到非預期的費用。

>**注意**：如果無法立即移除實驗資源，請不要擔心。 有時候資源具有相依性，需要經過較長的時間才能刪除。 這是監視資源使用量的常見系統管理員工作，因此只需定期檢閱入口網站中的資源，查看清除的運作情況便可。 

1. 在 Azure 入口網站中，在 [Cloud Shell] 窗格內開啟 [PowerShell] 工作階段。

1. 執行下列命令，列出在本課程模組的任何實驗中建立的所有資源群組：

   ```powershell
   Get-AzResourceGroup -Name 'az104-06*'
   ```

1. 執行下列命令，刪除您在本課程模組的任何實驗中建立的所有資源群組：

   ```powershell
   Get-AzResourceGroup -Name 'az104-06*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注意**：此命令以非同步方式執行 (由 --AsJob 參數決定)，所以您隨後能夠在相同 PowerShell 工作階段內立即執行另一個 PowerShell 命令，但需要經過幾分鐘後，才會實際移除資源群組。

## 檢閱

在此實驗中，您已：

+ 佈建實驗環境
+ 設定中樞和輪輻網路拓撲
+ 測試虛擬網路對等互連的轉移性
+ 設定中樞和支點拓撲中的路由
+ 已實作 Azure Load Balancer
+ 已實作 Azure 應用程式閘道
