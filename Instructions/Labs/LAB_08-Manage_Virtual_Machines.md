---
lab:
  title: 實驗室 08：管理虛擬機器
  module: Administer Virtual Machines
---

# 實驗室 08 – 管理虛擬機器

## 實驗室簡介

在此實驗室中，您會建立虛擬機器並與虛擬機器擴展集進行比較。 您將了解如何建立、設定及調整單一虛擬機器的大小。 您將了解如何建立虛擬機器擴展集並設定自動調整。

此實驗室需要 Azure 訂用帳戶。 您的訂用帳戶類型可能會影響此實驗室中的功能可用性。 您可以變更區域，但這些步驟是使用**美國東部**撰寫而成。

## 預估時間：50 分鐘

## 實驗案例

您的組織想要探索部署和設定 Azure 虛擬機器。 首先，請您使用手動調整來實作 Azure 虛擬機器。 接下來，您會實作虛擬機器擴展集，並探索自動調整。

## 互動式實驗室模擬

您可能會發現部分互動式實驗室模擬對本主題十分有用。 模擬可讓您以自己的步調點選類似的案例。 互動式模擬與此實驗室之間有所差異，但許多核心概念都相同。 不需要 Azure 訂用帳戶。

+ [在入口網站中建立虛擬機器](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%201)。 建立虛擬機器、連線並安裝 Web 伺服器角色。

+ [使用範本部署虛擬機器](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%209)。 探索快速入門資源庫並定位虛擬機器範本。 部署範本並驗證部署。

+ [使用 PowerShell 建立虛擬機器](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%2010)。 使用 Azure PowerShell 部署虛擬機器。 檢閱 Azure Advisor 建議。

+ [使用 CLI 建立虛擬機器](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%2011)。 使用 CLI 部署虛擬機器。 檢閱 Azure Advisor 建議。

## 作業技能

+ 工作 1：使用 Azure 入口網站部署區域復原性 Azure 虛擬機器。
+ 工作 2：管理 Azure 虛擬機器的計算與儲存空間。
+ 工作 3：建立並設定 Azure 虛擬機器擴展集。
+ 工作 4：調整 Azure 虛擬機器擴展集。
+ 工作 5：使用 Azure PowerShell (選項 1) 建立虛擬機器。
+ 工作 6：使用 CLI (選項 2) 建立虛擬機器。

## Azure 虛擬機器結構圖表

![VM 結構工作圖表。](../media/az104-lab08-vm-architecture.png)

## 工作 1：使用 Azure 入口網站部署具有區域復原性的 Azure 虛擬機器

在此工作中，您將使用 Azure 入口網站，把兩個 Azure 虛擬機器部署在不同的可用性區域。 可用性區域為虛擬機器提供 99.99% 最高層級的運作時間 SLA。 若要達成此 SLA，您必須在不同的可用性區域部署至少兩部虛擬機器。

1. 登入 Azure 入口網站 - `https://portal.azure.com`。

1. 搜尋並選取 `Virtual machines`，在 [虛擬機器]**** 刀鋒視窗中，按一下 [+ 建立]****，然後在下拉式清單中選取 [Azure 虛擬機器]****。 請注意您的其他選擇。

1. 在 [基本]**** 索引標籤的 [可用性區域]**** 下拉式功能表中，勾選 [區域 2]**** 旁的核取記號。 這應該同時選取 **區域 1** 和 **區域 2**。

    >**注意**：這會在選取的區域中部署兩部虛擬機器，每個區域各一部。 您可以達到 99.99% 運作時間 SLA，因為您至少有兩部 VM 分散在至少兩個區域。 在您可能只需要一部 VM 的情況下，最佳做法仍是將 VM 部署到另一個區域。

1. 在 [基本] 索引標籤上，繼續完成設定:

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您的 Azure 訂用帳戶的名稱 |
    | 資源群組 |  **az104-rg8** (如有必要，按一下 [新建]****) |
    | 虛擬機器名稱 | `az104-vm1` 和 `az104-vm2` (選取這兩個可用性區域之後，請在 [VM 名稱欄位] 下選取 [編輯名稱]****。) |
    | 區域 | **美國東部** |
    | 可用性選項 | **可用性區域** |
    | 可用性區域 | **區域 1、2** (讀取有關使用虛擬機器擴展集的附註) |
    | 安全性類型 | **標準** |
    | 映像 | **Windows Server 2019 Datacenter - x64 Gen2** |
    | Azure Spot 執行個體 | **unchecked** |
    | 大小 | **標準 D2s v3** |
    | 使用者名稱 | `localadmin` |
    | 密碼 | **提供安全的密碼** |
    | 公用輸入連接埠 | **無** |
    | 您要使用現有的 Windows Server 授權嗎？ | **未選取** |

    ![建立 VM 分頁的螢幕擷取畫面。](../media/az104-lab08-create-vm.png)

1. 按一下 [下一步:**資料箱磁碟>**，指定下列設定 (將其他設定保留為預設值):

    | 設定 | 值 |
    | --- | --- |
    | OS 磁碟類型 | **進階 SSD** |
    | 使用 VM 刪除 | **已核取** (預設值) |
    | 启用超级磁盘兼容性 | **未選取** |

1. 按一下 [下一步:**網路 >** 採用預設值，但不提供負載平衡器。

    | 設定 | 值 |
    | --- | --- |
    | 刪除 VM 時刪除公用 IP 和 NIC | **已選取** |
    | 負載平衡選項 | **None** |


1. 按一下 [下一步:**管理 >]**，然後指定下列設定 (將其他設定保留為預設值):

    | 設定 | 值 |
    | --- | --- |
    | 修補程式協調流程選項 | **Azure orchestrated** |  

1. 按一下 [下一步:**監視 >]**，然後指定下列設定 (將其他設定保留為預設值):

    | 設定 | 值 |
    | --- | --- |
    | 開機診斷 | **停用** |

1. 按一下 [下一步:**進階 >**，採用預設值，然後按一下 [檢閱 + 建立]****。

1. 驗證通過後，按一下 [建立]****。

    >**注意：** 請注意，虛擬機器部署時，NIC、磁碟和公用 IP 位址 (如有設定) 為獨立建立和受控資源。

1. 等候部署完成，然後選取 [移至資源]****。

   >**注意：** 監視**通知**訊息。

## 工作 2：管理虛擬機器的計算能力和儲存體調整能力

在此工作中，您會依不同的 SKU 調整虛擬機器的大小。 Azure 提供彈性的 VM 大小選取範圍，讓您在 VM 需要更多 (或更少) 的計算和記憶體配置時，可以調整 VM 一段時間。 此概念延伸至磁碟，您可以修改磁碟的效能，或增加配置的容量。

1. 在 **az104-vm1** 虛擬機器的 [可用性 + 調整]**** 刀鋒視窗中，選取 [大小]****。

1. 將虛擬機器大小設定為 **DS1_v2**，然後按一下 [調整大小]****。 出現提示時，請確認變更。

    >**注意**：如果無法使用**標準 DS1_v2**，請選擇另一個大小。 調整大小也稱為垂直擴大或縮小。

    ![調整虛擬機器大小的螢幕擷取畫面。](../media/az104-lab08-resize-vm.png)

1. 在 [設定]**** 區域中，選取 [資料箱磁碟]****。

1. 在 [資料磁碟]**** 下，選取 [+ Create and attach a new disk] (建立並連結新磁碟)****。 進行設定 (將其他設定保留預設值)。

    | 設定 | 值 |
    | --- | --- |
    | 磁碟名稱 | `vm1-disk1` |
    | 儲存體類型 | **標準 HDD** |
    | 大小 (GiB) | `32` |

1. 按一下 **套用**。

1. 建立磁碟之後，按一下 [中斷連結]**** (如有必要，捲動至右側以檢視中斷連結圖示)，然後按一下 [套用]****。

    >**注意**：中斷連結會從 VM 移除磁碟，但會將其保留在儲存體中以供日後使用。

1. 搜尋並選取 `Disks`。 從磁碟清單中，選取 [vm1-disk1]**** 物件。

    >**注意：**[概觀]**** 刀鋒視窗也會提供磁碟的效能和使用方式資訊。

1. 在 [設定]**** 刀鋒視窗中，選取 [大小 + 效能]****。

1. 將儲存體類型設定為 **標準 SSD**，然後按一下 [儲存]****。

1. 瀏覽回到 **az104-vm1** 虛擬機器，並選取 [磁碟]****。

1. 在 [資料磁碟]**** 區段中，選取 [連結現有的磁碟]****。

1. 在 [磁碟名稱]**** 下拉式清單中，選取 [VM1-DISK1]****。 

1. 確認磁碟現在已是 **標準 SSD**。

1. 選取 [**套用**] 以儲存變更。 

    >**注意：** 您現在已建立虛擬機器、調整 SKU 和資料磁碟大小。 在下一個工作中，我們使用虛擬機器擴展集將調整流程自動化。

## Azure 虛擬機器擴展集結構圖表

![VMSS 結構工作圖表。](../media/az104-lab08-vmss-architecture.png)

## 工作 3：建立並設定 Azure 虛擬機器擴展集

在此工作中，您將在各個可用性區域部署 Azure 虛擬機器擴展集。 VM 擴展集透過讓您設定可讓擴展集水平調整、縮減或擴增的計量或條件，以減少自動化的系統管理負荷。

1. 在 Azure 入口網站中，搜尋並選取 [`Virtual machine scale sets`]，然後在 [虛擬機器擴展集]**** 刀鋒視窗上，按一下 [+ 建立]****。

1. 在 [建立虛擬機器擴展集]**** 刀鋒視窗的 [基本]**** 索引標籤上指定下列設定 (其他設定請保留預設值)，然後按一下 [下一步：**現成品 >**:

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您的 Azure 訂用帳戶的名稱  |
    | 資源群組 | **az104-rg8**  |
    | [虛擬機器擴展集名稱] | `vmss1` |
    | 區域 | **(美國) 美國東部** |
    | 可用性區域 | **區域 1、2、3** |
    | 協調流程模式 | **Uniform** |
    | 安全性類型 | **標準** |
    | 映像 | **Windows Server 2019 Datacenter - x64 Gen2** |
    | 使用 Azure 現成 VM 折扣執行 | **未選取** |
    | 大小 | **標準 D2s_v3** |
    | 使用者名稱 | `localadmin` |
    | 密碼 | **提供安全的密碼**  |
    | 已經有 Windows Server 授權了嗎? | **未選取** |

    >**注意**：如需支援將Windows虛擬機器部署至可用性區域的 Azure 區域清單，請參閱[什麼是 Azure 中的可用性區域？](https://docs.microsoft.com/en-us/azure/availability-zones/az-overview)

    ![建立 VMSS 分頁的螢幕擷取畫面。 ](../media/az104-lab08-create-vmss.png)

1. 在 [現成品]**** 索引標籤上，接受預設值，並選取 **[下一步: 磁碟 >]**。

1. 在 [磁碟]**** 索引標籤上，接受預設值，並按一下 **[下一步: 網路 >]**。

1. 在 [網路]**** 分頁上，按一下 [虛擬網路]**** 文字方塊下方的 [建立虛擬網路]**** 連結，並使用下列設定建立新的虛擬網路 (其他設定請保留預設值)。  完成後，選取 [確定]****。

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `vmss-vnet` |
    | 位址範圍 | `10.82.0.0/20` (變更那裡的內容) |
    | 子網路名稱 | `subnet0` |
    | 子網路範圍 | `10.82.0.0/24` |

1. 在 [網路]**** 索引標籤中，按一下網路介面項目右側的 [編輯網路介面]**** 圖示。

1. 對於 [NIC 網路安全性群組]**** 區段，選取 [進階]****，然後按一下 [設定網路安全性群組]**** 下拉式清單底下的 [新建]****。

1. 在 [建立網路安全性群組] 刀鋒視窗中指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **vmss1-nsg** |

1. 按一下 [新增輸入規則]，並使用下列設定新增輸入安全性規則 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 來源 | **任何** |
    | 來源連接埠範圍 | * |
    | Destination | **任何** |
    | 服務 | **HTTP** |
    | 動作 | **允許** |
    | 優先順序 | **1010** |
    | 名稱 | `allow-http` |

1. 按一下 [新增]，然後在 [建立網路安全性群組] 刀鋒視窗上，按一下 [確定]。

1. 在 [編輯網路介面]**** 刀鋒視窗的 [公用 IP 位址]**** 區段中，按一下 [已啟用]****，然後按一下 [確定]****。

1. 在 [網路]**** 索引標籤中，在 [負載平衡]**** 區段指定以下項目 (其他項目保留預設值)。

    | 設定 | 值 |
    | --- | --- |
    | 負載平衡選項 | **Azure Load Balancer** |
    | 選取負載平衡器 | **建立負載平衡器** |

1. 在 [建立負載平衡器] 頁面上，指定負載平衡器名稱並採用預設設定。 完成時按一下 [建立]，然後前往**下一步：縮放 >** 。

    | 設定 | 值 |
    | --- | --- |
    | 負載平衡器名稱 | `vmss-lb` |

    >**注意：** 暫停一分鐘，並檢閱您完成的工作。 此時，您已使用磁碟和網路設定虛擬機器擴展集。 在網路設定中，您已建立網路安全性群組並允許 HTTP。 您也建立了具有公用 IP 位址的負載平衡器。

1. 在 [調整]**** 索引標籤上，指定下列設定 (將其他設定保留為預設值) 並按一下 **[下一步: 管理 >]**：

    | 設定 | 值 |
    | --- | --- |
    | 初始執行個體計數 | `2` |
    | 調整原則 | **手動** |

1. 在 [管理]**** 索引標籤上，指定下列設定 (將其他設定保留為預設值):

    | 設定 | 值 |
    | --- | --- |
    | 開機診斷 | **停用** |

1. 按一下 [下一步:**健康情況 >]**。

1. 在 [健康情況]**** 索引標籤上，檢閱預設的設定而不進行任何變更，然後按一下 **[下一步: **進階 &gt;]。

1. 在 [進階]**** 索引標籤上，按一下 [檢閱 + 建立]****。

1. 在按一下 [檢閱 + 建立]**** 索引標籤上，確定通過驗證，然後按一下 [建立]****。

    >**注意**：等候虛擬機器擴展集部署完成。 這約需 5 分鐘。 當您等候時，檢閱[文件](https://learn.microsoft.com/azure/virtual-machine-scale-sets/overview)。

## 工作 4：調整 Azure 虛擬機器擴展集

在此工作中，您會使用自訂調整規則來調整虛擬機器擴展集。

1. 選取 [移至資源]**** 或搜尋並選取 [vmss1]**** 擴展集。

1. 請從擴展集視窗左側的功能表中選擇 [調整]****。

>**您知道嗎?** 您可以**手動調整**或**自訂自動調整**。 在具有少量 VM 執行個體的擴展集中，增加或減少執行個體計數 (手動調整) 可能是最佳選擇。 在具有大量 VM 執行個體的擴展集中，根據計量進行調整 (自訂自動調整) 可能更合適。

### 擴增規則

1. 選取 [自訂自動調整]****。 然後，將 [調整模式]**** 變更為 [根據計量調整]****。 然後選取 [新增規則]****。

1. 讓我們建立一個規則，以自動增加 VM 執行個體的數目。 當平均 CPU 負載在 10 分鐘的期間內大於 70% 時，此規則會擴增。 觸發此規則時，VM 執行個體數目會增加 20%。

    | 設定 | 值 |
    | --- | --- |
    | 計量來源 | **目前的資源 (vmss1)** |
    | 計量命名空間 | **虛擬機器主機** |
    | 度量名稱 | **百分比 CPU** (檢閱其他選擇) |
    | 運算子 | **大於** |
    | 用於觸發調整動作的計量閾值 | **70** |
    | 持續時間 (分鐘) | **10** |
    | 時間粒紋統計資料 | **平均** |
    | 作業 | **將百分比增加** (檢閱其他選擇) |
    | 緩和時間 (分鐘) | **5** |
    | 百分比 | **20** |

    ![調整新增規則分頁的螢幕擷取畫面。](../media/az104-lab08-scale-rule.png)

1. 請務必**儲存**您的變更。

### 縮減規則

1. 在晚上或週末，需求可能會減少，因此請務必建立縮減規則。

1. 讓我們建立一個規則，以減少在擴展集中的 VM 執行個體數目。 當平均 CPU 負載在 10 分鐘期間下降低於 30% 時，執行個體數目應該會減少。 觸發此規則時，VM 執行個體的數目會減少 20%。

1. 選取 [新增規則]****，調整設定，然後選取 [新增]****。

    | 設定 | 值 |
    | --- | --- |
    | 運算子 | **小於** |
    | 臨界值 | **30** |
    | 作業 | **將百分比減少** (檢閱其他選擇) |
    | 百分比 | **20** |

1. 請務必**儲存**您的變更。

### 設定執行個體限制

1. 套用自動調整規則時，執行個體限制可確保您不會擴增超出執行個體數目上限，或縮減低於執行個體數目下限。

1. **執行個體限制**顯示在規則之後的 [調整]**** 分頁上。

    | 設定 | 值 |
    | --- | --- |
    | 最小值 | **2** |
    | 最大值 | **10** |
    | 預設 | **2** |

1. 請務必**儲存**您的變更

1. 在 [vmss1]**** 分頁上，選取 [執行個體]****。 這是您要監視虛擬機器執行個體數目的位置。

    >**注意：** 如果您想要使用 Azure PowerShell 建立虛擬機器，請嘗試工作 5。 如果您想要使用 CLI 建立虛擬機器，請嘗試工作 6。

## 工作 5：使用 Azure PowerShell (選項 1) 建立虛擬機器

1. 使用圖示 (右上方) 啟動 **Cloud Shell** 工作階段。 或者，直接瀏覽至 `https://shell.azure.com`。

1. 請務必選取 [PowerShell]****。 如有必要，請設定殼層儲存體。

1. 執行下列命令以建立虛擬機器。 出現提示時，請提供 VM 的使用者名稱和密碼。 在等候期間，請針對所有與建立虛擬機器相關聯的參數，查看 [New-AzVM](https://learn.microsoft.com/powershell/module/az.compute/new-azvm?view=azps-11.1.0) 命令參考。

    ```powershell
    New-AzVm `
    -ResourceGroupName 'az104-rg8' `
    -Name 'myPSVM' `
    -Location 'East US' `
    -Image 'Win2019Datacenter' `
    -Zone '1' `
    -Size 'Standard_D2s_v3' `
    -Credential (Get-Credential)
    ```

1. 命令完成後，請使用 **Get-AzVM** 列出資源群組中的虛擬機器。

    ```powershell
    Get-AzVM `
    -ResourceGroupName 'az104-rg8' `
    -Status
    ```

1. 確認清單上已有您的新虛擬機器，且**狀態**為**執行中**。

1. 使用 **Stop-AzVM** 來解除配置虛擬機器。 鍵入**是**以確認。

    ```powershell
    Stop-AzVM `
    -ResourceGroupName 'az104-rg8' `
    -Name 'myPSVM' 
    ```

1. 使用 **Get-AzVM** 搭配 **-Status** 參數來確認機器**已解除配置**。

    >**您知道嗎?** 當您使用 Azure 停止虛擬機器時，狀態為*解除配置*。 這表示任何非靜態的公用 IP 都已釋出，而且您不再支付 VM 的計算成本。

## 工作 6：使用 CL1 (選項 2) 建立虛擬機器

1. 使用圖示 (右上方) 啟動 **Cloud Shell** 工作階段。 或者，直接瀏覽至 `https://shell.azure.com`。

1. 請務必選取 [Bash]****。 如有必要，請設定殼層儲存體。

1. 執行下列命令以建立虛擬機器。 出現提示時，請提供 VM 的使用者名稱和密碼。 在等候期間，請針對所有與建立虛擬機器相關聯的參數，查看 [az vm create](https://learn.microsoft.com/cli/azure/vm?view=azure-cli-latest#az-vm-create) 命令參考。

    ```sh
    az vm create --name myCLIVM --resource-group az104-rg8 --image Ubuntu2204 --admin-username localadmin --generate-ssh-keys
    ```

1. 命令完成後，請使用 **az vm show** 來確認您的機器是否已建立。

    ```sh
    az vm show --name  myCLIVM --resource-group az104-rg8 --show-details
    ```

1. 確認 **PowerState** 為 **VM 執行中**。

1. 使用 **az vm deallocate** 來解除配置虛擬機器。 鍵入**是**以確認。

    ```sh
    az vm deallocate --resource-group az104-rg8 --name myCLIVM
    ```

1. 使用 **az vm show** 以確定 **powerState** 已被 **VM 解除分配**。

    >**您知道嗎?** 當您使用 Azure 停止虛擬機器時，狀態為*解除配置*。 這表示任何非靜態的公用 IP 都已釋出，而且您不再支付 VM 的計算成本。

## 清除您的資源

如果您使用**自己的訂用帳戶**，請花點時間刪除實驗室資源。 如此可確保釋出資源，並將成本降到最低。 刪除實驗室資源的最簡單方式是刪除實驗室資源群組。 

+ 在 Azure 入口網站中，選取資源群組，選取 [刪除資源群組]****，[輸入資源群組名稱]****，然後按一下 [刪除]****。
+ 使用 Azure PowerShell `Remove-AzResourceGroup -Name resourceGroupName`。
+ 使用 CLI `az group delete --name resourceGroupName`。

## 利用 Copilot 延伸學習
Copilot 可協助您了解如何使用 Azure 指令碼工具。 Copilot 也可在實驗室中未涵蓋的區域或您需要更多資訊的地方提供協助。 開啟 Edge 瀏覽器，然後選擇 [Copilot] (右上方)，或瀏覽至 *copilot.microsoft.com*。 請花幾分鐘的時間嘗試下列提示。

+ 提供建立 Linux 虛擬機器的步驟和 Azure CLI 命令。 
+ 檢閱您可以調整虛擬機器並改善效能的方式。
+ 說明 Azure 儲存體生命週期管理原則，以及如何將成本最佳化。

## 透過自學型訓練深入了解

+ [在 Azure 中建立 Windows 虛擬機器](https://learn.microsoft.com/training/modules/create-windows-virtual-machine-in-azure/)。 使用 Azure 入口網站建立 Windows 虛擬機器。 使用遠端桌面連線到執行中的 Windows 虛擬機器
+ [使用虛擬機器擴展集建置可調整規模的應用程式](https://learn.microsoft.com/training/modules/build-app-with-scale-sets/)。 讓您的應用程式能夠自動調整規模來因應負載的變更，同時將虛擬機器擴展集的成本降到最低。
+ [使用 Azure Bastion 透過 Azure 入口網站連線到虛擬機器](https://learn.microsoft.com/en-us/training/modules/connect-vm-with-azure-bastion/)。 部署 Azure Bastion 以直接在 Azure 入口網站內安全地連線到 Azure 虛擬機器，進而有效地取代現有的 Jumpbox 解決方案、使用診斷記錄監視遠端工作階段，以及透過中斷使用者工作階段的連線來管理遠端工作階段。

## 重要心得

恭喜您完成此實驗室。 以下是此實驗室的主要重點。

+ Azure 虛擬機器為隨選且可調整的運算資源。
+ Azure 虛擬機器同時提供垂直和水平調整選項。
+ 設定 Azure 虛擬機器包括選擇作業系統、大小、儲存體和網路設定。
+ Azure 虛擬機器擴展集可讓您建立和管理一組負載平衡的 VM。
+ 虛擬機器擴展集中的虛擬機器會從相同的映像和設定中建立。
+ 在虛擬機器擴展集中，VM 執行個體的數目可以自動增加或減少，以因應需求或已定義排程。
