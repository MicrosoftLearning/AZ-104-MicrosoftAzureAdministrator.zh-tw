---
lab:
  title: 實驗室 08：管理虛擬機器
  module: Administer Virtual Machines
---

# 實驗室 08 – 管理虛擬機器

## 實驗室簡介

在此實驗室中，您會建立虛擬機並比較虛擬機擴展集。 您將瞭解如何建立、設定及調整單一虛擬機的大小。 您將瞭解如何建立虛擬機擴展集並設定自動調整。

此實驗室需要 Azure 訂用帳戶。 您的訂用帳戶類型可能會影響此實驗室中功能的可用性。 您可以變更區域，但步驟是使用 **美國**東部撰寫。

## 預估時間：50 分鐘

## 實驗案例

您的組織想要探索部署和設定 Azure 虛擬機。 首先，您會使用手動調整來實作 Azure 虛擬機。 接下來，您會實作虛擬機擴展集，並探索自動調整。

## 互動式實驗室模擬

您可能會發現互動式實驗室模擬對本主題很有用。 模擬可讓您以自己的步調點選類似的案例。 互動式模擬和此實驗室之間有差異，但許多核心概念都相同。 不需要 Azure 訂用帳戶。

+ [在入口網站中](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%201)建立虛擬機。 建立虛擬機、連線並安裝 Web 伺服器角色。

+ [使用範本](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%209)部署虛擬機。 探索快速入門資源庫並找出虛擬機範本。 部署範本並驗證部署。

+ [使用 PowerShell](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%2010) 建立虛擬機。 使用 Azure PowerShell 部署虛擬機。 檢閱 Azure Advisor 建議。

+ [使用 CLI](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%2011) 建立虛擬機。 使用 CLI 來部署虛擬機。 檢閱 Azure Advisor 建議。

## 作業技能

+ 工作 1：使用 Azure 入口網站 部署具有區域彈性的 Azure 虛擬機。
+ 工作 2：管理虛擬機的計算和記憶體調整。
+ 工作 3：建立和設定 Azure 虛擬機器擴展集。
+ 工作 4：調整 Azure 虛擬機器擴展集。
+ 工作 5：使用 Azure PowerShell 建立虛擬機（選擇性 1）。
+ 工作 6：使用 CLI 建立虛擬機（選擇性 2）。

## Azure 虛擬機器 架構圖表

![VM 架構工作的圖表。](../media/az104-lab08-vm-architecture.png)

## 工作 1：使用 Azure 入口網站 部署區域復原的 Azure 虛擬機

在這項工作中，您將使用 Azure 入口網站，將兩部 Azure 虛擬機部署到不同的可用性區域。 可用性區域為虛擬機提供最高層級的運行時間 SLA，且為 99.99%。 若要達成此 SLA，您必須在不同的可用性區域中部署至少兩部虛擬機。

1. 登入 Azure 入口網站 - `https://portal.azure.com`

1. 在 [虛擬機 **] 刀鋒視窗上**搜尋並選取 `Virtual machines`，按兩下 **[+ 建立**]，然後在下**拉式清單中選取 [+ Azure 虛擬機**]。 請注意您的其他選擇。

1. 在 [**基本] 索引**標籤標的 [可用性區域 **] 下拉功能表中**，於 [區域 2 **] 旁**放置複選標記。 這應該同時 **選取區域 1** 和 **區域 2**。

    >**注意**：這會在選取的區域部署兩部虛擬機，每個區域中各一部。 您可以達到99.99%運行時間 SLA，因為您至少有兩部 VM 分散到至少兩個區域。 在您可能只需要一部 VM 的情況下，最佳做法是仍將 VM 部署到另一個區域。

1. 在 [基本] 索引標籤上，繼續完成設定：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | Azure 訂用帳戶的名稱 |
    | 資源群組 |  **az104-rg8** （如有必要，請按兩下 [ **新建**] |
    | 虛擬機器名稱 | `az104-vm1` 和 `az104-vm2` （選取這兩個可用性區域之後，請選取 **[VM 名稱] 字段下的 [編輯名稱** ]。 |
    | 區域 | **美國東部** |
    | 可用性選項 | **可用性區域** |
    | 可用性區域 | **區域 1， 2** （閱讀有關使用虛擬機擴展集的注意事項） |
    | 安全性類型 | **標準** |
    | 映像 | **Windows Server 2019 Datacenter - x64 Gen2** |
    | Azure Spot 執行個體 | **unchecked** |
    | 大小 | **標準 D2s v3** |
    | 使用者名稱 | `localadmin` |
    | 密碼 | **提供安全的密碼** |
    | 公用輸入連接埠 | **無** |
    | 您要使用現有的 Windows Server 授權嗎？ | **未選取** |

    ![建立 VM 頁面的螢幕快照。](../media/az104-lab08-create-vm.png)

1. 按 **[下一步]：磁碟>** ，指定下列設定（讓其他人保留預設值）：

    | 設定 | 值 |
    | --- | --- |
    | OS 磁碟類型 | **進階 SSD** |
    | 使用 VM 刪除 | **checked** （預設值） |
    | 启用超级磁盘兼容性 | **未選取** |

1. 按 **[下一步]：網络>** 採用預設值，但未提供負載平衡器。

    | 設定 | 值 |
    | --- | --- |
    | 刪除 VM 時刪除公用 IP 和 NIC | **已選取** |
    | 負載平衡選項 | **None** |


1. 按 **[下一步：管理>** 並指定下列設定（讓其他人保留預設值）：

    | 設定 | 值 |
    | --- | --- |
    | 修補程式協調流程選項 | **Azure 已協調** |  

1. 按 **[下一步：監視>** 並指定下列設定（讓其他人保留預設值）：

    | 設定 | 值 |
    | --- | --- |
    | 開機診斷 | **停用** |

1. 按 **[下一步：進階>**，採用預設值，然後按兩下 [ **檢閱 + 建立**]。

1. 驗證之後，按兩下 [ **建立**]。

    >**注意：** 請注意，當虛擬機部署 NIC、磁碟和公用 IP 位址時，會獨立建立和管理資源。

1. 等候部署完成，然後選取 **[移至資源**]。

   >**注意：** 監視 **通知** 訊息。

## 工作 2：管理虛擬機的計算和記憶體調整

在這項工作中，您會將虛擬機的大小調整為不同的 SKU，以調整虛擬機的大小。 Azure 提供 VM 大小選取的彈性，讓您可以調整 VM 一段時間，如果 VM 需要更多（或更少）的計算和記憶體配置。 此概念延伸至磁碟，您可以在其中修改磁碟的效能，或增加配置的容量。

1. 在 az104-vm1 虛擬機的 **[**可用性 + 調整]** 刀鋒視窗中，選取 [**大小**]。**

1. 將虛擬機大小設定為 **DS1_v2，然後按兩下 [**重設大小****]。 出現提示時，請確認變更。

    >**注意**：如果無法使用**標準 DS1_v2**，請選擇另一個大小。 重設大小也稱為垂直縮放、向上或向下調整。

    ![調整虛擬機大小的螢幕快照。](../media/az104-lab08-resize-vm.png)

1. 在 **[設定**] 區域中，選取 [**磁盘**]。

1. 在 [數據磁碟] 下 **，選取 **[+ 建立] 並連結新的磁碟**。** 設定設定（將其他設定保留為其預設值）。

    | 設定 | 值 |
    | --- | --- |
    | 磁碟名稱 | `vm1-disk1` |
    | 儲存體類型 | **標準 HDD** |
    | 大小 (GiB) | `32` |

1. 按一下 **套用**。

1. 建立磁碟之後，按兩下 [ **中斷連結** ] （如有必要，捲動至右側以檢視卸離圖示），然後按兩下 [ **套用**]。

    >**注意**：中斷連結會從 VM 移除磁碟，但會將其保留在記憶體中以供稍後使用。

1. 搜尋並選取 `Disks`。 從磁碟清單中，選取 **vm1-disk1** 物件。

    >**注意：** [概 **觀]** 刀鋒視窗也會提供磁碟的效能和使用方式資訊。

1. 在 [**設定]** 刀鋒視窗中，選取 [**大小 + 效能**]。

1. 將記憶體類型設定為 **[標準 SSD**]，然後按兩下 [ **儲存**]。

1. 流覽回 **az104-vm1** 虛擬機，然後選取 [ **磁碟**]。

1. 在 [ **數據磁碟** ] 區段中，選取 [ **鏈接現有的磁碟**]。

1. 在 [ **磁碟名稱]** 下拉式清單中，選取 **[VM1-DISK1**]。 

1. 確認磁碟現在是 **標準 SSD**。

1. 選取 [**套用**] 以儲存變更。 

    >**注意：** 您現在已建立虛擬機、調整 SKU 和數據磁碟大小。 在下一個工作中，我們使用 虛擬機器擴展集 將調整程序自動化。

## Azure 虛擬機器擴展集 架構圖表

![vmss 架構工作的圖表。](../media/az104-lab08-vmss-architecture.png)

## 工作 3：建立和設定 Azure 虛擬機器擴展集

在這項工作中，您將跨可用性區域部署 Azure 虛擬機擴展集。 VM 擴展集可讓您設定可讓擴展集水準調整、相應縮小或相應放大的計量或條件，以減少自動化的系統管理額外負荷。

1. 在 Azure 入口網站 中，搜尋並選取 `Virtual machine scale sets` [虛擬機擴展集 **] 刀鋒視窗上的 **[**+ 建立**]。

1. 在 [**建立虛擬機擴展集 **] 刀鋒視窗的 **[基本]** 索引卷標上，指定下列設定（讓其他人保留預設值），然後按 **[下一步：Spot >**：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | Azure 訂用帳戶的名稱  |
    | 資源群組 | **az104-rg8**  |
    | [虛擬機器擴展集名稱] | `vmss1` |
    | 區域 | **(美國) 美國東部** |
    | 可用性區域 | **區域 1、2、3** |
    | 協調流程模式 | **Uniform** |
    | 安全性類型 | **標準** |
    | 映像 | **Windows Server 2019 Datacenter - x64 Gen2** |
    | 使用 Azure 現成 VM 折扣執行 | **未選取** |
    | 大小 | **標準 D2s_v3** |
    | 使用者名稱 | `localadmin` |
    | 密碼 | **提供安全的密碼**  |
    | 已經有 Windows Server 授權了嗎? | **未選取** |

    >**注意**：如需支援將Windows虛擬機器部署至可用性區域的 Azure 區域清單，請參閱[什麼是 Azure 中的可用性區域？](https://docs.microsoft.com/en-us/azure/availability-zones/az-overview)

    ![[建立 vmss] 頁面的螢幕快照。 ](../media/az104-lab08-create-vmss.png)

1. 在 [ **現成]** 索引標籤上，接受預設值，然後選取 **[下一步：磁盘>**]。

1. 在 [ **磁碟** ] 索引標籤上，接受預設值，然後按 **[下一步：網络>**。

1. 在 [**網络]** 頁面上，按兩下 [虛擬網络 **] 文字框下方的 **[**建立虛擬網络**] 連結，並使用下列設定建立新的虛擬網路（讓其他人保留預設值）。  完成後，選取 [確定]****。

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `vmss-vnet` |
    | 位址範圍 | `10.82.0.0/20` （改變那裡的內容） |
    | 子網路名稱 | `subnet0` |
    | 子網路範圍 | `10.82.0.0/24` |

1. 在 [ **網络] 索引** 標籤中，按兩下 **網路介面專案右邊的 [編輯網路介面** ] 圖示。

1. 針對 **[NIC 網络安全組**] 區段，選取 **[進階**]，然後按兩下 [設定網路安全組 **] 下拉式清單下的 **[**新建**]。

1. 在 [建立網路安全性群組] 刀鋒視窗中指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **vmss1-nsg** |

1. 按一下 [新增輸入規則]，並使用下列設定新增輸入安全性規則 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 來源 | **任何** |
    | 來源連接埠範圍 | * |
    | Destination | **任何** |
    | 服務 | **HTTP** |
    | 動作 | **允許** |
    | 優先順序 | **1010** |
    | 名稱 | `allow-http` |

1. 按一下 [新增]，然後在 [建立網路安全性群組] 刀鋒視窗上，按一下 [確定]。

1. 在 [ **編輯網络介面]** 刀鋒視窗的 **[公用IP 位址** ] 區段中，按兩下 **[已啟用]** ，然後按兩下 [ **確定**]。

1. 在 [網络] 索引**標籤的 ****[負載平衡**] 區段底下，指定下列專案（讓其他人保留預設值）。

    | 設定 | 值 |
    | --- | --- |
    | 負載平衡選項 | **Azure Load Balancer** |
    | 選取負載平衡器 | **建立負載平衡器** |

1. 在 [建立負載平衡器] 頁面上，指定負載平衡器名稱並採用預設設定。 完成時按一下 [建立]，然後前往**下一步：縮放 >** 。

    | 設定 | 值 |
    | --- | --- |
    | 負載平衡器名稱 | `vmss-lb` |

    >**注意：** 暫停一分鐘，並檢閱您完成的工作。 此時，您已使用磁碟和網路設定虛擬機擴展集。 在網路設定中，您已建立網路安全組並允許 HTTP。 您也已建立具有公用IP位址的負載平衡器。

1. 在 [ **調整]** 索引標籤上，指定下列設定（讓其他人保留預設值），然後按 **[下一步：管理>**：

    | 設定 | 值 |
    | --- | --- |
    | 初始執行個體計數 | `2` |
    | 調整原則 | **手動** |

1. 在 [ **管理]** 索引標籤上，指定下列設定（讓其他人保留預設值）：

    | 設定 | 值 |
    | --- | --- |
    | 開機診斷 | **停用** |

1. 按 **[下一步：健康情況] >**。

1. 在 [ **健全狀況]** 索引標籤上，檢閱預設設定而不進行任何變更，然後按 **[下一步：進階] >**。

1. 在 [ **進階]** 索引標籤上，按兩下 [ **檢閱 + 建立**]。

1. 在 [ **檢閱 + 建立]** 索引標籤上，確定通過驗證，然後按兩下 [ **建立**]。

    >**注意**：等候虛擬機器擴展集部署完成。 這大約需要 5 分鐘的時間。 當您等候檢閱 [檔](https://learn.microsoft.com/azure/virtual-machine-scale-sets/overview)時。

## 工作 4：調整 Azure 虛擬機器擴展集

在這項工作中，您會使用自定義調整規則來調整虛擬機擴展集。

1. 選取 **[移至資源** ] 或搜尋 ，然後選取 **vmss1** 擴展集。

1. 請從擴展集視窗左側的功能表中選擇 [調整]****。

>**你知道嗎？** 您可以**手動調整或**自訂自動調整****。 在少數 VM 實例的擴展集中，增加或減少實例計數（手動調整）可能最好。 在具有大量 VM 實例的擴展集中，根據計量進行調整（自定義自動調整）可能更合適。

### 相應放大規則

1. 選取 [自訂自動調整]****。 然後，將 [ **調整模式** ] 變更為 **[根據計量**調整]。 然後選取 [ **新增規則**]。

1. 讓我們建立一個規則，以自動增加 VM 實例的數目。 當平均 CPU 負載在 10 分鐘的期間內大於 70% 時，此規則就會相應放大。 觸發此規則時，VM 執行個體數目會增加 20%。

    | 設定 | 值 |
    | --- | --- |
    | 計量來源 | **目前資源 （vmss1）** |
    | 計量命名空間 | **虛擬機器主機** |
    | 度量名稱 | **CPU** 百分比 （檢閱其他選擇） |
    | 運算子 | **大於** |
    | 用於觸發調整動作的計量閾值 | **70** |
    | 持續時間 (分鐘) | **10** |
    | 時間粒紋統計資料 | **平均** |
    | 作業 | **增加百分比 （** 檢閱其他選擇） |
    | 緩和時間 (分鐘) | **5** |
    | 百分比 | **20** |

    ![調整新增規則頁面的螢幕快照。](../media/az104-lab08-scale-rule.png)

1. 請務必**儲存**您的變更。

### 調整規則

1. 在晚上或週末，需求可能會減少，因此請務必建立規則的規模。

1. 讓我們建立一個規則，以減少擴展集中的 VM 實例數目。 當平均 CPU 負載在 10 分鐘期間低於 30% 時，實例數目應該會降低。 觸發此規則時，VM 執行個體的數目會減少 20%。

1. 選取 **[新增規則**]、調整設定，然後選取 [ **新增**]。

    | 設定 | 值 |
    | --- | --- |
    | 運算子 | **小於** |
    | 臨界值 | **30** |
    | 作業 | **減少百分比依據** （檢閱您的其他選擇） |
    | 百分比 | **20** |

1. 請務必**儲存**您的變更。

### 設定實例限制

1. 套用自動調整規則時，實例限制可確保您不會相應放大超過實例數目上限，也不會相應縮小到實例數目下限。

1. **規則之後的 **[調整**] 頁面上會顯示實例限制**。

    | 設定 | 值 |
    | --- | --- |
    | 最小值 | **2** |
    | 最大值 | **10** |
    | 預設 | **2** |

1. 請務必儲存**** 變更

1. 在 **[vmss1]** 頁面上，選取 [ **實例**]。 這是您要監視虛擬機實例數目的位置。

    >**注意：** 如果您有興趣使用 Azure PowerShell 建立虛擬機，請嘗試工作 5。 如果您想要使用 CLI 來建立虛擬機，請嘗試工作 6。

## 工作 5：使用 Azure PowerShell 建立虛擬機（選項 1）

1. 使用圖示 （右上方） 啟動 **Cloud Shell** 工作階段。 或者，直接瀏覽至 `https://shell.azure.com`。

1. 請務必選取 **PowerShell**。 如有必要，請設定殼層記憶體。

1. 執行下列命令以建立虛擬機。 出現提示時，請提供 VM 的使用者名稱和密碼。 當您等候查看 [New-AzVM](https://learn.microsoft.com/powershell/module/az.compute/new-azvm?view=azps-11.1.0) 命令參考，以取得與建立虛擬機相關聯的所有參數。

    ```powershell
    New-AzVm `
    -ResourceGroupName 'az104-rg8' `
    -Name 'myPSVM' `
    -Location 'East US' `
    -Image 'Win2019Datacenter' `
    -Zone '1' `
    -Size 'Standard_D2s_v3' ` 
    -Credential (Get-Credential)
    ```

1. 命令完成後，請使用 **Get-AzVM** 列出資源群組中的虛擬機。

    ```powershell
    Get-AzVM `
    -ResourceGroupName 'az104-rg8' `
    -Status
    ```

1. 確認您的新虛擬機已列出，且 **狀態** 為 **[正在執行**]。

1. 使用 **Stop-AzVM** 解除分配虛擬機。 輸入 **[是** ] 以確認。

    ```powershell
    Stop-AzVM `
    -ResourceGroupName 'az104-rg8' `
    -Name 'myPSVM' 
    ```

1. 使用 **Get-AzVM** 搭配 **-Status** 參數來確認機器已 **解除分配**。

    >**你知道嗎？** 當您使用 Azure 停止虛擬機時，狀態會 *解除*分配。 這表示任何非靜態公用IP都已發行，而您停止支付 VM 的計算成本。

## 工作 6：使用 CLI 建立虛擬機 （選項 2）

1. 使用圖示 （右上方） 啟動 **Cloud Shell** 工作階段。 或者，直接瀏覽至 `https://shell.azure.com`。

1. 請務必選取 **Bash**。 如有必要，請設定殼層記憶體。

1. 執行下列命令以建立虛擬機。 出現提示時，請提供 VM 的使用者名稱和密碼。 當您等候時， [請查看 az vm create](https://learn.microsoft.com/cli/azure/vm?view=azure-cli-latest#az-vm-create) 命令參考，以取得與建立虛擬機相關聯的所有參數。

    ```sh
    az vm create --name myCLIVM --resource-group az104-rg8 --image Ubuntu2204 --admin-username localadmin --generate-ssh-keys
    ```

1. 命令完成之後，請使用 **az vm show** 來確認您的電腦已建立。

    ```sh
    az vm show --name  myCLIVM --resource-group az104-rg8 --show-details
    ```

1. **確認 powerState** 為 **VM 執行**中。

1. 使用 **az vm deallocate** 來解除分配虛擬機。 輸入 **[是** ] 以確認。

    ```sh
    az vm deallocate --resource-group az104-rg8 --name myCLIVM
    ```

1. 使用 **az vm show** 來確保 **powerState** 已 **解除分配** VM。

    >**你知道嗎？** 當您使用 Azure 停止虛擬機時，狀態會 *解除*分配。 這表示任何非靜態公用IP都已發行，而您停止支付 VM 的計算成本。

## 清除您的資源

如果您使用自己的訂用 **帳戶** ，需要一分鐘的時間才能刪除實驗室資源。 這可確保資源可以釋出，並將成本降到最低。 刪除實驗室資源最簡單的方式是刪除實驗室資源群組。 

+ 在 Azure 入口網站 中，選取資源群組、選取 **[刪除資源群組**]、**輸入資源組名**，然後按兩下 [**刪除**]。
+ 使用 Azure PowerShell， `Remove-AzResourceGroup -Name resourceGroupName`。
+ 使用 CLI， `az group delete --name resourceGroupName`。

## 使用 Copilot 擴充學習
Copilot 可協助您瞭解如何使用 Azure 腳本工具。 Copilot 也可以協助實驗室中未涵蓋的區域，或您需要更多資訊的地方。 開啟 Edge 瀏覽器，然後選擇 [Copilot][右上方]，或流覽至 *[copilot.microsoft.com*]。 請花幾分鐘的時間嘗試這些提示。

+ 提供建立Linux虛擬機的步驟和 Azure CLI 命令。 
+ 檢閱您可以調整虛擬機並改善效能的方式。
+ 描述 Azure 記憶體生命週期管理原則，以及如何將成本優化。

## 透過自學型訓練深入了解

+ [在 Azure](https://learn.microsoft.com/training/modules/create-windows-virtual-machine-in-azure/) 中建立 Windows 虛擬機。 使用 Azure 入口網站建立 Windows 虛擬機器。 使用遠端桌面連線到執行中的 Windows 虛擬機器
+ [使用 虛擬機器擴展集 建置可調整](https://learn.microsoft.com/training/modules/build-app-with-scale-sets/)的應用程式。 讓您的應用程式能夠自動調整規模來因應負載的變更，同時將虛擬機器擴展集的成本降到最低。
+ [使用 Azure Bastion 透過 Azure 入口網站連線到虛擬機器](https://learn.microsoft.com/en-us/training/modules/connect-vm-with-azure-bastion/)。 部署 Azure Bastion 以安全地連線到 Azure 入口網站 內的 Azure 虛擬機，以有效取代現有的 Jumpbox 解決方案、使用診斷記錄監視遠端會話，以及中斷使用者會話連線來管理遠端會話。

## 重要心得

恭喜您完成實驗室。 以下是此實驗室的主要外賣。

+ Azure 虛擬機是隨選、可調整的運算資源。
+ Azure 虛擬機同時提供垂直和水平調整選項。
+ 設定 Azure 虛擬機包括選擇作業系統、大小、記憶體和網路設定。
+ Azure 虛擬機器擴展集可讓您建立和管理一組負載平衡的 VM。
+ 虛擬機擴展集中的虛擬機會從相同的映像和組態建立。
+ 在虛擬機擴展集中，VM 實例數目可以自動增加或減少，以回應需求或定義的排程。
