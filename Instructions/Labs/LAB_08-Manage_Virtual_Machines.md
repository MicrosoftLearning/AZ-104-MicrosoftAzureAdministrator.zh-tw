---
lab:
  title: 08 - 管理虛擬機器
  module: Module 08 - Virtual Machines
ms.openlocfilehash: a710fbaf4ea888651012bad592d34667a190c68f
ms.sourcegitcommit: 6df80c7697689bcee3616cdd665da0a38cdce6cb
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/26/2022
ms.locfileid: "146587445"
---
# <a name="lab-08---manage-virtual-machines"></a>實驗室 08 – 管理虛擬機器
# <a name="student-lab-manual"></a>學生實驗室手冊

## <a name="lab-scenario"></a>實驗室案例

您負責識別部署和設定 Azure 虛擬機器的不同選項。 首先，您必須判斷使用 Azure 虛擬機器時可以實作的不同計算和儲存體復原與延展性選項。 接下來，您需要調查使用 Azure 虛擬機器擴展集時可用的計算和儲存體復原和延展性選項。 您也想要針對使用 Azure 虛擬機器自訂指令碼擴充功能，探索自動設定虛擬機器和虛擬機器擴展集的能力。

## <a name="objectives"></a>目標

在此實驗室中，您將會：

+ 工作 1：使用 Azure 入口網站和 Azure Resource Manager 範本部署區域復原的 Azure 虛擬機器
+ 工作 2：使用虛擬機器擴充功能設定 Azure 虛擬機器
+ 工作 3：調整 Azure 虛擬機器的計算和儲存體
+ 工作 4：註冊 Microsoft.Insights 和 Microsoft.AlertsManagement 資源提供者
+ 工作 5：使用 Azure 入口網站部署區域復原 Azure 虛擬機器擴展集
+ 工作 6：使用虛擬機器擴充功能設定 Azure 虛擬機器擴展集
+ 工作 7：調整 Azure 虛擬機器擴展集的計算和儲存體 (選用)

## <a name="estimated-timing-50-minutes"></a>預估時間：50 分鐘

## <a name="architecture-diagram"></a>架構圖

![image](../media/lab08.png)


## <a name="instructions"></a>指示

### <a name="exercise-1"></a>練習 1

#### <a name="task-1-deploy-zone-resilient-azure-virtual-machines-by-using-the-azure-portal-and-an-azure-resource-manager-template"></a>工作 1：使用 Azure 入口網站和 Azure Resource Manager 範本部署區域復原的 Azure 虛擬機器

在這項工作中，您將使用 Azure 入口網站和 Azure Resource Manager 範本，將 Azure 虛擬機器部署到不同的可用性區域。

1. 登入 [Azure 入口網站](http://portal.azure.com)。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬機器]，然後在 [虛擬機器] 刀鋒視窗中，按一下 [+ 建立]，然後再按一下 [+ Azure 虛擬機器]。

1. 在 [建立虛擬機器] 刀鋒視窗的 [基本] 索引標籤上，指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | 新資源群組 **az104-08-rg01** 的名稱 |
    | 虛擬機器名稱 | **az104-08-vm0** |
    | 區域 | 選取其中一個支援可用性區域的區域，以及您可以在其中佈建 Azure 虛擬機器的區域 |
    | 可用性選項 | **可用性區域** |
    | 可用性區域 | **區域 1** |
    | 映像 | **Windows Server 2019 Datacenter - Gen1/Gen2** |
    | Azure Spot 執行個體 | **否** |
    | 大小 | **標準 D2s v3** |
    | 使用者名稱 | **Student** |
    | 密碼 | **提供安全的密碼** |
    | 公用輸入連接埠 | **無** |
    | 您要使用現有的 Windows Server 授權嗎？ | **未選取** |

1. 按一下 [下一步：**磁碟 >]** ，在 [建立虛擬機器] 刀鋒視窗的 [磁碟] 索引標籤上，指定下列設定 (其他設定請保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | OS 磁碟類型 | **進階 SSD** |
    | 启用超级磁盘兼容性 | **未選取** |

1. 按一下 [下一步：**網路 >]** ，在 [建立虛擬機器] 刀鋒視窗的 [網路] 索引標籤上，按一下 [虛擬網路] 文字方塊下方的 [新建]。

1. 在 [建立虛擬網路] 刀鋒視窗中指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-08-rg01-vnet** |
    | 位址範圍 | **10.80.0.0/20** |
    | 子網路名稱 | **subnet0** |
    | 子網路範圍 | **10.80.0.0/24** |

1. 按一下 [確定]，在 [建立虛擬機器] 刀鋒視窗的 [網路] 索引標籤上，指定下列設定 (其他設定請保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 子網路 | **subnet0** |
    | 公用 IP | **預設值** |
    | NIC 網路安全性群組 | **basic** |
    | 公用輸入連接埠 | **無** |
    | 加速網路 | **關閉**
    | 要將此虛擬機器放在現有負載平衡解決方案後面嗎? | **未選取** |

1. 按一下 [下一步：**管理 >]** ，然後在 [建立虛擬機器] 刀鋒視窗的 [管理] 索引標籤上，指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 開機診斷 | **啟用自訂儲存體帳戶** |
    | 診斷儲存體帳戶 | 接受預設值 |
    | 修補程式協調流程選項 | **手動更新** |  

    >**注意**：如有必要，請在下拉式清單中選取現有的儲存體帳戶，或建立新的儲存體帳戶。 記錄儲存體帳戶的名稱。 您將在下一個工作中使用該名稱。

1. 按一下 [下一步：**進階 >]** ，在 [建立虛擬機器] 刀鋒視窗的 [進階] 索引標籤上，檢閱可用的設定而不修改其中任何設定，然後按一下 [檢閱 + 建立]。

1. 在 [檢閱 + 建立] 刀鋒視窗上，按一下 [建立]。

1. 在 [部署] 刀鋒視窗上，按一下 [範本]。

1. 檢閱代表進行中部署的範本，然後按一下 [部署]。

    >**注意**：您將使用此選項來部署具有相符設定的第二部虛擬機器，但可用性區域除外。

1. 在 [自訂部署] 刀鋒視窗上，指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 資源群組 | **az104-08-rg01** |
    | 網路介面名稱 | **az104-08-vm1-nic1** |
    | 公用 IP 位址 | **az104-08-vm1-ip** |
    | 虛擬機器名稱、虛擬機器名稱 1、虛擬機器電腦名稱   | **az104-08-vm1** |
    | 虛擬機器 RG | **az104-08-rg01** |    
    | 管理員使用者名稱 | **Student** |
    | 管理員密碼 | **提供安全的密碼**  |
    | 啟用熱修補 | **false** |
    | 區域 | **2** |

    >**注意**：您必須使用範本修改對應至所部署的不同資源屬性參數，包括虛擬機器及其網路介面。

1. 按一下 [檢閱 + 建立]，然後在 [檢閱 + 建立] 刀鋒視窗上按一下 [建立]。

    >**注意**：等候這兩個部署完成，再繼續進行下一項工作。 這大約需要 5 分鐘的時間。

#### <a name="task-2-configure-azure-virtual-machines-by-using-virtual-machine-extensions"></a>工作 2：使用虛擬機器擴充功能設定 Azure 虛擬機器

在這項工作中，您將使用自訂指令碼虛擬機器擴充功能，在您於上一個工作中部署的兩部 Azure 虛擬機器上安裝 Windows Server Web Server 角色。

1. 在Azure 入口網站中，搜尋並選取 [儲存體帳戶]，然後在 [儲存體帳戶] 刀鋒視窗上，按一下代表您在上一個工作中建立的診斷儲存體帳戶的專案。

1. 在儲存體帳戶刀鋒視窗的 [資料儲存體] 區段中，按一下 [容器]，然後按一下 [+ 容器]。

1. 在 [新增容器] 刀鋒視窗上，指定下列設定 (將其他設定保留為預設值)，然後選取 [建立]：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **指令碼** |
    | 公用存取層級 | **私人 (無匿名存取**) |

1. 回到顯示容器清單的儲存體帳戶刀鋒視窗上，按一下 [指令碼]。

1. 在 [指令碼] 刀鋒視窗上，按一下 [上傳]。

1. 在 [上傳 Blob] 刀鋒視窗上，按一下資料夾圖示，在 [開啟] 對話方塊中，瀏覽至 **\\Allfiles\\Labs\\08** 資料夾，選取 [az104-08-install_IIS.ps1]，按一下 [開啟]，然後回到 [上傳 Blob] 刀鋒視窗上，按一下 [上傳]。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬機器]，然後在 [虛擬機器] 刀鋒視窗中，按一下 [az104-08-vm0]。

1. 在 **az104-08-vm0** 虛擬機器刀鋒視窗的 [設定] 區段中，按一下 [擴充功能 + 應用程式]，然後按一下 [+ 新增]。

1. 在 [安裝擴充功能] 刀鋒視窗上，按一下 [自訂指令碼擴充功能]，然後按 [下一步]。

1. 從 [設定自訂指令碼擴充功能] 刀鋒視窗中，按一下 [瀏覽]。

1. 在 [儲存體帳戶] 刀鋒視窗上，按一下您上傳 **az104-08-install_IIS.ps1** 指令碼的儲存體帳戶名稱，在 [容器] 刀鋒視窗上，按一下 [指令碼]，在 [指令碼]  刀鋒視窗上按一下 [az104-08-install_IIS.ps1]，然後按一下 [選取]。

1. 回到 [安裝擴充功能] 刀鋒視窗，按一下 [檢閱 + 建立]，然後在 [檢閱 + 建立] 刀鋒視窗上按一下 [建立]。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬機器]，然後在 [虛擬機器] 刀鋒視窗中，按一下 [az104-08-vm1]。

1. 在 **az104-08-vm1** 刀鋒視窗的 [自動化] 區段中，按一下 [匯出範本]。

1. 在 [az104-08-vm1 - 匯出範本] 刀鋒視窗上，按一下 [部署]。

1. 在 [自訂部署] 刀鋒視窗上，按一下 [編輯範本]。

    >**注意**：請忽略訊息 **範本中的一或多個資源不支援資源群組所處的位置。請選擇不同的資源群組**。 這是預料中的狀況，在此案例中可忽略。

1. 在 [編輯範本] 刀鋒視窗的區段中，於顯示範本內容的區段中，插入下列程式碼，開頭為行 **20** (直接在 `"resources": [` 行下方)：

   >**注意**：如果您使用以 Intellisense 逐行貼上程式碼的工具，則可能會新增額外的方括弧，造成驗證錯誤。 您可能會想要先將程式碼貼到記事本，然後再將其貼到第 20 行。

   ```json
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "az104-08-vm1/customScriptExtension",
            "apiVersion": "2018-06-01",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "az104-08-vm1"
            ],
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.7",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "commandToExecute": "powershell.exe Install-WindowsFeature -name Web-Server -IncludeManagementTools && powershell.exe remove-item 'C:\\inetpub\\wwwroot\\iisstart.htm' && powershell.exe Add-Content -Path 'C:\\inetpub\\wwwroot\\iisstart.htm' -Value $('Hello World from ' + $env:computername)"
              }
            }
        },

   ```

   >**注意**：此範本的這個區段會定義您稍早透過 Azure PowerShell 部署至第一部虛擬機器的相同 Azure 虛擬機器自訂指令碼擴充功能。

1. 按一下 [儲存]，回到 [自訂範本] 刀鋒視窗，按一下 [檢閱 + 建立]，然後在 [檢閱 + 建立] 刀鋒視窗上，按一下 [建立]

    >**注意**：等待範本部署完成。 您可以從 **az104-08-vm0** 和 **az104-08-vm1** 虛擬機器的 [擴充功能] 刀鋒視窗監視其進度。 這應該不會超過 3 分鐘。

1. 若要確認自訂指令碼擴充功能型設定成功，請瀏覽回到 **az104-08-vm1** 刀鋒視窗的 [作業] 區段中，按一下 [執行命令]，然後在命令清單中，按一下 [RunPowerShellScript]。

1. 在 [執行命令指令碼] 刀鋒視窗上，輸入下列命令，然後按一下 [執行] 以存取 **az104-08-vm0** 上裝載的網站：

   ```powershell
   Invoke-WebRequest -URI http://10.80.0.4 -UseBasicParsing
   ```

    >**注意**：必須有 **-UseBasicParsing** 參數，才能消除 Internet Explorer 的相依性，以完成 Cmdlet 的執行

    >**注意**：您也可以連線到 **az104-08-vm0** 並執行 `Invoke-WebRequest -URI http://10.80.0.5 -UseBasicParsing` 以存取裝載於 **az104-08-vm1** 的網站。

#### <a name="task-3-scale-compute-and-storage-for-azure-virtual-machines"></a>工作 3：調整 Azure 虛擬機器的計算和儲存體

在此工作中，您將藉由變更其大小並設定其資料磁碟來調整 Azure 虛擬機器的計算，並調整其儲存體。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬機器]，然後在 [虛擬機器] 刀鋒視窗中，按一下 [az104-08-vm0]。

1. 在 **az104-08-vm0** 虛擬機器刀鋒視窗上，按一下 [大小] 並將虛擬機器大小設定為 [標準DS1_v2]，然後按一下 [調整大小]

    >**注意**：如果無法使用 **標準 DS1_v2**，請選擇另一個大小。

1. 在 **az104-08-vm0** 虛擬機器刀鋒視窗上，按一下 [磁碟]，在 [資料磁碟] 底下按一下 [+ 建立並連結新的磁碟]。

1. 使用下列設定建立受控磁碟 (將其他設定保持預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 磁碟名稱 | **az104-08-vm0-datadisk-0** |
    | 儲存體類型 | **進階 SSD** |
    | 大小 (GiB| **1024** |

1. 回到 [az104-08-vm0 - 磁碟] 刀鋒視窗，在 [資料磁碟] 下，按一下 [+ 建立並連結新的磁碟]。

1. 使用下列設定建立受控磁碟 (將其他設定保持預設值) 並儲存變更：

    | 設定 | 值 |
    | --- | --- |
    | 磁碟名稱 | **az104-08-vm0-datadisk-1** |
    | 儲存體類型 | **進階 SSD** |
    | 大小 (GiB)| **1024 GiB** |

1. 回到 [az104-08-vm0 - 磁碟] 刀鋒視窗，按一下 [儲存]。

1. 在 [az104-08-vm0] 刀鋒視窗的 [作業] 區段中，按一下 [執行命令]，接著在命令清單中，按一下 [RunPowerShellScript]。

1. 在 [執行命令指令碼] 刀鋒視窗上，輸入下列命令，然後按一下 [執行] 以建立磁碟機 Z：包含兩個具有簡單配置和固定佈建的新連結磁碟：

   ```powershell
   New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

   New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

   Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

   New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
   ```

    > **注意**：等候確認命令已成功完成。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬機器]，然後在 [虛擬機器] 刀鋒視窗中，按一下 [az104-08-vm1]。

1. 在 **az104-08-vm1** 刀鋒視窗的 [自動化] 區段中，按一下 [匯出範本]。

1. 在 [az104-08-vm1 - 匯出範本] 刀鋒視窗上，按一下 [部署]。

1. 在 [自訂部署] 刀鋒視窗上，按一下 [編輯範本]。

    >**注意**：請忽略訊息 **範本中的一或多個資源不支援資源群組所處的位置。請選擇不同的資源群組**。 這是預料中的狀況，在此案例中可忽略。

1. 在 [編輯範本] 刀鋒視窗上，於顯示範本內容的區段中，以下列這一行取代第 **30** 行 `"vmSize": "Standard_D2s_v3"`) ：

   ```json
                    "vmSize": "Standard_DS1_v2"

   ```

    >**注意**：此範本區段會定義與您透過 Azure 入口網站為第一部虛擬機器指定的相同 Azure 虛擬機器大小。

1. 在 [編輯範本] 刀鋒視窗上，於顯示範本內容的區段中，以下列程式碼取代第 **51** 行 (第 `"dataDisks": [ ]` 行)：

   ```json
                    "dataDisks": [
                      {
                        "lun": 0,
                        "name": "az104-08-vm1-datadisk0",
                        "diskSizeGB": "1024",
                        "caching": "ReadOnly",
                        "createOption": "Empty"
                      },
                      {
                        "lun": 1,
                        "name": "az104-08-vm1-datadisk1",
                        "diskSizeGB": "1024",
                        "caching": "ReadOnly",
                        "createOption": "Empty"
                      }
                    ]
   ```

    >**注意**：如果您使用以 Intellisense 逐行貼上程式碼的工具，則可能會新增額外的方括弧，造成驗證錯誤。 您可能會想要先將程式碼貼到記事本，然後再將其貼到第 49 行。

    >**注意**：此範本的這個區段會建立兩個受控磁碟，並將其連結至 **az104-08-vm1**，類似於透過 Azure 入口網站的第一個虛擬機器的儲存體組態。


1. 按一下 [儲存]，回到 [自訂部署] 刀鋒視窗，按一下 [檢閱 + 建立]，然後在 [檢閱 + 建立] 刀鋒視窗上，按一下 [建立]

    >**注意**：等待範本部署完成。 您可以從 **az104-08-vm1** 虛擬機器的 [磁碟] 刀鋒視窗監視其進度。 這應該不會超過 3 分鐘。

1. 回到 [az104-08-vm1] 刀鋒視窗的 [作業] 區段中，按一下 [執行命令]，接著在命令清單中，按一下 [RunPowerShellScript]。

1. 在 [執行命令指令碼] 刀鋒視窗上，輸入下列命令，然後按一下 [執行] 以建立磁碟機 Z：包含兩個具有簡單配置和固定佈建的新連結磁碟：

   ```powershell
   New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

   New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

   Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

   New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
   ```

    > **注意**：等候確認命令已成功完成。

#### <a name="task-4-register-the-microsoftinsights-and-microsoftalertsmanagement-resource-providers"></a>工作 4：註冊 Microsoft.Insights 和 Microsoft.AlertsManagement 資源提供者

1. 在 Azure 入口網站中，按一下 Azure 入口網站右上角的圖示，開啟 **Azure Cloud Shell**。

1. 當系統提示您選取 [Bash] 或 [PowerShell] 時，請選取 [PowerShell]。

    >**注意**：如果這是您第一次啟動 **Cloud Shell**，而且出現 **您未掛接任何儲存體** 訊息，請選取您在此實驗室中使用的訂用帳戶，並按一下 [建立儲存體]。

1. 從 [Cloud Shell] 窗格中，執行下列命令來註冊 Microsoft.Insights 和 Microsoft.AlertsManagement 資源提供者。

   ```powershell
   Register-AzResourceProvider -ProviderNamespace Microsoft.Insights

   Register-AzResourceProvider -ProviderNamespace Microsoft.AlertsManagement
   ```

#### <a name="task-5-deploy-zone-resilient-azure-virtual-machine-scale-sets-by-using-the-azure-portal"></a>工作 5：使用 Azure 入口網站部署區域復原 Azure 虛擬機器擴展集

在此工作中，您將使用 Azure 入口網站，跨可用性區域部署 Azure 虛擬機器擴展集。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬機器擴展集]，然後在 [虛擬機器擴展集] 刀鋒視窗上，按一下 [+ 新增] (或 [+ 建立])。

1. 在 建立虛擬機器擴展集 刀鋒視窗的 基本 索引標籤上指定下列設定 (其他設定請保留預設值)，然後按一下 下一步：**磁碟 >** ：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | 新資源群組 **az104-08-rg02** 的名稱 |
    | 虛擬機器擴展集名稱 | **az10408vmss0** |
    | 區域 | 選取其中一個支援可用性區域的區域，您可以在其中佈建不同於您稍早在此實驗室中用來部署虛擬機器的 Azure 虛擬機器 |
    | 可用性區域 | **區域 1、2、3** |
    | 映像 | **Windows Server 2019 Datacenter - Gen 2** |
    | Azure Spot 執行個體 | **否** |
    | 大小 | **標準 D2s_v3** |
    | 使用者名稱 | **Student** |
    | 密碼 | **提供安全的密碼**  |
    | 已經有 Windows Server 授權了嗎? | **未選取** |

    >**注意**：如需支援將Windows虛擬機器部署至可用性區域的 Azure 區域清單，請參閱 [什麼是 Azure 中的可用性區域？](https://docs.microsoft.com/en-us/azure/availability-zones/az-overview)

1. 在 [建立虛擬機器擴展集] 刀鋒視窗的 [磁碟] 索引標籤上，接受預設值，然後按 **[下一步：網路 >]** 。

1. 在 [建立虛擬機器擴展集] 刀鋒視窗的 [網路] 索引標籤上，按一下 [虛擬網路] 文字方塊下方的 [建立虛擬網路] 連結，並使用下列設定建立新的虛擬網路 (其他設定請保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az104-08-rg02-vnet** |
    | 位址範圍 | **10.82.0.0/20** |
    | 子網路名稱 | **subnet0** |
    | 子網路範圍 | **10.82.0.0/24** |

    >**注意**：建立新的虛擬網路並返回 [建立虛擬機器擴展集] 刀鋒視窗的 [網路] 索引標籤後，**虛擬網路** 值會自動設定為 **az104-08-rg02-vnet**。

1. 回到 [建立虛擬機器擴展集] 刀鋒視窗的 [網路] 索引標籤，按一下網路介面項目右側的 [編輯網路介面] 圖示。

1. 在 [編輯網路介面] 刀鋒視窗的 [NIC 網路安全性群組] 區段中，按一下 [進階]，然後按一下 [設定網路安全性群組] 下拉式清單底下的 [新建]。

1. 在 [建立網路安全性群組] 刀鋒視窗中指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **az10408vmss0-nsg** |

1. 按一下 [新增輸入規則]，並使用下列設定新增輸入安全性規則 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 來源 | **任何** |
    | 來源連接埠範圍 | **\*** |
    | Destination | **任何** |
    | 目的地連接埠範圍 | **80** |
    | 通訊協定 | **TCP** |
    | 動作 | **允許** |
    | 優先順序 | **1010** |
    | 名稱 | **custom-allow-http** |

1. 按一下 [新增]，然後在 [建立網路安全性群組] 刀鋒視窗上，按一下 [確定]。

1. 回到 [編輯網路介面] 刀鋒視窗的 [公用 IP 位址] 區段中，按一下 [已啟用]，然後按一下 [確定]。

1. 回到 [建立虛擬機器擴展集] 刀鋒視窗的 [網路] 索引標籤上，在 [負載平衡] 區段底下，確定已選取 [使用負載平衡器] 專案，並指定下列 [負載平衡設定] (將其他設定保留為預設值)，然後按一下 [**下一步：調整 >]** ：

    | 設定 | 值 |
    | --- | --- |
    | 負載平衡選項 | **Azure Load Balancer** |
    | 選取負載平衡器 | **(新) az10408vmss0-lb** |
    | 選取後端集區 | **(新) bepool** |

1. 在 [建立虛擬機器擴展集] 刀鋒視窗的 [調整] 索引標籤上指定下列設定 (其他設定請保留預設值)，然後按一下 [下一步：**管理 >]** ：

    | 設定 | 值 |
    | --- | --- |
    | 初始執行個體計數 | **2** |
    | 調整原則 | **手動** |

1. 在 [建立虛擬機器擴展集] 刀鋒視窗的 [管理] 索引標籤上，指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 開機診斷 | **啟用自訂儲存體帳戶** |
    | 診斷儲存體帳戶 | 接受預設值 |

    >**注意**：在下一個工作中，您將需要此儲存體帳戶的名稱。

   按一下 [下一步:**健全狀況 >]** :

1. 在 [建立虛擬機器擴展集] 刀鋒視窗的 [健全狀況] 索引標籤上，檢閱預設設定而不進行任何變更，然後按一下 **[下一步：** 進階 &gt;]。

1. 在 [建立虛擬機器擴展集] 刀鋒視窗的 [進階] 索引標籤上指定下列設定 (其他設定請保留預設值)，然後按一下 [檢閱 + 建立]。

    | 設定 | 值 |
    | --- | --- |
    | 擴張演算法 | **固定擴張 (不建議對區域使用)** |

    >**注意**：[最大分配] 設定目前無法運作。

1. 在 [建立虛擬機器擴展集] 刀鋒視窗的 [檢閱 + 建立] 索引標籤上，確定通過驗證，然後按一下 [建立]。

    >**注意**：等候虛擬機器擴展集部署完成。 這應該大約需要 5 分鐘的時間。

#### <a name="task-6-configure-azure-virtual-machine-scale-sets-by-using-virtual-machine-extensions"></a>工作 6：使用虛擬機器擴充功能設定 Azure 虛擬機器擴展集

在這項工作中，您將使用自訂指令碼虛擬機器擴充功能，在您於上一個工作中部署的 Azure 虛擬機器擴展集上安裝 Windows Server Web Server 角色。

1. 在Azure 入口網站中，搜尋並選取 [儲存體帳戶]，然後在 [儲存體帳戶] 刀鋒視窗上，按一下代表您在上一個工作中建立的診斷儲存體帳戶的專案。

1. 在儲存體帳戶刀鋒視窗的 [資料儲存體] 區段中，按一下 [容器]，然後按一下 [+ 容器]。

1. 在 [新增容器] 刀鋒視窗上，指定下列設定 (將其他設定保留為預設值)，然後選取 [建立]：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **指令碼** |
    | 公用存取層級 | **私人 (無匿名存取**) |

1. 回到顯示容器清單的儲存體帳戶刀鋒視窗上，按一下 [指令碼]。

1. 在 [指令碼] 刀鋒視窗上，按一下 [上傳]。

1. 在 [上傳 Blob] 刀鋒視窗上，按一下資料夾圖示，在 [開啟] 對話方塊中，瀏覽至 **\\Allfiles\\Labs\\08** 資料夾，選取 [az104-08-install_IIS.ps1]，按一下 [開啟]，然後回到 [上傳 Blob] 刀鋒視窗上，按一下 [上傳]。

1. 在 Azure 入口網站中，瀏覽回到 [虛擬機器擴展集] 刀鋒視窗，然後按一下 [az10408vmss0]。

1. 在 **az10408vmss0** 刀鋒視窗的 [設定] 區段中，按一下 [擴充功能]，然後按一下 [+ 新增]。

1. 在 [新增資源] 刀鋒視窗上，按一下 [自訂指令碼擴充功能]，然後按 [下一步]。

1. 從 [安裝擴充功能] 刀鋒視窗中，**瀏覽** 至並 **選取** 此工作稍早上傳到儲存體帳戶中 **指令碼** 容器的 **az104-08-install_IIS.ps1** 指令碼，然後按一下 [建立]。

    >**注意**：等候擴充功能的安裝完成，再繼續進行下一個步驟。

1. 在 **az10408vmss0** 刀鋒視窗的 [設定] 區段中，按一下 [執行個體]，選取虛擬機器擴展集兩個執行個體旁的核取方塊，按一下 [升級]，然後在系統提示您確認時，按一下 [是]。

    >**注意**：等候升級完成，再繼續進行下一個步驟。

1. 在 Azure 入口網站中，搜尋並選取 [負載平衡器]，然後在負載平衡器清單中，按一下 [az10408vmss0-lb]。

1. 在 **az10408vmss0-lb** 刀鋒視窗上，記下指派給負載平衡器前端的 [公用 IP 位址] 值，開啟新的瀏覽器索引標籤，然後瀏覽至該 IP 位址。

    >**注意**：確認瀏覽器頁面會顯示其中一個 Azure 虛擬機器擴展集 **az10408vmss0** 執行個體的名稱。

#### <a name="task-7-scale-compute-and-storage-for-azure-virtual-machine-scale-sets"></a>工作 7：調整 Azure 虛擬機器擴展集的計算和儲存體

在此工作中，您將變更虛擬機器擴展集執行個體的大小、設定其自動調整設定，以及將磁碟連結至這些執行個體。

1. 在 Azure 入口網站中，搜尋並選取 [虛擬機器擴展集]，然後選取 **az10408vmss0** 擴展集

1. 在 **az10408vmss0** 刀鋒視窗中，按一下 [設定] 區段中的 [大小]。

1. 在可用大小清單中，選取 [標準 DS1_v2] 然後按一下 [調整大小]。

1. 在 [設定] 區段中，按一下 [執行個體]，選取虛擬機器擴展集兩個執行個體旁的核取方塊，按一下 [升級]，然後在系統提示您確認時按一下 [是]。

1. 在執行個體清單中，按一下代表第一個執行個體的專案，然後在擴展集執行個體刀鋒視窗上記下其 [位置] (應該位於您在其中部署 Azure 虛擬機器擴展集的目標 Azure 區域中的其中一個區域)。

1. 返回 [az10408vmss0 - 執行個體] 刀鋒視窗，按一下代表第二個執行個體的項目，然後在擴展集執行個體刀鋒視窗上記下其 [位置] (應該位於您在其中部署 Azure 虛擬機器擴展集的目標 Azure 區域中的另外兩個區域)。

1. 返回 [az10408vmss0 - 執行個體]刀鋒視窗，然後在 [設定] 區段中，按一下 [調整]。

1. 在 [az10408vmss0 - 調整] 刀鋒視窗上，選取 [自訂自動調整] 選項，並使用下列設定來設定自動調整 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- |--- |
    | 調整模式 | **根據計量進行調整** |

1. 按一下 [+ 新增規則] 連結，並在 [調整規則] 刀鋒視窗上，指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- |--- |
    | 計量來源 | **目前資源 (az10480vmss0)** |
    | 時間彙總 | **平均** |
    | 計量命名空間 | **虛擬機器主機** |
    | 度量名稱 | **網路流入量總計** |
    | 運算子 | **大於** |
    | 用於觸發調整動作的計量閾值 | **10** |
    | 持續時間 (分鐘) | **1** |
    | 時間粒紋統計資料 | **平均** |
    | 作業 | **將計數增加** |
    | 執行個體計數 | **1** |
    | 緩和時間 (分鐘) | **5** |

    >**注意**：很明顯地，這些值並不代表實際設定，因為其目的是要儘快觸發自動調整，而不延長等候期間。

1. 按一下 [新增]，回到 [az10408vmss0 - 調整] 刀鋒視窗上，指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- |--- |
    | 執行個體最小值限制 | **1** |
    | 執行個體最大值限制 | **3** |
    | 執行個體預設值限制 | **1** |

1. 按一下 [檔案] 。

1. 在 Azure 入口網站中，按一下 Azure 入口網站右上角的圖示，開啟 **Azure Cloud Shell**。

1. 當系統提示您選取 [Bash] 或 [PowerShell] 時，請選取 [PowerShell]。

1. 從 [Cloud Shell] 窗格中，執行下列命令來識別 Azure 虛擬機器擴展集 **az10408vmss0** 前負載平衡器的公用 IP 位址。

   ```powershell
   $rgName = 'az104-08-rg02'

   $lbpipName = 'az10408vmss0-ip'

   $pip = (Get-AzPublicIpAddress -ResourceGroupName $rgName -Name $lbpipName).IpAddress
   ```

1. 從 [Cloud Shell] 窗格中，執行下列命令以啟動無限迴圈，以將 HTTP 要求傳送至裝載在 Azure 虛擬機器擴展集 **az10408vmss0** 執行個體上的網站。

   ```powershell
   while ($true) { Invoke-WebRequest -Uri "http://$pip" }
   ```

1. 將 [Cloud Shell] 窗格最小化但不關閉，切換回 [az10408vmss0 - 執行個體] 刀鋒視窗，並監視執行個體數目。

    >**注意**：您可能需要等候幾分鐘，接著按一下 [重新整理]。

1. 佈建第三個執行個體之後，瀏覽至其刀鋒視窗來判斷其 **位置** (應該與您稍早在此工作中識別的前兩個區域不同。

1. 關閉 Cloud Shell 窗格。

1. 在 **az10408vmss0** 刀鋒視窗的 [設定] 區段中，按一下 [磁碟]，按一下 [+ 建立並連結新的磁碟]，並使用下列設定連結新的受控磁碟 (將其他設定保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | LUN | **0** |
    | 儲存體類型 | **標準 HDD** |
    | 大小 (GiB) | **32** |

1. 儲存變更，在 **az10408vmss0** 刀鋒視窗的 [設定] 區段中，按一下 [執行個體]，選取虛擬機器擴展集執行個體旁的核取方塊，按一下 [升級]，然後在系統提示您確認時，按一下 [是]。

    >**注意**：上一個步驟中連結的磁碟是原始磁碟。 使用之前，必須先建立分割區、建立檔案系統，然後掛接。 為了達成此目的，您將使用 Azure 虛擬機器自訂指令碼擴充功能。 首先，您必須移除現有的自訂指令碼擴充功能。

1. 在 **az10408vmss0** 刀鋒視窗的 [設定] 區段中，按一下 [擴充功能]，按一下 [CustomScriptExtension]，然後按一下 [卸載]。

    >**注意**：請等候解除安裝完成。

1. 在 Azure 入口網站中，按一下 Azure 入口網站右上角的圖示，開啟 **Azure Cloud Shell**。

1. 當系統提示您選取 [Bash] 或 [PowerShell] 時，請選取 [PowerShell]。

1. 在 [Cloud Shell] 窗格的工具列中，按一下 [上傳/下載檔案] 圖示，在下拉式功能表中，按一下 [上傳]，並將檔案 **\\Allfiles\\Labs\\08\\az104-08-configure_VMSS_disks.ps1** 上傳至 Cloud Shell 主目錄。

1. 從 [Cloud Shell] 窗格中，執行下列命令以顯示指令碼的內容：

   ```powershell
   Set-Location -Path $HOME

   Get-Content -Path ./az104-08-configure_VMSS_disks.ps1
   ```

    >**注意**：指令碼會安裝可設定連結磁碟的自訂指令碼擴充功能。

1. 從 [Cloud Shell] 窗格中，執行下列命令以執行指令碼並設定 Azure 虛擬機器擴展集的磁碟：

   ```powershell
   ./az104-08-configure_VMSS_disks.ps1
   ```

1. 關閉 [Cloud Shell] 窗格。

1. 在 **az10408vmss0** 刀鋒視窗的 [設定] 區段中，按一下 [執行個體]，選取虛擬機器擴展集執行個體旁的核取方塊，按一下 [升級]，然後在系統提示您確認時，按一下 [是]。

#### <a name="clean-up-resources"></a>清除資源

>**注意**：請記得移除您不再使用的任何新建立的 Azure 資源。 移除未使用的資源可確保您不會看到非預期的費用。

>**注意**：如果無法立即移除實驗室資源，請不要擔心。 有時候資源具有相依性，需要經過較長的時間才能刪除。 這是監視資源使用量的常見系統管理員工作，因此只需定期檢閱入口網站中的資源，查看清除的運作情況便可。 
1. 在 Azure 入口網站中，在 [Cloud Shell] 窗格內開啟 [PowerShell] 工作階段。

1. 執行下列命令，移除 az104-08-configure_VMSS_disks.ps1：

   ```powershell
   rm ~\az104-08*
   ```

1. 執行下列命令，列出在本課程模組的任何實驗室中建立的所有資源群組：

   ```powershell
   Get-AzResourceGroup -Name 'az104-08*'
   ```

1. 執行下列命令，刪除您在本課程模組的任何實驗室中建立的所有資源群組：

   ```powershell
   Get-AzResourceGroup -Name 'az104-08*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注意**：此命令以非同步方式執行 (由 --AsJob 參數決定)，所以您隨後能夠在相同 PowerShell 工作階段內立即執行另一個 PowerShell 命令，但需要經過幾分鐘後，才會實際移除資源群組。

#### <a name="review"></a>檢閱

在此實驗室中，您已：

+ 使用 Azure 入口網站和 Azure Resource Manager 範本部署區域復原的 Azure 虛擬機器
+ 使用虛擬機器擴充功能設定 Azure 虛擬機器
+ 調整 Azure 虛擬機器的計算和儲存體
+ 使用 Azure 入口網站部署區域復原 Azure 虛擬機器擴展集
+ 使用虛擬機器擴充功能設定 Azure 虛擬機器擴展集
+ 調整 Azure 虛擬機器擴展集的計算和儲存體
