---
lab:
  title: 02b - 透過 Azure 原則管理治理
  module: Administer Governance and Compliance
---

# <a name="lab-02b---manage-governance-via-azure-policy"></a>實驗 02b - 透過 Azure 原則管理治理
# <a name="student-lab-manual"></a>學生實驗手冊

## <a name="lab-scenario"></a>實驗案例

為了改善 Contoso 中的 Azure 資源管理，您必須負責實作下列功能：

- 標籤僅包含基礎結構資源的資源群組 (例如 Cloud Shell 儲存體帳戶)

- 確保只有正確標籤的基礎結構資源可以新增至基礎結構資源群組

- 補救任何不符合規範的資源

**注意：** **[互動式實驗室模擬](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%203)** (英文) 可供您以自己的步調完成此實驗室。 您可能會發現互動式模擬與託管實驗室之間稍有差異，但所示範的核心概念與想法均相同。 

## <a name="objectives"></a>目標

在此實驗中，我們將：

+ 工作 1：透過 Azure 入口網站建立和指派標籤
+ 工作 2：透過 Azure 原則強制執行標籤
+ 工作 3：透過 Azure 原則套用標籤

## <a name="estimated-timing-30-minutes"></a>預估時間：30 分鐘

## <a name="architecture-diagram"></a>架構圖

![image](../media/lab02b.png)

## <a name="instructions"></a>指示

### <a name="exercise-1"></a>練習 1

#### <a name="task-1-assign-tags-via-the-azure-portal"></a>工作 1：透過 Azure 入口網站指派標籤

在此工作中，您將透過 Azure 入口網站建立標籤，並將其指派給 Azure 資源群組。

1. 在 Azure 入口網站中，在 [Cloud Shell] 內起始 [PowerShell] 工作階段。

    >**注意**：如果這是您第一次啟動 **Cloud Shell**，而且出現**您未掛接任何儲存體**訊息，請選取您在此實驗中使用的訂用帳戶，並按一下 [建立儲存體]。 

1. 從 [Cloud Shell] 窗格中，執行下列命令來識別 Cloud Shell 所使用的儲存體帳戶名稱：

   ```powershell
   df
   ```

1. 在命令的輸出中，記下指定 Cloud Shell 主要磁碟機掛接的完整路徑第一個部分 (在此標示為 `xxxxxxxxxxxxxx`：

   ```
   //xxxxxxxxxxxxxx.file.core.windows.net/cloudshell   (..)  /usr/csuser/clouddrive
   ```

1. 在 Azure 入口網站中，搜尋並選取 [儲存體帳戶]，然後在儲存體帳戶清單中，按一下代表您在上一個步驟中所識別儲存體帳戶的專案。

1. 在 [儲存體帳戶] 刀鋒視窗中，按一下代表包含儲存體帳戶的資源群組名稱連結。

    **注意**：請記下儲存體帳戶所在的資源群組，您稍後會在實驗中用到。

1. 在 [資源群組] 刀鋒視窗上，按一下 [標籤] 旁的 [編輯] 以建立新的標籤。

1. 使用下列設定建立標籤並套用您的變更：

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | **角色** |
    | 值 | **基礎結構** |

1. 瀏覽回到儲存體帳戶刀鋒視窗。 檢閱**概觀**資訊，並注意新標籤未自動指派給儲存體帳戶。 

#### <a name="task-2-enforce-tagging-via-an-azure-policy"></a>工作 2：透過 Azure 原則強制執行標籤

在這項工作中，您會將內建的*需要標籤及其資源值*原則指派給資源群組，並評估結果。 

1. 在 Azure 入口網站中，搜尋並選取 [原則]。 

1. 在 [撰寫] 區段中，按一下 [定義]。 請花點時間瀏覽可供您使用的內建原則定義清單。 在 [類別] 下拉式清單中選取 [標籤] 項目 (並取消選取所有其他項目)，以列出涉及使用標籤的所有內建原則。 

1. 按一下代表**需要標籤及其資源值**內建原則的項目，並檢閱其定義。

1. 在 [需要標籤及其資源值] 內建原則定義刀鋒視窗的值上，按一下 [指派]。

1. 按一下省略號按鈕並選取下列值來指定 [範圍]：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您在此實驗中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | 資源群組的名稱，其中包含您在上一個工作中識別的 Cloud Shell 帳戶 |

    >**注意**：範圍會決定原則指派生效的資源或資源群組。 您可以在管理群組、訂用帳戶或資源群組層級上指派原則。 您也可以選擇指定排除專案，例如個別訂用帳戶、資源群組或資源 (視指派範圍而定)。 

1. 藉由指定下列設定來設定指派的**基本**屬性 (讓其他設定保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 指派名稱 | **需要具有 基礎結構 值的角色標籤**|
    | 描述 | **Cloud Shell 資源群組中所有資源需要具有 基礎結構 值的角色標籤**|
    | 強制執行原則 | 啟用 |

    >**注意**：[指派名稱] 會自動填入您選取的原則名稱，但您可加以變更。 您也可以新增選擇性的 [描述]****。 [指派者] 會根據建立指派的使用者名稱自動填入。 

1. 按 [下一步]，並將 [參數] 設定為下列值：

    | 設定 | 值 |
    | --- | --- |
    | 標記名稱 | **角色** |
    | 標記值 | **基礎結構** |

1. 按一下 [下一步]，然後檢閱 [補救] 索引標籤。保留 [建立受控識別] 核取方塊取消勾選。 

    >**注意**：當原則或計畫包含 **deployIfNotExists** 或 **Modify** 效果時，可以使用此設定。

1. 按一下 [檢閱 + 建立]，然後按一下 [建立]。

    >**注意**：現在您會嘗試在資源群組中建立另一個 Azure 儲存體帳戶，而不明確新增必要的標籤，以確認新的原則指派生效。 
    
    >**注意**：原則可能需要 5 到 15 分鐘才會生效。

1. 瀏覽回到裝載用於 Cloud Shell 主要磁碟機儲存體帳戶的資源群組刀鋒視窗，您已在先前工作中識別該磁碟機。

1. 在資源群組刀鋒視窗中，按一下 [+ 建立]，然後搜尋**儲存體帳戶**，然後按一下 [+ 建立]。 

1. 在 [建立儲存體帳戶] 刀鋒視窗的 [基本] 索引標籤上，確認您使用的是已套用原則的資源群組，並指定下列設定 (讓其他設定保留預設值)，按一下 [檢閱 + 建立]，然後按一下 [建立]：

    | 設定 | 值 |
    | --- | --- |
    | 儲存體帳戶名稱 | 介於 3 到 24 個小寫字母和數位之間的任何全域唯一組合，從字母開始 |

1. 建立部署之後，您應該會在入口網站的 [通知] 清單中看到**部署失敗**訊息。 從 [通知] 清單中，瀏覽到部署概觀，然後按一下 [部署失敗。**按一下此處獲得詳細資料]** 訊息，以識別失敗原因。 

    >**注意**：確認錯誤訊息指出原則是否不允許資源部署。 

    >**注意**：按一下 [原始錯誤] 索引標籤，您可以找到錯誤的詳細資料，包括角色定義**需要具有 基礎結構 值的角色標籤**。 部署失敗，因為您嘗試建立的儲存體帳戶沒有名為 **角色** 的標籤，且其值設定為 **基礎結構**。

#### <a name="task-3-apply-tagging-via-an-azure-policy"></a>工作 3：透過 Azure 原則套用標籤

在這項工作中，我們將使用不同原則定義來補救任何不符合規範的資源。 

1. 在 Azure 入口網站中，搜尋並選取 [原則]。 

1. 在 [撰寫] 區段中，按一下 [指派]。 

1. 在指派清單中按一下代表**需要具有 基礎結構 值的角色標籤**原則指派列的省略號圖示，並使用 [刪除指派] 功能表項目來刪除指派。

1. 按一下 [指派原則]，然後按一下省略號按鈕並選取下列值來指定 [範圍]：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您在此實驗中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | 資源群組的名稱，其中包含您在第一個工作中識別的 Cloud Shell 帳戶 |

1. 若要指定**原則定義**，請按一下省略號按鈕，然後搜尋並選取 [從資源群組繼承標籤 (若遺漏)]。

1. 藉由指定下列設定來設定指派的剩餘**基本**屬性 (讓其他設定保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 指派名稱 | **如果遺漏，從 Cloud Shell 資源群組繼承 角色 標籤及其 基礎結構 值**|
    | 描述 | **如果遺漏，從 Cloud Shell 資源群組繼承 角色 標籤及其 基礎結構 值**|
    | 強制執行原則 | 啟用 |

1. 按 [下一步]，並將 [參數] 設定為下列值：

    | 設定 | 值 |
    | --- | --- |
    | 標記名稱 | **角色** |

1. 按一下 [下一步]，然後在 [補救] 索引標籤上，設定下列設定 (保留其他項目為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 建立補救工作 | 已啟用 |
    | 要補救的原則 | **從資源群組繼承標籤 (若遺漏)** |

    >**注意**：此原則定義包含 **Modify** 效果。

1. 按一下 [檢閱 + 建立]，然後按一下 [建立]。

    >**注意**：為了確認新的原則指派生效，您會在相同的資源群組中建立另一個 Azure 儲存體帳戶，而不明確新增必要的標籤。 
    
    >**注意**：原則可能需要 5 到 15 分鐘才會生效。

1. 瀏覽回到裝載用於 Cloud Shell 主要磁碟機儲存體帳戶的資源群組刀鋒視窗，您已在第一個工作中識別該磁碟機。

1. 在資源群組刀鋒視窗中，按一下 [+ 建立]，然後搜尋**儲存體帳戶**，然後按一下 [+ 建立]。 

1. 在 [建立儲存體帳戶] 刀鋒視窗的 [基本] 索引標籤上，確認您使用的是已套用原則的資源群組，並指定下列設定 (讓其他設定保留預設值)，然後按一下 [檢閱 + 建立]：

    | 設定 | 值 |
    | --- | --- |
    | 儲存體帳戶名稱 | 介於 3 到 24 個小寫字母和數位之間的任何全域唯一組合，從字母開始 |

1. 請確認這次通過驗證，然後按一下 [建立]。

1. 佈建新的儲存體帳戶之後，按一下 [移至資源] 按鈕，然後在新建立的儲存體帳戶的 [概觀] 刀鋒視窗上，注意已自動將 [基礎結構] 值指派給資源的 [角色] 標籤。

#### <a name="task-4-clean-up-resources"></a>工作 4：清理資源

   >**注意**：請記得移除您不再使用的任何新建立的 Azure 資源。 移除未使用的資源可確保您不會看到非預期的費用，但請記住，Azure 原則不會產生額外費用。
   
   >**注意**：如果無法立即移除實驗資源，請不要擔心。 有時候資源具有相依性，需要經過較長的時間才能刪除。 這是監視資源使用量的常見系統管理員工作，因此只需定期檢閱入口網站中的資源，查看清除的運作情況便可。 

1. 在入口網站中，搜尋並選取 [原則]。

1. 在 [撰寫] 區段中，按一下 [指派]，再按一下您在前一個工作中建立的工作分派右側省略號圖示，然後按一下 [刪除指派]。 

1. 在入口網站中，搜尋並選取 [儲存體帳戶]。

1. 在儲存體帳戶清單中，選取對應至您在此實驗最後一個工作中所建立儲存體帳戶的資源群組。 選取 [標籤]，然後對 **角色：基礎結構** 標籤按一下右側的 [刪除] (右側的垃圾桶)，然後按 [套用]。 

1. 按一下 [概觀]，然後按一下儲存體帳戶刀鋒視窗頂端的 [刪除]。 當系統提示您確認時，在 [刪除儲存體帳戶] 刀鋒視窗中，輸入儲存體帳戶的名稱以確認並按一下 [刪除]。 

#### <a name="review"></a>檢閱

在此實驗中，您已：

- 透過 Azure 入口網站建立和指派標籤
- 透過 Azure 原則強制執行標籤
- 透過 Azure 原則套用標籤
