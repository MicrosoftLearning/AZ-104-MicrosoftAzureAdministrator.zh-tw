---
lab:
  title: 實驗室 02b：透過 Azure 原則 管理控管
  module: Administer Governance and Compliance
---

# 實驗 02b - 透過 Azure 原則管理治理

## 實驗室簡介

在此實驗室中，您將瞭解如何實作組織的治理計劃。 您瞭解 Azure 原則如何確保整個組織強制執行作業決策。 您將瞭解如何使用資源標記來改善報告。 

此實驗室需要 Azure 訂用帳戶。 您的訂用帳戶類型可能會影響此實驗室中功能的可用性。 您可以變更區域，但步驟是使用 **美國**東部撰寫。 

## 預估時間：30 分鐘

## 實驗案例

您組織的雲端使用量在過去一年裡已大幅成長。 在最近的稽核期間，您已探索到大量沒有已定義擁有者、專案或成本中心的資源。 為了改善組織中 Azure 資源的管理，您決定實作下列功能：

- 套用資源標籤以將重要的元數據附加至 Azure 資源

- 使用 Azure 原則強制使用新資源的資源標籤

- 使用資源標籤更新現有的資源

- 使用資源鎖定來保護已設定的資源

## 互動式實驗室模擬

您可能會發現數個互動式實驗室模擬適合本主題。 模擬可讓您以自己的步調點選類似的案例。 互動式模擬和此實驗室之間有差異，但許多核心概念都相同。 不需要 Azure 訂用帳戶。 

+ [管理資源鎖定](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%2015)。 新增資源鎖定並測試以確認。
  
+ [建立 Azure 原則](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%2017)。 建立可限制位置資源的 Azure 原則。 建立新的資源，並確保強制執行原則。 

+ [透過 Azure 原則](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%203)管理治理。 透過 Azure 入口網站 建立和指派標籤。 建立需要標記的 Azure 原則。 補救不符合規範的資源。

## 架構圖

![工作架構的圖表。](../media/az104-lab02b-architecture.png)

## 作業技能

+ 工作 1：透過 Azure 入口網站建立和指派標籤。
+ 工作 2：透過 Azure 原則 強制執行標記。
+ 工作3：透過 Azure 原則套用標記。
+ 工作 4：設定及測試資源鎖定。 

## 工作 1：透過 Azure 入口網站指派標籤

在此工作中，您將透過 Azure 入口網站建立標籤，並將其指派給 Azure 資源群組。 卷標是治理策略的重要元件，如 Microsoft Well-Architected Framework 和 雲端採用架構 所述。 卷標可讓您快速識別資源擁有者、日落日期、群組聯繫人，以及貴組織認為重要的其他名稱/值組。 針對這項工作，您會指派一個標記，以識別資源角色 （'Infra' for 'Infrastructure'）。

1. 登入 **Azure 入口網站** - `https://portal.azure.com`。
      
1. 搜尋並選取 `Resource groups`。

1. 從 [資源群組] 中，選取 [ **+ 建立**]。

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶名稱 | 訂用帳戶 |
    | 資源群組名稱 | `az104-rg2` |
    | Location | **美國東部** |

    >**注意：** 針對本課程中的每個實驗室，您將建立新的資源群組。 這可讓您快速找出及管理實驗室資源。 

1. 選取 [ **下一步：標記** ]，然後建立新的標記。

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `Cost Center` |
    | 值 | `000` |

1. 選取 [檢閱 + 建立]，然後選取 [建立]。

## 工作 2：透過 Azure 原則 強制執行標記

在這項工作中，您會將內建的*需要標籤及其資源值*原則指派給資源群組，並評估結果。 Azure 原則 可用來對 Azure 資源強制執行設定，在此案例中為治理。 

1. 在 Azure 入口網站 中，搜尋並選取 `Policy`。 

1. 在 [ **撰寫]** 刀鋒視窗中，選取 [ **定義**]。 請花點時間流覽可供您使用的 [內建原則定義](https://learn.microsoft.com/azure/governance/policy/samples/built-in-policies) 清單。 請注意，您也可以搜尋定義。

    ![原則定義的螢幕快照。](../media/az104-lab02b-policytags.png)

1. 按兩下代表 **[需要標籤] 的專案，以及其在資源** 內建原則上的值。 請花一分鐘的時間檢閱定義。 

1. 在 [需要標籤及其資源值] 內建原則定義刀鋒視窗的值上，按一下 [指派]。

1. **按兩下省略號按鈕並選取下列值，以指定範圍**。 完成時，按兩下 [ **選取** ]。 

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | *訂用帳戶* |
    | 資源群組 | **az104-rg2** |

    >**注意**：您可以在管理群組、訂用帳戶或資源群組層級上指派原則。 您也可以選擇指定排除專案，例如個別訂用帳戶、資源群組或資源。 在此案例中，我們想要在資源群組中的所有資源上標記。

1. 藉由指定下列設定來設定指派的**基本**屬性 (讓其他設定保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 指派名稱 | `Require Cost Center tag with Default value`|
    | 描述 | `Require Cost Center tag with default value for all resources in the resource group`|
    | 強制執行原則 | 啟用 |

    >**注意**：[指派名稱] 會自動填入您選取的原則名稱，但您可加以變更。 [ **描述** ] 是選擇性的。 請注意，您可以隨時停用原則。 

1. 按兩下 [下一步]，並將 [參數] 設定為下列值：

    | 設定 | 值 |
    | --- | --- |
    | 標記名稱 | `Cost Center` |
    | 標記值 | `000` |

1. 按一下 [下一步]，然後檢閱 [補救] 索引標籤。保留 [建立受控識別] 核取方塊取消勾選。 

1. 按一下 [檢閱 + 建立]，然後按一下 [建立]。

    >**注意**：現在您會嘗試在資源群組中建立 Azure 儲存體 帳戶，確認新的原則指派是否有效。 您將建立記憶體帳戶，而不需要新增必要的標籤。 
    
    >**注意**：原則可能需要 5 到 10 分鐘才會生效。

1. 在入口網站中，搜尋並選取 `Storage Account`，然後選取 [ **+ 建立**]。 

1. 在 [**建立記憶體帳戶**] 刀鋒視窗的 [**基本] 索引**卷標上，完成設定。

    | 設定 | 值 |
    | --- | --- |
    | 資源群組 | **az104-rg2** |
    | 儲存體帳戶名稱 | *任何介於 3 到 24 個小寫字母和數位之間的全域唯一組合，從字母開始* |

1. 選取 [ **檢閱** ]，然後按兩下 [ **建立**]：

1. 建立部署之後，您應該會在入口網站的 [通知] 清單中看到**部署失敗**訊息。 從 [通知] 清單中，瀏覽到部署概觀，然後按一下 [部署失敗。**按一下此處獲得詳細資料]** 訊息，以識別失敗原因。 

    ![不允許的原則錯誤的螢幕快照。](../media/az104-lab02b-policyerror.png) 

    >**注意**：確認錯誤訊息指出原則不允許資源部署。 

    >**注意**：按兩下 [ **原始錯誤]** 索引標籤，您可以找到錯誤的詳細資料，包括具有預設值的角色定義 **[需要成本中心] 標籤**的名稱。 部署失敗，因為您嘗試建立的記憶體帳戶沒有名為 **Cost Center** 的標籤，其值設定為 **預設值**。

## 工作 3：透過 Azure 原則套用標籤

在這項工作中，我們將使用新的原則定義來補救任何不符合規範的資源。 在此案例中，我們會讓資源群組的任何子資源繼承 **資源群組上定義的成本中心** 標籤。

1. 在 Azure 入口網站 中，搜尋並選取 `Policy`。 

1. 在 [撰寫] 區段中，按一下 [指派]。 

1. 在工作分派清單中，按兩下資料列中的省略號圖示，代表 **具有預設值原則** 指派的 [需要成本中心] 標籤，並使用 **[刪除指派** ] 選單項來刪除指派。

1. 按一下 [指派原則]，然後按一下省略號按鈕並選取下列值來指定 [範圍]：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您的 Azure 訂用帳戶 |
    | 資源群組 | `az104-rg2` |

1. 若要指定原則 **定義**，請按下省略號按鈕，然後搜尋並選取 `Inherit a tag from the resource group if missing`。

1. 選取 [ **新增** ]，然後設定指派的其餘 **[基本]** 屬性。

    | 設定 | 值 |
    | --- | --- |
    | 指派名稱 | `Inherit the Cost Center tag and its value 000 from the resource group if missing` |
    | 描述 | `Inherit the Cost Center tag and its value 000 from the resource group if missing` |
    | 強制執行原則 | 啟用 |

1. 按兩下 [下一步]，並將 [參數] 設定為下列值：

    | 設定 | 值 |
    | --- | --- |
    | 標記名稱 | `Cost Center` |

1. 按一下 [下一步]，然後在 [補救] 索引標籤上，設定下列設定 (保留其他項目為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 建立補救工作 | 已啟用 |
    | 要補救的原則 | **從資源群組繼承標籤 (若遺漏)** |

    >**注意**：此原則定義包含 **Modify** 效果。 因此，需要受控識別。 

    ![原則補救頁面的螢幕快照。 ](../media/az104-lab02b-policyremediation.png) 

1. 按一下 [檢閱 + 建立]，然後按一下 [建立]。

    >**注意**：若要確認新的原則指派生效，您會在相同的資源群組中建立另一個 Azure 儲存器帳戶，而不需明確新增必要的卷標。 
    
    >**注意**：原則可能需要 5 到 10 分鐘才會生效。

1. 搜尋並選取 `Storage Account`，然後按兩下 [ **+ 建立**]。 

1. 在 [建立儲存體帳戶] 刀鋒視窗的 [基本] 索引標籤上，確認您使用的是已套用原則的資源群組，並指定下列設定 (讓其他設定保留預設值)，然後按一下 [檢閱]：

    | 設定 | 值 |
    | --- | --- |
    | 儲存體帳戶名稱 | *任何介於 3 到 24 個小寫字母和數位之間的全域唯一組合，從字母開始* |

1. 請確認這次通過驗證，然後按一下 [建立]。

1. 布建新的記憶體帳戶之後，請按兩下 **[移至資源**]。

1. 在 [**卷標**] 刀鋒視窗上，請注意，具有值 **000** 的標籤**成本中心**已自動指派給資源。

    >**你知道嗎？** 如果您在入口網站中搜尋並選取 **[卷標** ]，您可以檢視具有特定標籤的資源。 

## 工作 4：設定及測試資源鎖定

在這項工作中，您會設定及測試資源鎖定。 鎖定可防止刪除或修改資源。 

1. 搜尋並選取您的資源群組。
   
1. 在 **[設定]** 刀鋒視窗中，選取 [**鎖定**]。

1. 選取 [ **新增** ] 並完成資源鎖定資訊。 完成時，選取 [ **確定**]。 

    | 設定 | 值 |
    | --- | --- |
    | 鎖定名稱 | `rg-lock` |
    | 鎖定類型 | **delete** （請注意唯讀的選取範圍） |
    
1. 流覽至 [資源群組 **概觀** ] 刀鋒視窗，然後選取 [ **刪除資源群組**]。

1. 在 [**輸入資源群組名稱以確認刪除**] 文字框中，提供資源群組名稱 `az104-rg2` 請注意，您可以複製並貼上資源組名。 

1. 請注意警告：刪除此資源群組及其相依資源是永久動作，無法復原。 選取 **[刪除]**。

1. 您應該會收到拒絕刪除的通知。 

    ![無法刪除訊息的螢幕快照。](../media/az104-lab02b-failuretodelete.png) 

## 清除您的資源

如果您使用自己的訂用 **帳戶** ，需要一分鐘的時間才能刪除實驗室資源。 這可確保資源可以釋出，並將成本降到最低。 刪除實驗室資源最簡單的方式是刪除實驗室資源群組。 

+ 在 Azure 入口網站 中，選取資源群組、選取 **[刪除資源群組**]、**輸入資源組名**，然後按兩下 [**刪除**]。
+ 使用 Azure PowerShell， `Remove-AzResourceGroup -Name resourceGroupName`。
+ 使用 CLI， `az group delete --name resourceGroupName`。

## 重要心得

恭喜您完成實驗室。 以下是此實驗室的主要外賣。 

+ Azure 標籤是包含索引鍵/值組的元數據。 標籤會描述您環境中的特定資源。 特別是，在 Azure 中標記可讓您在邏輯環境中標記資源。
+ Azure 原則可建立資源的慣例。 原則定義會描述資源合規性條件，以及符合條件時所要採取的效果。 條件會與必要值比較資源屬性欄位或值。 有許多內建原則定義，您可以自定義原則。 
+ Azure 原則 補救工作功能可用來根據定義和指派，將資源帶入合規性。 不符合修改或 deployIfNotExist 定義指派規範的資源，可以使用補救工作進入合規性。
+ 您可以在訂用帳戶、資源群組或資源上設定資源鎖定。 鎖定可保護資源免於意外刪除和修改使用者。 鎖定會覆寫使用者的任何權限。
+ Azure 原則 是部署前的安全性做法。 RBAC 和資源鎖定是部署后的安全性做法。 

## 透過自學型訓練深入了解

+ [設計企業治理策略](https://learn.microsoft.com/training/modules/enterprise-governance/)。 使用 RBAC 和 Azure 原則 來限制對 Azure 解決方案的存取，並判斷哪一種方法適合您的安全性目標。
  

