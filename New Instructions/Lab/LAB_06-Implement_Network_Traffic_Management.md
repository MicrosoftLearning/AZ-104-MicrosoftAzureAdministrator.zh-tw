---
lab:
  title: 實驗室 06：實作流量管理
  module: Administer Network Traffic Management
---

# 實驗 06 - 實作流量管理

## 實驗室簡介

在此實驗室中，您將瞭解如何設定及測試公用 Load Balancer 和 應用程式閘道。 

此實驗室需要 Azure 訂用帳戶。 您的訂用帳戶類型可能會影響此實驗室中功能的可用性。 您可以變更區域，但步驟是使用美國東部撰寫。

## 預估時間：40 分鐘

## 實驗案例

您的組織有公用網站。 您必須在不同虛擬機器之間平衡傳入的公用要求。 您也需要提供來自不同虛擬機器的影像和影片。 您計畫實作 和 Azure Load Balancer 和 Azure 應用程式閘道。 所有資源都位於相同的區域中。 

## 互動式實驗室模擬

您可能會發現互動式實驗室模擬對本主題很有用。 模擬可讓您以自己的步調點選類似的案例。 互動式模擬和此實驗室之間有差異，但許多核心概念都相同。 不需要 Azure 訂用帳戶。

+ [建立和設定和 Azure 負載平衡器 ](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Create%20and%20configure%20an%20Azure%20load%20balancer) 。 建立虛擬網路、後端伺服器、負載平衡器，然後測試負載平衡器。 
+ [部署Azure 應用程式閘道 ](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Deploy%20Azure%20Application%20Gateway) 。 建立應用程式閘道、建立虛擬機器、建立後端集區，以及測試閘道。 
+ [實作流量管理 ](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2010) 。 實作完整的中樞和輪輻網路，包括虛擬機器、虛擬網路、對等互連、負載平衡器和應用程式閘道。

## 工作

+ 工作 1：佈建實驗室環境
+ 工作 2：實作 Azure Load Balancer
+ 工作 3：實作Azure 應用程式閘道



## 工作 1：佈建實驗室環境

在這項工作中，您將使用範本來部署一個虛擬網路、一個網路安全性群組和兩個虛擬機器，以及相關聯的虛擬網路介面卡。 VM 會位於名為 ** az104-vnet1 ** 的中樞虛擬網路中。

1. 如有必要，請下載 ** \\ Allfiles \\ Lab06 \\ az104-06-vms-loop-template.json ** 實驗室檔案。 

1. 登入 **Azure 入口網站** - `https://portal.azure.com`。

1. 搜尋並選取 `Deploy a custom template`。

1. 在自訂部署頁面上，選取 ** [在編輯器 ** 中建置您自己的範本]。

1. 在編輯範本頁面上，選取 ** [載入檔案 ** ]。

1. 找出並選取 ** \\ Allfiles \\ Lab06 \\ az104-06-vms-loop-template.json ** 檔案，然後選取 [ ** 開啟 ** ]。

   >**注意： ** 請注意，此檔案包含檔案頂端的參數。 因此，不需要個別的參數檔案。 

1. 選取 [儲存]。

1. 使用下列資訊來完成自訂部署頁面上的欄位，讓所有其他欄位都保留預設值。

    | 設定       | 值         | 
    | ---           | ---           |
    | 訂用帳戶  | 您的 Azure 訂用帳戶 |
    | 資源群組| `az104-rg6`（如有必要，請選取 **** 新建）
    | 區域        | **美國東部**   |
    | VM 大小       | **標準 DS2 v3** |
    | 管理員使用者名稱| `localadmin` |
    | 密碼      | 提供安全的密碼 |

     >**注意 ** ：如果您收到 VM 大小無法使用的錯誤，請選取訂用帳戶中可用的 SKU，且至少有 2 個核心。

1. 選取 [檢閱 + 建立]，然後選取 [建立]。

    >**注意 ** ：等待部署完成，再移至下一個工作。 部署應該會在大約 5 分鐘內完成。
    
    >**注意： ** 等候時，搜尋並選取 ** [網路監看員 ** ]。 選取 [ ** 拓撲] ** 刀鋒視窗以取得虛擬網路基礎結構的檢視。 將滑鼠停留在網路上以檢視子網和 IP 定址資訊。 

## 工作 2：實作 Azure Load Balancer

在此工作中，您將會在中樞虛擬網路中的兩部 Azure 虛擬機器前端實作 Azure Load Balancer。 Azure 中的負載平衡器可跨資源提供第 4 層連線能力，例如虛擬機器。 Load Balancer 組態包含前端 IP 位址以接受連線、後端集區，以及定義連線應如何周遊負載平衡器的規則。


## 架構圖 - Load Balancer

>**注意 ** ：請注意，Load Balancer 會分散到相同虛擬網路中的兩部虛擬機器。 


![實驗室工作的圖表。](../media/az104-lab06lb-architecture-diagram.png)


1. 在Azure 入口網站中，搜尋並選取 `Load balancers` ，然後在 [負載平衡器 ** ] 刀鋒視窗上 ** ，按一下 ** [+ 建立 ** ]。

1. 使用下列設定建立負載平衡器 (將其他設定保持預設值)，然後按一下 [下一步：前端 IP 設定]：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | Azure 訂用帳戶的名稱 |
    | 資源群組 | **az104-rg6** |
    | 名稱 | `az104-lb` |
    | 區域 | **您部署 VM 的相同 ** 區域 |
    | SKU  | **標準** |
    | 類型 | **公開** |
    | 層 | **Regional** |
    
     ![建立負載平衡器頁面的螢幕擷取畫面。](../media/az104-lab06-create-lb1.png)

1. 在 [前端 IP 設定] 索引標籤上，按一下 [新增前端 IP 設定]，然後使用下列設定：  
     
    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `az104-fe` |
    | IP 類型 | IP 位址 |
    | 公用 IP 位址 | 選取 [新建]|
    | 閘道負載平衡器 | 無 |
    
1. 在 [新增公用 IP 位址] 彈出視窗上，使用以下設定，然後依序按一下 [確定] 和 [新增]。 完成時，按一下 [Next: Backend pools] \(下一步：後端集區\)。 
     
    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `az104-pip` |
    | SKU | 標準 |
    | 層 | 地區 |
    | 指派 | 靜態 |
    | 路由喜好設定 | **Microsoft 網路** |

1. 在 [後端集區] 索引標籤上，搭配下列設定 (將其他設定保留為預設值) 按一下 [新增後端集區]。 按一下 ** [+ 新增 ** ] （兩次），然後按  ** [下一步：輸入規則 ** ]。 

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `az104-be` |
    | 虛擬網路 | **az104-06-vnet1** |
    | 後端集區設定 | **NIC** | 
    | IP 版本 | **IPv4** |
    | 按一下 [新增] 以新增虛擬機器 |  |
    | az104-vm0 | **核取方塊** |
    | az104-vm1 | **核取方塊** |

1. 在 [輸入規則] 索引標籤上，按一下 [新增負載平衡規則]。 使用下列設定新增負載平衡規則 (將其他設定保留為預設值)。 完成時，按一下 [新增]。

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `az104-lbrule` |
    | IP 版本 | **IPv4** |
    | 前端 IP 位址 | **az104-fe** |
    | 後端集區 | **az104-be** |
    | 通訊協定 | **TCP** |
    | 連接埠 | `80` |
    | 後端連接埠 | `80` |
    | 健全狀況探查 | **新建** |
    | 名稱 | `az104-hp` |
    | 通訊協定 | **TCP** |
    | 連接埠 | `80` |
    | 間隔 | `5` |
    | 關閉 [create health probe] \(建立健全狀態探查\) 視窗 | **儲存** | 
    | 工作階段持續性 | **無** |
    | 閒置逾時 (分鐘) | `4` |
    | TCP 重設 | **停用** |
    | 浮動 IP | **Disabled** |
    | 輸出來源網路位址轉譯 (SNAT) | **建議需求** |

1. 當您有時間時，請檢閱其他索引標籤，然後按一下 [檢閱及建立]。 確定沒有任何驗證錯誤，然後按一下 [建立]。 

1. 等候負載平衡器部署，然後按一下 [前往資源]。  

1. 從 Load Balancer 資源頁面中選取 [Frontend IP configuration] \(前端 IP 設定\)。 複製公用 IP 位址。

1. 開啟另一個瀏覽器索引標籤，然後巡覽至該 IP 位址。 確認瀏覽器視窗會顯示 **Hello World from az104-06-vm0** 或 **Hello World from az104-06-vm1** 訊息。

1. 重新整理視窗，以確認訊息會變更為另一部虛擬機器。 這可示範負載平衡器在不同的虛擬機器之間轉換。

    > **注意**：您可能需要多次重新整理，或在 InPrivate 模式中開啟新的瀏覽器視窗。

### 測試 vm0 與 vm1 之間的連線 

1. 從Azure 入口網站搜尋並選取 `Network Watcher` 。

1. 從 [網路監看員]，在 [網路診斷工具] 功能表中，選取 ** [連線ion 疑難排解 ** ]。

1. 使用下列資訊來完成 [連線ion 疑難排解 ** ] 頁面上的 ** 欄位。

    | 欄位 | 值 | 
    | --- | --- |
    | 來源類型           | **虛擬機器**   |
    | 虛擬機器       | **vm0**    | 
    | 目的地類型      | **虛擬機器**   |
    | 虛擬機器       | **vm1**   | 
    | 慣用 IP 版本  | **兩者**              | 
    | 通訊協定              | **TCP**               |
    | 目的地連接埠      | `3389`                |  
    | 來源連接埠           | *Blank*         |
    | 診斷測試      | *Defaults*      |

    ![顯示連線疑難排解設定的 Azure 入口網站。](../media/az104-lab06-connection-troubleshoot.png)

1. 選取 [ ** 執行診斷測試 ** ]。

    >**注意 ** ：可能需要幾分鐘的時間，結果才會傳回。 收集結果時，螢幕選取專案會呈現灰色。 **請注意，連線性測試 ** 會顯示 ** Reachable ** 。 這很合理，因為虛擬機器位於相同的虛擬網路中。 

## 工作 3：實作Azure 應用程式閘道

在這項工作中，您會在兩部 Azure 虛擬機器前面實作Azure 應用程式閘道。 應用程式閘道會將第 7 層負載平衡、Web 應用程式防火牆 （WAF）、SSL 終止和端對端加密提供給後端集區中定義的資源。 應用程式閘道會將映射路由傳送至一部虛擬機器，並將影片路由傳送至另一部虛擬機器。 

## 架構圖 - 應用程式閘道

>**注意 ** ：此應用程式閘道在與先前工作中的 Load Balancer 相同的虛擬網路中運作。 這在生產環境中並不常見。

![實驗室工作的圖表。](../media/az104-lab06gw-architecture-diagram.png)

1. 在Azure 入口網站中，搜尋並選取 `Virtual networks` 。

1. 在 [ ** 虛擬網路] ** 刀鋒視窗的虛擬網路清單中，按一下 ** az104-vnet1 ** 。

1. 在 az104-vnet1 虛擬網路刀鋒視窗的 ** ** [設定 ** ] 區段中，按一下 ** [子網 ** ]，然後按一下 [ ** + 子網 ** ]。 **

1. 新增具有下列設定的子網（讓其他人保留預設值）。

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `subnet-appgw` |
    | 子網路位址範圍 | `10.60.3.224/27` |

1. 按一下 [儲存]

    > **注意 ** ：此子網將由Azure 應用程式閘道實例使用。 應用程式閘道需要大小為 /27 或更大的專用子網路。 

1. 在Azure 入口網站中，搜尋並選取 `Application Gateways` ，然後在 [應用程式閘道] ** 刀鋒視窗上 ** ，按一下 ** [+ 建立 ** ]。

1. 在 [基本] 索引標籤上，指定下列設定 (將其他設定保留為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | `az104-rg6` |
    | 應用程式閘道名稱 | `az104-appgw` |
    | 區域 | **您在工作 1 中使用的相同 ** Azure 區域 |
    | 層 | **Standard V2** |
    | 啟用自動調整 | 否 |
    | 執行個體計數 | `2` |
    | 可用性區域 | **None** |
    | HTTP2 | **停用** |
    | 虛擬網路 | **az104-06-vnet1** |
    | 子網路 | **subnet-appgw (10.60.3.224/27)** |

    ![建立應用程式閘道頁面的螢幕擷取畫面。](../media/az104-lab06-create-appgw.png)

1. 按一下 [Next: Frontends >] \(下一步: 前端 >\)，然後指定下列設定 (將其他設定保留為預設值)。 完成時，按一下 [確定]。 

    | 設定 | 值 |
    | --- | --- |
    | 前端 IP 位址類型 | **公開** |
    | 公用 IP 位址| **新增** | 
    | 名稱 | `az104-gwpip` |
    | 可用性區域 | **None** |

1. 按一下 [Next: Backends >] \(下一步: 後端 >\)，然後按一下 [新增後端集區]。 這是映射 ** 的後端集區 ** 。 指定下列設定 (將其他設定保留為預設值)。 完成時，按一下 [新增]。

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `az104-appgwbe` |
    | 新增無目標的後端集區 | **否** |
    | 虛擬機器 | **az104-rg6-nic1 （10.60.1.4）** |
    | 虛擬機器 | **az104-rg6-nic2 （10.60.2.4）** | 

1. 依序按一下 [Next: Configuration >] \(下一步: 設定 >\) 與 [+ Add a routing rule] \(+ 新增路由規則\)。 指定下列設定：

    | 設定 | 值 |
    | --- | --- |
    | 規則名稱 | `az104-gwrule` |
    | 優先順序 | `10` |
    | 接聽程式名稱 | `az104-listener` |
    | 前端 IP | **公開** |
    | 通訊協定 | **HTTP** |
    | Port | `80` |
    | 接聽程式類型 | **基本** |

    ![[建立應用程式閘道規則] 頁面的螢幕擷取畫面。](../media/az104-lab06-appgw-rule.png)

1. 切換至 [Backend targets] \(後端目標\) 索引標籤，並指定下列設定 (將其他設定保留為預設值)。 

    | 設定 | 值 |
    | --- | --- |
    | 目標類型 | **後端集區** |
    | 後端目標 | **az104-appgwbe** |
    | 後端設定 | **新增** |
    | 後端設定名稱 | `az104-http` |
    | 後端通訊協定 | **HTTP** |
    | 後端連接埠 | `80` |
    | 其他設定 | **採用預設值** |
    | 主機名稱 | **採用預設值** |

   >**注意： ** 使用參考圖示深入瞭解 ** Cookie 型親和 ** 性和 ** 連線清空 ** 。 

1. 選取 ** [新增多個目標] 以建立路徑型規則 ** 。 您將建立兩個規則。

    **規則 - 路由至映射後端**

    | 設定 | 值 |
    | --- | --- |
    | 路徑 | `images/*` |
    | 目標名稱 | `images` |
    | 後端設定 | **appgw-settings** |
    | 後端目標 | `az104-appgw-images` |

    **規則 - 路由至影片後端**

    | 設定 | 值 |
    | --- | --- |
    | 路徑 | `video/*` |
    | 目標名稱 | `videos` |
    | 後端設定 | **appgw-settings** |
    | 後端目標 | `az104-appgw-videos` |

1. 選取 ** [新增 ** 兩次]，然後選取 ** [下一步：標籤> ** ]。

1. 選取 [ ** 下一步：檢閱 + 建立> ** ，然後按一下 [ ** 建立 ** ]。

    > **注意**：等候應用程式閘道執行個體建立完成。 這大約需要 5-10 分鐘的時間。

1. 在Azure 入口網站中，搜尋並選取 ** az104-appgw ** 。

1. 在應用程式閘道選取 [ ** 後端健康情況 ** ]。 ** **

1. 請確定後端集區中的兩部伺服器都顯示狀況 ** 良好 ** 。 

1. 在 ** [az104-appgw ** 應用程式閘道] 刀鋒視窗上，複製 Frontend 公用 IP 位址 ** 的值 ** 。

1. 啟動另一個瀏覽器視窗並測試 URL - `http://<frontend ip address>/image/` 。

1. 確認您已導向至映射伺服器 （vm1）。 

1. 啟動另一個瀏覽器視窗並測試 URL - `http://<frontend ip address>/video/` 。

1. 確認您已導向至映射伺服器 （vm2）。 

> **注意**：您可能需要多次重新整理，或在 InPrivate 模式中開啟新的瀏覽器視窗。

## 重要心得

恭喜您完成實驗室。 以下是此實驗室的主要外賣。 

+ Azure Load Balancer 是將網路流量分散到傳輸層 （OSI 第 4 層 - TCP 和 UDP） 的多個虛擬機器的絕佳選擇。
+ 公用 Load Balancer 可用來將網際網路流量負載平衡到您的 VM。 只有在前端需要私人 IP 時，才會使用內部 (或私人) 負載平衡器。
+ 基本負載平衡器適用于不需要高可用性或備援的小型應用程式。 標準負載平衡器適用于高效能和超低延遲。
+ Azure 應用程式閘道是網路流量 (OSI 第 7 層) 負載平衡器，可讓您管理 Web 應用程式的流量。 
+ 應用程式閘道可以根據 HTTP 要求的其他屬性做出路由決策，例如 URI 路徑或主機標頭。 

## 清除您的資源

如果您使用自己的訂用帳戶，需要一分鐘的時間才能刪除實驗室資源。 這可確保資源可以釋出，並將成本降到最低。 刪除實驗室資源最簡單的方式是刪除實驗室資源群組。 

+ 在Azure 入口網站中，選取資源群組、選取 ** [刪除資源群組 ** ]、 ** 輸入資源組名 ** ，然後按一下 [ ** 刪除 ** ]。

+ 使用 Azure PowerShell， `Remove-AzResourceGroup -Name resourceGroupName` 。

+ 使用 CLI， `az group delete --name resourceGroupName` 。
