---
lab:
  title: 實驗室 02b：透過 Azure 原則 管理控管
  module: Administer Governance and Compliance
---

# 實驗 02b - 透過 Azure 原則管理治理

## 實驗室簡介

在此實驗室中，您將瞭解如何實作組織的治理計劃。 您瞭解 Azure 原則如何確保整個組織強制執行作業決策。 您將瞭解如何使用資源標記來改善報告。 

此實驗室需要 Azure 訂用帳戶。 您的訂用帳戶類型可能會影響此實驗室中功能的可用性。 您可以變更區域，但步驟是使用 **美國**東部撰寫。 

## 預估時間：30 分鐘

## 實驗案例

您組織的雲端使用量在過去一年裡已大幅成長。 在最近的稽核期間，您已探索到大量沒有已定義擁有者、專案或成本中心的資源。 為了改善組織中 Azure 資源的管理，您決定實作下列功能：

- 套用資源標籤以將重要的元數據附加至 Azure 資源

- 使用 Azure 原則強制使用新資源的資源標籤

- 使用資源標籤更新現有的資源

## 互動式實驗室模擬

您可能會發現數個互動式實驗室模擬適合本主題。 模擬可讓您以自己的步調點選類似的案例。 互動式模擬和此實驗室之間有差異，但許多核心概念都相同。 不需要 Azure 訂用帳戶。 

+ [建立 Azure 原則](https://mslearn.cloudguides.com/en-us/guides/AZ-900%20Exam%20Guide%20-%20Azure%20Fundamentals%20Exercise%2017)。 建立可限制位置資源的 Azure 原則。 建立新的資源，並確保強制執行原則。 

+ [透過 Azure 原則](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%203)管理治理。 透過 Azure 入口網站 建立和指派標籤。 建立需要標記的 Azure 原則。 補救不符合規範的資源。

## 架構圖

![工作架構的圖表。](../media/az104-lab02b-architecture-diagram.png)

## 工作

+ 工作 1：透過 Azure 入口網站建立和指派標籤。
+ 工作 2：透過 Azure 原則 強制執行標記。
+ 工作3：透過 Azure 原則套用標記。

## 工作 1：透過 Azure 入口網站指派標籤

在此工作中，您將透過 Azure 入口網站建立標籤，並將其指派給 Azure 資源群組。 卷標是治理策略的重要元件，如 Microsoft Well-Architected Framework 和 雲端採用架構 所述。 卷標可讓您快速識別資源擁有者、日落日期、群組聯繫人，以及貴組織認為重要的其他名稱/值組。 針對這項工作，您會指派一個標記，以識別資源角色 （'Infra' for 'Infrastructure'）。

1. 登入 **Azure 入口網站** - `https://portal.azure.com`。
      
1. 搜尋並選取 `Resource groups`。

1. 從 [資源群組] 中，選取 [ **+ 建立**]。

1. 提供名稱 `az104-rg2b` ，並確定 [區域] 設定 **為 [美國**東部]。

1. 選取 [檢閱 + 建立]，然後選取 [建立]。

1. 部署資源群組之後，請選取 **[移至資源群組**]，或流覽至新建立的資源群組。

1. 在 [資源群組] 刀鋒視窗上，按一下左側功能表中的 [標記]，然後建立新的標記。

1. 使用下列設定建立標籤。

    | 設定 | 值 |
    | --- | --- |
    | 名稱 | `Role` |
    | 值 | `Infra` |

1. 按一下 **套用**。 您現在已手動將標籤新增至資源群組。 

    ![建立標籤面的螢幕快照。](../media/az104-lab02b-manualtag.png)

## 工作 2：透過 Azure 原則 強制執行標記

在這項工作中，您會將內建的*需要標籤及其資源值*原則指派給資源群組，並評估結果。 Azure 原則 可用來對 Azure 資源強制執行設定，在此案例中為治理。 

1. 在 Azure 入口網站 中，搜尋並選取 `Policy`。 

1. 在 [撰寫] 區段中，按一下 [定義]。 請花點時間流覽可供您使用的 [內建原則定義](https://learn.microsoft.com/azure/governance/policy/samples/built-in-policies) 清單。 請注意，您也可以搜尋定義。

    ![原則定義的螢幕快照。](../media/az104-lab02b-policytags.png)

1. 按一下代表**需要標籤及其資源值**內建原則的項目，並檢閱其定義。

1. 在 [需要標籤及其資源值] 內建原則定義刀鋒視窗的值上，按一下 [指派]。

1. 按一下省略號按鈕並選取下列值來指定 [範圍]：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | *訂用帳戶* |
    | 資源群組 | **az-rg2b** |

    >**注意**：範圍會決定原則指派生效的資源或資源群組。 您可以在管理群組、訂用帳戶或資源群組層級上指派原則。 您也可以選擇指定排除專案，例如個別訂用帳戶、資源群組或資源 (視指派範圍而定)。

1. 藉由指定下列設定來設定指派的**基本**屬性 (讓其他設定保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 指派名稱 | `Require Cost Center tag with Default value`|
    | 描述 | `Require Cost Center tag with default value for all resources in the resource group`|
    | 強制執行原則 | 啟用 |

    >**注意**：[指派名稱] 會自動填入您選取的原則名稱，但您可加以變更。 [ **描述** ] 是選擇性的。 **指派者** 會自動填入建立指派的用戶名稱。 

1. 按兩下 [下一步]，並將 [參數] 設定為下列值：

    | 設定 | 值 |
    | --- | --- |
    | 標記名稱 | `Cost Center` |
    | 標記值 | `Default` |

1. 按一下 [下一步]，然後檢閱 [補救] 索引標籤。保留 [建立受控識別] 核取方塊取消勾選。 

1. 按一下 [檢閱 + 建立]，然後按一下 [建立]。

    >**注意**：現在，您會嘗試在資源群組中建立 Azure 儲存體 帳戶，確認新的原則指派生效。 您將建立記憶體帳戶，而不需要新增必要的標籤。 
    
    >**注意**：原則可能需要 5 到 10 分鐘才會生效。

1. 在入口網站中，搜尋並選取 `Storage Account`，然後選取 [ **+ 建立**]。 

1. 在 [**建立記憶體帳戶 **] 刀鋒視窗的 **[基本]** 索引卷標上，確認您使用資源群組套用原則並指定下列設定（讓其他人保留預設值），按兩下 **[檢**閱]，然後按兩下 [**建立**]：

    | 設定 | 值 |
    | --- | --- |
    | 資源群組 | **az104-rg2b** |
    | 儲存體帳戶名稱 | *任何介於 3 到 24 個小寫字母和數位之間的全域唯一組合，從字母開始* |

    >**注意**：您可能會收到 **驗證失敗。按兩下這裡以取得詳細** 數據錯誤。 如果是，請按兩下一個步驟。 

1. 建立部署之後，您應該會在入口網站的 [通知] 清單中看到**部署失敗**訊息。 從 [通知] 清單中，瀏覽到部署概觀，然後按一下 [部署失敗。**按一下此處獲得詳細資料]** 訊息，以識別失敗原因。 

    ![不允許的原則錯誤的螢幕快照。](../media/az104-lab02b-policyerror.png) 

    >**注意**：確認錯誤訊息指出原則是否不允許資源部署。 

    >**注意**：按兩下 [ **原始錯誤]** 索引標籤，您可以找到錯誤的詳細資料，包括具有預設值的角色定義 **[需要成本中心] 標籤**的名稱。 部署失敗，因為您嘗試建立的記憶體帳戶沒有名為 **Cost Center** 的標籤，其值設定為 **預設值**。

## 工作 3：透過 Azure 原則套用標籤

在此工作中，我們將使用新的原則定義來補救任何不符合規範的資源。 這會使用補救工作作為原則的一部分，修改現有的資源以符合原則規範。 在此案例中，我們會讓資源群組的任何子資源繼承 **資源群組上定義的 Role** 卷標。

1. 在 Azure 入口網站 中，搜尋並選取 `Policy`。 

1. 在 [撰寫] 區段中，按一下 [指派]。 

1. 在工作分派清單中，按兩下資料列中的省略號圖示，代表 **具有預設值原則** 指派的 [需要成本中心] 標籤，並使用 **[刪除指派** ] 選單項來刪除指派。

1. 按一下 [指派原則]，然後按一下省略號按鈕並選取下列值來指定 [範圍]：

    | 設定 | 值 |
    | --- | --- |
    | 訂用帳戶 | 您要在此實驗室中使用的 Azure 訂用帳戶名稱 |
    | 資源群組 | 資源群組的名稱，其中包含您在第一個工作中識別的 Cloud Shell 帳戶 |

    ![原則範圍頁面的螢幕快照。 ](../media/az104-lab02b-policyscope2.png) 

1. 若要指定原則 **定義**，請按下省略號按鈕，然後搜尋並選取 `Inherit a tag from the resource group if missing`。

1. 藉由指定下列設定來設定指派的剩餘**基本**屬性 (讓其他設定保留預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 指派名稱 | **如果遺失，請從資源群組繼承 Role 標籤及其 Infra 值**|
    | 描述 | **如果遺失，請從資源群組繼承 Role 標籤及其 Infra 值**|
    | 強制執行原則 | 啟用 |

1. 按兩下 [下一步]，並將 [參數] 設定為下列值：

    | 設定 | 值 |
    | --- | --- |
    | 標記名稱 | `Role` |

1. 按一下 [下一步]，然後在 [補救] 索引標籤上，設定下列設定 (保留其他項目為預設值)：

    | 設定 | 值 |
    | --- | --- |
    | 建立補救工作 | 已啟用 |
    | 要補救的原則 | **從資源群組繼承標籤 (若遺漏)** |

    >**注意**：此原則定義包含 **Modify** 效果。

    ![原則補救頁面的螢幕快照。 ](../media/az104-lab02b-policyremediation.png) 

1. 按一下 [檢閱 + 建立]，然後按一下 [建立]。

    >**注意**：若要確認新的原則指派生效，您會在相同的資源群組中建立另一個 Azure 儲存器帳戶，而不需明確新增必要的卷標。 
    
    >**注意**：原則可能需要 5 到 15 分鐘才會生效。

1. 流覽回您在第一個工作中建立之資源群組的刀鋒視窗。

1. 在資源群組刀鋒視窗中，按一下 [+ 建立]，然後搜尋**儲存體帳戶**，然後按一下 [+ 建立]。 

1. 在 [建立儲存體帳戶] 刀鋒視窗的 [基本] 索引標籤上，確認您使用的是已套用原則的資源群組，並指定下列設定 (讓其他設定保留預設值)，然後按一下 [檢閱]：

    | 設定 | 值 |
    | --- | --- |
    | 儲存體帳戶名稱 | *任何介於 3 到 24 個小寫字母和數位之間的全域唯一組合，從字母開始* |

1. 請確認這次通過驗證，然後按一下 [建立]。

1. 布建新的記憶體帳戶之後，請按兩下 **[移至資源**]。

1. 在 [概**觀]** 刀鋒視窗上，請注意，具有 Infra** 值的角色**標籤**** 已自動指派給資源。

## 重要心得

恭喜您完成實驗室。 以下是此實驗室的主要外賣。 

+ Azure 標籤是包含索引鍵/值組的元數據。 標籤會描述您環境中的特定資源。 特別是，在 Azure 中標記可讓您在邏輯環境中標記資源。
+ Azure 原則可建立資源的慣例。 原則定義會描述資源合規性條件，以及符合條件時所要採取的效果。 條件會與必要值比較資源屬性欄位或值。 有許多內建原則定義。
+ Azure 原則 補救工作功能可用來根據定義和指派，將資源帶入合規性。 不符合修改或 deployIfNotExist 定義指派規範的資源，可以使用補救工作進入合規性。

## 清除您的資源

如果您使用自己的訂用帳戶，需要一分鐘的時間才能刪除實驗室資源。 這可確保資源可以釋出，並將成本降到最低。 刪除實驗室資源最簡單的方式是刪除實驗室資源群組。 

+ 在 Azure 入口網站 中，選取資源群組、選取 **[刪除資源群組**]、**輸入資源組名**，然後按兩下 [**刪除**]。
+ 使用 Azure PowerShell， `Remove-AzResourceGroup -Name resourceGroupName`。
+ 使用 CLI， `az group delete --name resourceGroupName`。
