---
lab:
  title: 實驗室 11：實作監視
  module: Administer Monitoring
---

# 實驗 11 - 實作監視

## 實驗室簡介

在此實驗室中，您將瞭解 Azure 監視器。 您將瞭解如何建立要傳送至動作群組的警示。 您可以觸發警示並檢查活動記錄。  

此實驗室需要 Azure 訂用帳戶。 您的訂用帳戶類型可能會影響此實驗室中功能的可用性。 您可以變更區域，但步驟是使用美國東部撰寫。

## 預估時間：40 分鐘

## 實驗案例

您的組織已將其基礎結構移轉至 Azure。 請務必管理員管理員收到任何重大基礎結構變更的通知。 您計畫檢查 Azure 監視器的功能，包括 Log Analytics。

## 互動式實驗室模擬

有一個互動式實驗室模擬，您可能會發現這個主題很有用。 模擬可讓您以自己的步調點選類似的案例。 互動式模擬和此實驗室之間有差異，但許多核心概念都相同。 不需要 Azure 訂用帳戶。

+ [實作監視 ](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2017) 。 建立 Log Analytics 工作區和 Azure 自動化解決方案。 檢閱虛擬機器的監視和診斷設定。 檢閱 Azure 監視器和 Log Analytics 功能。 

## 架構圖

![架構工作的圖表](../media/az104-lab11-architecture-diagram.png)

## 工作

+ 工作 1：佈建實驗室環境。
+ 工作 2：建立 Azure 活動記錄警示。
+ 工作 3：觸發警示。
+ 工作 4：新增警示規則。
+ 工作 5：使用 Azure 監視器記錄查詢。

## 工作 1：佈建實驗室環境

在此工作中，您將部署虛擬機器以用於測試監視案例。

1. 如有必要，請將 Allfiles Labs 11 az104-11-vm-template.json ** 和 \\ ** Allfiles \\ Labs \\ 11 \\ az104-11-vm-parameters.json ** 實驗室檔案下載 ** \\ 到您的電腦。 \\ \\ \\

1. 登入 **Azure 入口網站** - `https://portal.azure.com`。

1. 從Azure 入口網站搜尋並選取 `Deploy a custom template` 。

1. 在自訂部署頁面上，選取 ** [在編輯器 ** 中建置您自己的範本]。

1. 在編輯範本頁面上，選取 ** [載入檔案 ** ]。

1. 找出並選取 ** \\ Allfiles \\ Labs \\ 11 \\ az104-11-vm-template.json ** 檔案，然後選取 [ ** 開啟 ** ]。

1. 選取 [儲存]。

1. 在自訂部署頁面上，選取 [ ** 編輯參數 ** ]。

1. 在 [編輯參數] 頁面上，選取 ** [載入檔案 ** ]。 找出並選取 ** \\ Allfiles \\ Labs \\ 11 \\ az104-11-vm-parameters.json ** 檔案，然後選取 [ ** 開啟 ** ]。

1. 選取 [儲存]。

1. 使用下列資訊來完成自訂部署欄位，讓所有其他欄位都保留預設值：

    | 設定       | 值         | 
    | ---           | ---           |
    | 訂用帳戶  | 您的 Azure 訂用帳戶 |
    | 資源群組| `az104-rg11`（如有必要，請選取 **** 新建）
    | 區域        | **美國東部**   |
    | 使用者名稱      | `Student`   |
    | 密碼      | 提供複雜密碼 |
    
1. 選取 **[檢閱 + 建立]**,然後選取 **[建立]**。

1. 等候部署完成，然後按一下 ** [移至資源群組 ** ]。

1. 檢閱哪些資源已部署，包括虛擬機器和虛擬網路。

    >**注意： ** 稍後在實驗室中，我們將使用 Azure 監視器，因此需要一分鐘的時間才能安裝虛擬機器代理程式

1. 在入口網站中，搜尋並選取 [ ** 監視 ** ]。

1. 花一分鐘的時間檢閱所有可用的深入解析、偵測、分級和診斷工具。

1. 選取 ** [VM 深入解析檢視 ** ]，然後選取 [ ** 設定深入解析 ** ]。

1. 選取您的虛擬機器，然後 ** 選取 [啟用 ** ] （兩次）。

1. 代理程式需要幾分鐘的時間才能安裝和設定，請繼續進行下一個步驟。 
   
## 工作 2：建立 Azure 活動記錄警示

1. 在Azure 入口網站搜尋並選取 [ ** 監視 ** ]。 

1. 在 [監視] 功能表中，選取 [警示]****。 

1. 選取 [ ** 建立 + ** ]，然後選取 [ ** 警示規則 ** ]。 [建立警示規則]**** 窗格隨即出現，同時 [範圍]**** 區段會開啟，且 [選取資源]**** 窗格也會在右側開啟。

1. 在 [ ** 選取資源 ** ] 窗格中， ** 應該已經填入 [依訂用帳戶 ** 篩選] 欄位。 在 [依資源類型篩選]**** 下拉式清單中，搜尋並選取 [虛擬機器]****。

1. 您希望資源群組中的任何虛擬機器在刪除時發出警示。 選取 az104-rg11 資源群組的 ** 方塊，然後選取 [ ** 套用 ** ]。 **

1. 選取 [條件] ** 索引 ** 標籤，然後選取 ** [查看所有訊號 ** ] 連結。

1. 搜尋並選取 [ ** 刪除虛擬機器] [虛擬機器]。 ** 選取 [套用]

1. 您想要收到所有類型的警示，因此請將 [警示邏輯]**** 設定保留為 [所有選取的項目]**** 的預設值。 將 [建立警示規則]**** 窗格保持開啟，以在下一節中使用。

## 工作 3：新增電子郵件警示動作

針對先前的 Azure 監視器警示，您未新增任何動作。 您剛剛在 Azure 入口網站中檢視觸發的警示。 動作可讓您傳送電子郵件通知、觸發 Azure 函式或呼叫 Webhook。 在此練習中，我們會在刪除 VM 時新增電子郵件警示。

1. 在 [建立警示規則] 窗格中，選取 [下一個: 動作] 按鈕，然後選取 [建立動作群組]。 

1. 在 [基本]**** 索引標籤上，為每個設定輸入下列值。

    | 設定 | 值 |
    |---------|---------|
    | **專案詳細資料** |
    | 訂用帳戶 | 訂用帳戶 |
    | 資源群組 | **az104-rg11** |
    | 區域 | **全域** (預設值) |
    | [執行個體詳細資料]**** |
    | 動作群組名稱 | **警示作業小組** |
    | 顯示名稱 | **AlertOpsTeam** |

1. 選取 [ ** 下一步：通知 ** ]，並為每個設定輸入下列值。

    | 設定 | 值 |
    |---------|---------|
    | 通知類型 | 選取 [電子郵件/簡訊/推播/語音]**** |
    | 名稱 | **VM 已刪除** |

1. 選取 [電子郵件]****，然後在 [電子郵件]**** 方塊中輸入您的電子郵件地址，然後選取 [確定]****。 

1. 選取 [檢閱 + 建立]**** 以驗證您的輸入。

1. 選取 **建立**。
 
1. [建立警示規則]**** 窗格隨即重新出現。 選取 [下一個: 詳細資料] 按鈕，然後為每個設定輸入下列值。

    | 設定 | 值 |
    |---------|---------|
    | 警示規則名稱 | **VM 已刪除** |
    | 描述 | **您資源群組中的 VM 已刪除** |

1. 展開 **[進階選項]** 區段，並確認已選取 **[建立時啟用警示規則]**。

1. 選取 [檢閱 + 建立]**** 來驗證您的輸入，然後選取 [建立]****。

    >**注意： ** 新增至已設定動作群組 （作業小組） 的收件者會收到通知：

    - 將他們新增至動作群組時
    - 啟用警示時
    - 觸發警示時

## 工作 4：觸發警示

若要觸發警示，請刪除資源群組中的虛擬機器。

>**注意： ** 活動記錄警示規則最多可能需要五分鐘的時間才會變成作用中。 在此練習中，如果您在此規則部署之前，刪除虛擬機器，則警示規則可能不會觸發。 

1. 在 Azure 入口網站功能表上，或從 [首頁]**** 頁面，選取 [虛擬機器]****。

1. 核取 az104-vm0 ** 虛擬機器的 ** 方塊。

1. 從功能表列中選取 [刪除]****。

1. 在 [確認刪除]**** 欄位中輸入 "yes"，然後選取 [刪除]****。

1. 在標題列中，選取 [通知]**** 圖示，並等候系統成功刪除 [vm1]****。

1. 您應該會收到標題為「重要通知：已啟動 Azure 監視器警示 VM 已刪除...」**** 的通知電子郵件。如果未收到，請開啟您的電子郵件程式並尋找來自 azure-noreply@microsoft.com 的電子郵件。

    ![警示電子郵件的螢幕擷取畫面。](../media/az104-lab11-alert-email.png)

1. 在 Azure 入口網站資源功能表上，選取 **[監視]**，然後選取左側功能表中的 **[警示]**。

1. 您應該會有因刪除 [vm1] 而產生的三個詳細資訊警示。

1. 選取其中一個警示的名稱 (例如，[VM 已刪除]****)。 [警示詳細資料]**** 窗格隨即出現，顯示關於事件的詳細資料。

## 工作 5：新增警示規則

我們將排程一次性、整夜、計劃性維護。 維護會在晚上開始並持續到隔天早上。

1. 在 [Azure 入口網站資源] 功能表中，選取 **[監視]**、選取左側功能表中的 **[警示]**，然後在功能表列中選取 **[警示處理規則]**。
   
1. 選取 **+ 建立**。
   
1. 勾選沙箱資源群組的核取方塊，作為警示處理規則的範圍，然後選取 **[套用]**。
   
1. 選取 **[下一步: 規則設定]**，選取 **[隱藏通知]**。
   
1. 選取 [下一步：排程]****。
   
1. 根據預設，除非停用規則，否則規則會一直運作。 我們將定義規則來隱藏一次性整夜計劃性維護的通知。
針對警示處理規則的排程輸入這些設定：

    | 設定 | 值 |
    |---------|---------|
    |套用規則 |在特定時間|
    |開始|在下午 10 點輸入今天的日期。|
    |結束|在上午 7 點輸入明天的日期。|
    |Time zone|選取當地時區。|

    ![警示處理規則排程區段的螢幕擷取畫面](../media/az104-lab11-alert-processing-rule-schedule.png)

1. 選取 **[下一步: 詳細資料]**，然後輸入下列設定:

    | 設定 | 值 |
    |---------|---------|
    |資源群組 |選取您的沙箱資源群組。 |
    |規則名稱|**計劃性維護**|
    |描述|**在計劃性維護期間隱藏通知。**|

1. 選取 [檢閱 + 建立]**** 來驗證您的輸入，然後選取 [建立]****。

## 工作 6：使用 Azure 監視器記錄查詢

在這項工作中，您將使用 Azure 監視器來查詢從虛擬機器擷取的資料。

1. 在Azure 入口網站中，搜尋並選取 `Monitor` 刀鋒視窗，按一下 [ ** 記錄 ** ]。

    >**注意**：如果這是您第一次存取 Log Analytics，則可能需要按一下 [開始使用]。 如果您仍然看到 [啟用 ** ] ** 按鈕，請等候先前的部署完成。

1. 如有必要，請按一下 [ ** 選取範圍]，在 [選取範圍 ** ** ] 刀鋒視窗上 ** ，展開您的訂用帳戶，展開資源群組 ** az104-rg1 ** ，然後選取 ** az104-vm0 ** ，然後按一下 [ ** 套用 ** ]。

1. 在查詢視窗中，貼上下列查詢，按一下 [執行]，然後檢閱產生的圖表：

   ```sh
   // Virtual Machine available memory
   // Chart the VM's available memory over the last hour.
   InsightsMetrics
   | where TimeGenerated > ago(1h)
   | where Name == "AvailableMB"
   | project TimeGenerated, Name, Val
   | render timechart
   ```

    > **注意**：查詢不應該有任何錯誤 (由右捲軸上的紅色區塊指示)。 如果查詢不會貼上而不會發生錯誤，請將查詢程式碼貼到文字編輯器中，例如記事本，然後從該處複製並貼到查詢視窗中。


1. 按一下 ** 工具列中的 [查詢 ** ] 

    >**注意 ** ：視螢幕解析度而定， ** 查詢 ** 可能會隱藏在省略號後面。

1. 清除任何現有的篩選。 使用查詢搜尋，搜尋 `Track VM Availability using Heartbeat` ，然後選取 [ ** 執行 ** ]。

1. 選取查詢的 [ ** 結果] ** 索引標籤，然後檢閱查詢的結果。

## 檢閱實驗室的要點

恭喜您完成實驗室。 以下是此實驗室的主要外賣。 

+ 警示可協助您在使用者注意到基礎結構或應用程式發生問題之前偵測並解決問題。

+ 您可以針對在 Azure 監視器資料平台中的任何計量或記錄資料來源發出警示。

+ 警示規則會監視您的資料，並擷取指出指定資源發生狀況的訊號。

+ 如果符合警示規則的條件，就會觸發警示。 您可以起始數個動作（電子郵件、簡訊、推播、語音），並傳送至動作群組。 

## 清除您的資源

如果您使用自己的訂用帳戶，需要一分鐘的時間才能刪除實驗室資源。 這可確保資源可以釋出，並將成本降到最低。 刪除實驗室資源最簡單的方式是刪除實驗室資源群組。 

+ 在Azure 入口網站中，選取資源群組、選取 ** [刪除資源群組 ** ]、 ** 輸入資源組名 ** ，然後按一下 [ ** 刪除 ** ]。

+ 使用 Azure PowerShell， `Remove-AzResourceGroup -Name resourceGroupName` 。

+ 使用 CLI， `az group delete --name resourceGroupName` 。

