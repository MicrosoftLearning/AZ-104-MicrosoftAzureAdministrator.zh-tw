---
lab:
  title: 實驗室05：實作現場 連線
  module: Administer Intersite Connectivity
---

# 實驗 05 - 實作站台間連線能力

## 實驗室簡介

在此實驗室中，您將探索虛擬網路之間的通訊。 您將實作虛擬網路對等互連，並執行遠端命令來測試連線。   

此實驗室需要 Azure 訂用帳戶。 您的訂用帳戶類型可能會影響此實驗室中功能的可用性。 您可以變更區域，但步驟是使用 **美國**東部撰寫。 

## 估計時間：40 分鐘

## 實驗案例 

您的組織會將核心 IT 應用程式和服務（例如 DNS 和安全性服務）與業務的其他部分區隔，包括您的製造部門。 不過，在某些案例中，核心區域中的應用程式和服務需要與製造區域中的應用程式和服務通訊。 在此實驗室中，您會設定區隔區域之間的連線。 這是將生產與開發分離，或將某個子公司與另一個子公司分開的常見案例。

## 互動式實驗室模擬

您可能會發現數個互動式實驗室模擬適合本主題。 模擬可讓您以自己的步調點選類似的案例。 互動式模擬和此實驗室之間有差異，但許多核心概念都相同。 不需要 Azure 訂用帳戶。 

+ [連線 兩個使用全域虛擬網路對等互連](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Connect%20two%20Azure%20virtual%20networks%20using%20global%20virtual%20network%20peering)的 Azure 虛擬網路。 測試不同虛擬網路中兩部虛擬機之間的連線。 建立虛擬網路對等互連並重新測試。
+ [實作月臺間連線](https://mslabs.cloudguides.com/en-us/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%209)。 執行範本以建立具有數部虛擬機的虛擬網路基礎結構。 設定虛擬網路對等互連並測試連線。 

## 架構圖

![實驗室 05 架構圖表](../media/az104-lab05-architecture-diagram.png)

## 工作

+ 工作 1：建立核心服務虛擬機和虛擬網路。
+ 工作 2：建立製造服務虛擬機和虛擬網路。
+ 工作 3：測試虛擬機之間的連線。 
+ 工作 4：在虛擬網路之間建立 VNet 對等互連。 
+ 工作5：重新測試虛擬機之間的連線。 
 

## 工作 1：建立核心服務虛擬機和虛擬網路

在這項工作中，我們會使用虛擬機建立核心服務虛擬網路。 

1. 登入 **Azure 入口網站** - `https://portal.azure.com`。

1. 搜尋並選取 `Virtual Machines`。

1. 從 [虛擬機] 頁面中，選取 [ **建立** ]，然後選取 **[Azure 虛擬機**]。

1. 在 [基本] 索引卷標上，使用下列資訊來完成窗體，然後選取 **[下一步：磁碟>**。 針對未指定的任何設定，保留預設值。
 
    | 設定 | 值 | 
    | --- | --- |
    | 訂用帳戶 |  *訂用帳戶* |
    | 資源群組 |  `az104-rg5`（如有必要，請選取**** 新建。 將此群組用於所有實驗室資源。
    | 虛擬機器名稱 |    `CoreServicesVM` |
    | 區域 | **美國東部** |
    | 可用性選項 | 不需要基礎結構備援 |
    | 映像 | **Windows Server 2019 Datacenter：x64 Gen2** |
    | 大小 | **Standard_DS2_v3** |
    | 使用者名稱 | `localadmin` | 
    | 密碼 | **提供複雜密碼** |

    ![基本虛擬機建立頁面的螢幕快照。 ](../media/az104-lab05-createcorevm.png)
   
1. 在 [磁碟] 索引標籤上，將 OS 磁碟類型設定為 **標準 HDD**，然後選取 **[下一步：網络>**。

1. 在 [網络] 索引標籤上，針對 [虛擬網络]，選取 [ **新建**]。

1. 使用下列資訊來設定虛擬網路，然後選取 [ **確定**]。 如有必要，請移除或取代現有的位址範圍。

    | 設定 | 值 | 
    | --- | --- |
    | 名稱 | `CoreServicesVNet` （新增） |
    | 位址空間 | `10.0.0.0/16`  |
    | 子網路名稱 | `Core` | 
    | 子網路位址範圍 | `10.0.0.0/24` |

1. 選取 [ **監視]** 索引標籤。針對 [開機診斷]，選取 [ **停用**]。

1. 選取 [檢閱 + 建立]，然後選取 [建立]。

1. 您不需要等候資源建立。 繼續進行下一個工作。

    >**注意：** 您在建立虛擬機時，是否注意到此工作中已建立虛擬網路？ 

## 工作 2：建立製造服務虛擬機和虛擬網路

在這項工作中，我們會使用虛擬機建立製造服務虛擬網路。 

1. 從 Azure 入口網站 搜尋並流覽至 **虛擬機器**。

1. 從 [虛擬機] 頁面中，選取 [ **建立** ]，然後選取 **[Azure 虛擬機**]。

1. 在 [基本] 索引卷標上，使用下列資訊來完成窗體，然後選取 **[下一步：磁碟>**。 針對未指定的任何設定，保留預設值。
 
    | 設定 | 值 | 
    | --- | --- |
    | 訂用帳戶 |  *訂用帳戶* |
    | 資源群組 |  `az104-rg5` |
    | 虛擬機器名稱 |    `ManufacturingVM` |
    | 區域 | **美國東部** |
    | 可用性選項 | 不需要基礎結構備援 |
    | 映像 | **Windows Server 2019 Datacenter：x64 Gen2** |
    | 大小 | **Standard_DS2_v3** | 
    | 使用者名稱 | `localadmin` | 
    | 密碼 | **提供複雜密碼** |

1. 在 [磁碟] 索引標籤上，將 OS 磁碟類型設定為 **標準 HDD**，然後選取 **[下一步：網络>**。

1. 在 [網络] 索引標籤上，針對 [虛擬網络]，選取 [ **新建**]。

1. 使用下列資訊來設定虛擬網路，然後選取 [ **確定**]。  如有必要，請移除或取代現有的位址範圍。

    | 設定 | 值 | 
    | --- | --- |
    | 名稱 | `ManufacturingVNet` |
    | 位址空間 | `172.16.0.0/16`  |
    | 子網路名稱 | `Manufacturing` |
    | 子網路位址範圍 | `172.16.0.0/24` |

1. 選取 [ **監視]** 索引標籤。針對 [開機診斷]，選取 [ **停用**]。

1. 選取 [檢閱 + 建立]，然後選取 [建立]。

## 工作 3：測試虛擬機之間的連線

在這項工作中，您會測試不同虛擬網路中虛擬機之間的連線。 在繼續之前，請確定已部署並執行這兩部虛擬機。 

### 確認 CoreServicesVM 的私人 IP 位址

1. 從 Azure 入口網站 搜尋並選取`CoreServicesVM`虛擬機。

1. 在 [概觀]** 刀鋒視窗的 **[** 網络**] 區段中，記錄**機器的私人IP位址**。 您需要此資訊來測試連線。
   
### 從 ManufacturingVM 測試 CoreServicesVM** 的**連線。

1. 切換至 `ManufacturingVM` 虛擬機。

1. 在 [作業]** 區**段中，選取 [**執行命令**] 刀鋒視窗。

1. 選取 **[RunPowerShellScript**]，然後執行 **Test-Net 連線 ion** 命令。 請務必使用 CoreServicesVM** 的私人 **IP 位址。

   ```Powershell
    Test-NetConnection <CoreServicesVM private IP address> -port 3389
   ```
   
1. 腳本可能需要幾分鐘的時間才能執行。 頁面頂端會顯示資訊訊息 *腳本執行進行中。*
   
1. 測試連線應該會失敗。 根據預設，不同虛擬網路中的虛擬機應該無法通訊。
   
   ![Test-Net 連線 ion 失敗的 PowerShell 視窗。](../media/az104-lab05-fail.png)

 
## 工作 4：在虛擬網路之間建立 VNet 對等互連

在這項工作中，您會建立虛擬網路對等互連，以啟用 VNet 之間的通訊。

1. 在 Azure 入口網站 中，選取 **[虛擬網絡]**，然後選取 **[CoreServicesVnet**]。

1. 在 CoreServicesVnet 的 [設定]**** 底下，選取 [對等互連]****。

1. 在 [CoreServicesVnet | 對等互連] 上，選取 [+ 新增]****。

1. 請使用下表中的資訊來建立對等互連。

    | **區段**                          | **選項**                                    | **值**                             |
    | ------------------------------------ | --------------------------------------------- | ------------------------------------- |
    | 此虛擬網路                 |                                               |                                       |
    |                                      | 對等互連連結名稱                             | `CoreServicesVnet-to-ManufacturingVnet` |
    |                                      | 允許 CoreServicesVNet 存取對等互連的虛擬網路            | selected （default）                       |
    |                                      | 允許 CoreServicesVNet 接收來自對等互連虛擬網路的轉送流量 | 已選取                       |
    |                                      | 允許 CoreServicesVNet 中的閘道將流量轉送至對等互連虛擬網路 | 未選擇 （預設值） |
    |                                      | 啟用 CoreServicesVNet 以使用對等互連虛擬網路的遠端閘道       | 未選擇 （預設值）                        |
    | 遠端虛擬網路               |                                               |                                       |
    |                                      | 對等互連連結名稱                             | `ManufacturingVnet-to-CoreServicesVnet` |
    |                                      | 虛擬網路部署模型              | **資源管理員**                      |
    |                                      | 我知道我的資源識別碼                         | 未選取                          |
    |                                      | 訂用帳戶                                  | *訂用帳戶*    |
    |                                      | 虛擬網路                               | **ManufacturingVnet**                     |
    |                                      | 允許 ManufacturingVNet 存取 CoreServicesVNet  | selected （default）                       |
    |                                      | 允許 ManufacturingVNet 從 CoreServicesVNet 接收轉送流量 | 已選取                        |
   |                                      | 允許 CoreServicesVNet 中的閘道將流量轉送至對等互連虛擬網路 | 未選擇 （預設值） |
    |                                      | 啟用 ManufacturingVNet 以使用 CoreServicesVNet 的遠端網關       | 未選擇 （預設值）                        |

1. 檢閱您的設定，然後選取 [ **新增**]。

    ![對等互連頁面的螢幕快照。](../media/az104-lab05-peering.png)
 
1. 在 [CoreServicesVnet | 對等互連] 上，確認已列出 [CoreServicesVnet-to-ManufacturingVnet]**** 對等互連。 重新整理頁面，以確保**已 連線** 對等互連狀態****。

1. 切換至 **ManufacturingVnet** ，並確認 **已列出 ManufacturingVnet 對 CoreServicesVnet** 對等互連。 確定已 **連線 對等互連狀態****。** 您可能需要**重新整理**頁面。 

 
## 工作 5：測試 VM 之間的連線

在這項工作中，您會確認不同虛擬網路中的虛擬機可以彼此通訊。

1. 搜尋並選取 **ManufacturingVM**。

1. 在 [作業]** 區**段中，選取 [**執行命令**] 刀鋒視窗。

1. 選取 **[RunPowerShellScript**]，然後新增 Test-Net 連線 ion 命令。 請務必使用 CoreServicesVM** 的私人 **IP 位址。

      ```Powershell
     Test-NetConnection <CoreServicesVM private IP address> -port 3389
      ```

1. 腳本可能需要幾分鐘的時間才能執行。 頁面頂端會顯示信息圖示 *腳本執行進行中。*
    
1. 測試連線應該會成功。 
   ![Test-Net 連線 ion 成功的 Powershell 視窗](../media/az104-lab05-success.png)


## 檢閱實驗室的要點

恭喜您完成實驗室。 以下是此實驗室的主要外賣。 

+ 根據預設，不同虛擬網路中的資源無法通訊。
+ 虛擬網路對等互連可讓您順暢地連線 Azure 中的兩個或更多虛擬網路。
+ 對等互連的虛擬網路會以連線目的顯示為其中一個。
+ 對等互連虛擬網路中的虛擬機之間的流量會使用 Microsoft 骨幹基礎結構。

## 清除您的資源

如果您使用自己的訂用帳戶，需要一分鐘的時間才能刪除實驗室資源。 這可確保資源可以釋出，並將成本降到最低。 刪除實驗室資源最簡單的方式是刪除實驗室資源群組。 

+ 在 Azure 入口網站 中，選取資源群組、選取 **[刪除資源群組**]、**輸入資源組名**，然後按兩下 [**刪除**]。
+ 使用 Azure PowerShell， `Remove-AzResourceGroup -Name resourceGroupName`。
+ 使用 CLI， `az group delete --name resourceGroupName`。

